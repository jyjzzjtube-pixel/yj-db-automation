<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#C0392B">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>í†µí•©DB ëª¨ë°”ì¼</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{--c:#C0392B;--c2:#E74C3C;--bg:#FAFAF8;--card:#fff;--bd:#EDEDED;--tx:#1A1A1A;--sub:#888;--lt:#F7F6F4;--safe-b:env(safe-area-inset-bottom,0px);--nav-h:60px}
html,body{height:100%;overflow:hidden}
body{font-family:-apple-system,'Pretendard','Noto Sans KR','Malgun Gothic',sans-serif;background:var(--bg);color:var(--tx);display:flex;flex-direction:column;-webkit-font-smoothing:antialiased}
@media print{body{background:#fff!important}.top,.tabs,.no-print{display:none!important}.main{padding:0!important;max-width:100%!important}}
.top{height:44px;display:flex;align-items:center;justify-content:center;background:rgba(250,250,248,.97);backdrop-filter:blur(16px);border-bottom:1px solid var(--bd);flex-shrink:0;padding:0 16px;padding-top:env(safe-area-inset-top,0px)}
.top h1{font-size:14px;font-weight:900;color:var(--c);letter-spacing:-.5px}
.tabs{display:none!important}
.nav{position:fixed;bottom:0;left:0;right:0;height:calc(var(--nav-h) + var(--safe-b));padding-bottom:var(--safe-b);background:rgba(255,255,255,.97);backdrop-filter:blur(16px);border-top:1px solid var(--bd);display:flex;z-index:100}
.nav-item{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1px;cursor:pointer;color:#bbb;position:relative;padding:6px 0}
.nav-item.on{color:var(--c)}
.nav-item i{font-size:20px;font-style:normal}
.nav-item span{font-size:8px;font-weight:700}
.nav-badge{position:absolute;top:4px;right:calc(50% - 16px);background:var(--c);color:#fff;font-size:7px;font-weight:900;width:14px;height:14px;border-radius:7px;display:flex;align-items:center;justify-content:center}
.fab{position:fixed;bottom:calc(var(--nav-h) + var(--safe-b) + 16px);right:16px;width:56px;height:56px;border-radius:28px;background:var(--c);color:#fff;border:none;font-size:28px;font-weight:300;cursor:pointer;box-shadow:0 4px 16px rgba(192,57,43,.35);z-index:99;display:flex;align-items:center;justify-content:center}
.fab:active{transform:scale(.9)}
.tab{flex:1;min-width:0;text-align:center;padding:9px 2px 7px;font-size:9px;font-weight:700;cursor:pointer;color:#bbb;border-bottom:2px solid transparent;transition:all .2s;white-space:nowrap}
.tab.on{color:var(--c);border-bottom-color:var(--c)}
.tab i{font-size:16px;display:block;margin-bottom:1px;font-style:normal}
.main{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:12px 14px calc(var(--nav-h) + var(--safe-b) + 20px);max-width:100%}
.c{background:var(--card);border-radius:14px;border:1px solid var(--bd);margin-bottom:12px;overflow:hidden}
.c-h{padding:14px 16px;font-size:13px;font-weight:800;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #f5f5f5}
.c-b{padding:14px 16px}
.inp{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #E0E0E0;font-size:13px;font-weight:500;outline:none;font-family:inherit;transition:border .2s;background:#fff}
.inp:focus{border-color:var(--c);box-shadow:0 0 0 3px rgba(192,57,43,.06)}
.ta{resize:vertical;min-height:50px;line-height:1.7}
.lbl{font-size:10px;font-weight:700;color:#999;margin-bottom:4px;display:block;letter-spacing:.3px}
.row{display:grid;gap:10px;margin-bottom:10px}
.r2{grid-template-columns:1fr 1fr}.r3{grid-template-columns:1fr 1fr 1fr}.r4{grid-template-columns:1fr 1fr 1fr 1fr}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:4px;padding:9px 16px;border-radius:10px;border:none;font-size:12px;font-weight:700;cursor:pointer;transition:all .15s;font-family:inherit}
.btn:active{transform:scale(.97)}
.bp{background:var(--c);color:#fff}.bo{background:transparent;border:1.5px solid var(--c);color:var(--c)}
.bg{background:transparent;border:1.5px solid #ccc;color:#999}.bd{background:transparent;border:1.5px solid #E53935;color:#E53935}
.bgreen{background:#2E7D32;color:#fff}
.bf{width:100%}.btn:disabled{opacity:.4;cursor:default;transform:none}
.btn-sm{padding:5px 10px;font-size:10px;border-radius:8px}
.item{padding:13px 15px;border-bottom:1px solid #f5f5f5;cursor:pointer;transition:background .1s;display:flex;gap:12px;align-items:flex-start}
.item:last-child{border-bottom:none}.item:active{background:#fafafa}
.item-no{font-size:10px;font-weight:900;color:var(--c);background:rgba(192,57,43,.06);width:28px;height:28px;border-radius:8px;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:2px}
.item-body{flex:1;min-width:0}
.item-nm{font-size:13px;font-weight:800;margin-bottom:2px}
.item-meta{font-size:11px;color:var(--sub);line-height:1.6}
.item-date{font-size:10px;color:#ccc;margin-top:2px}
.badge{font-size:9px;font-weight:800;padding:2px 7px;border-radius:5px;margin-left:6px;vertical-align:middle}
.memo{padding:10px 12px;border-radius:10px;background:var(--lt);margin-bottom:6px;border:1px solid #EDEDED;position:relative}
.memo.pinned{border-color:#FFC107;background:#FFFDE7}
.memo-t{font-size:9px;color:#bbb;margin-bottom:3px;display:flex;justify-content:space-between;align-items:center}
.memo-txt{font-size:12px;color:#444;line-height:1.6;white-space:pre-wrap}
.photos{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
.photo-thumb{width:80px;height:80px;border-radius:10px;object-fit:cover;border:1px solid #eee;cursor:pointer}
.photo-add{width:80px;height:80px;border-radius:10px;border:2px dashed #ddd;display:flex;align-items:center;justify-content:center;cursor:pointer;color:#ccc;font-size:24px}
.chips{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:10px}
.chip{padding:5px 11px;border-radius:16px;font-size:10px;font-weight:700;cursor:pointer;border:1.5px solid #E0E0E0;color:#999;background:var(--card);transition:all .15s}
.chip.on{border-color:var(--c);color:var(--c);background:rgba(192,57,43,.05)}
.kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px}
.kpi4{grid-template-columns:repeat(4,1fr)}
.kpi-card{padding:14px 8px;text-align:center;border-radius:12px;background:var(--card);border:1px solid var(--bd);cursor:pointer;transition:all .15s}
.kpi-card:active{transform:scale(.97)}
.kpi-v{font-size:24px;font-weight:900;color:var(--c)}.kpi-l{font-size:9px;font-weight:700;color:var(--sub);margin-top:3px}
.pipe{display:flex;gap:4px;margin-bottom:12px;overflow-x:auto}
.pipe-item{flex:1;min-width:60px;text-align:center;padding:10px 6px;border-radius:10px;background:var(--card);border:1px solid var(--bd);cursor:pointer;transition:all .15s}
.pipe-item.on{border-color:var(--c);background:rgba(192,57,43,.04)}
.pipe-v{font-size:18px;font-weight:900;color:var(--c)}.pipe-l{font-size:8px;font-weight:700;color:var(--sub);margin-top:2px}
.todo-item{padding:10px 12px;border-radius:10px;background:#FFF8E1;border:1px solid #FFE082;margin-bottom:6px;cursor:pointer;display:flex;gap:10px;align-items:center}
.todo-icon{font-size:18px;flex-shrink:0}
.todo-body{flex:1;min-width:0}
.todo-nm{font-size:12px;font-weight:700}.todo-sub{font-size:10px;color:var(--sub)}
.compare-grid{display:grid;gap:1px;background:#eee;border-radius:10px;overflow:hidden}
.compare-cell{background:#fff;padding:10px 12px;font-size:12px}
.compare-cell.hd{font-weight:800;background:#fafafa;color:var(--sub);font-size:10px}
.smart-box{border:2px solid rgba(192,57,43,.15);border-radius:14px;padding:16px;background:rgba(192,57,43,.02)}
.smart-cat{padding:10px 12px;border-radius:10px;background:var(--card);margin-bottom:6px;border:1px solid var(--bd);font-size:12px;line-height:1.6}
.smart-cat b{color:var(--c)}
.smart-tag{display:inline-block;font-size:9px;font-weight:800;padding:2px 7px;border-radius:5px;margin-right:4px}
.empty{text-align:center;padding:40px 20px;color:#ccc;font-size:13px}
.ex{padding:9px 12px;border-radius:10px;background:var(--lt);margin-bottom:5px;font-size:11px;color:#777;cursor:pointer;border:1px solid #EDEDED;line-height:1.4}
.fb{display:flex;justify-content:space-between;align-items:center}
.fr{display:flex;gap:8px;align-items:center}.fw{flex-wrap:wrap}
.mt8{margin-top:8px}.mt12{margin-top:12px}.mb6{margin-bottom:6px}.mb8{margin-bottom:8px}.mb10{margin-bottom:10px}.mb12{margin-bottom:12px}
select.inp{cursor:pointer;-webkit-appearance:none;appearance:none;background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='5'%3E%3Cpath d='M0 0l4 5 4-5z' fill='%23999'/%3E%3C/svg%3E") no-repeat right 12px center #fff;padding-right:28px}
.map-btns{display:flex;gap:6px;margin-top:6px;flex-wrap:wrap}
.map-btn{padding:6px 12px;border-radius:8px;font-size:11px;font-weight:700;cursor:pointer;border:none;color:#fff;text-decoration:none;display:inline-flex;align-items:center;gap:3px}
.map-naver{background:#03C75A}.map-kakao{background:#FEE500;color:#000}.map-google{background:#4285F4}
.check-btns{display:flex;flex-wrap:wrap;gap:6px}
.ck-btn{display:flex;flex-direction:column;padding:10px 12px;border-radius:10px;text-decoration:none;font-weight:800;font-size:11px;flex:1;min-width:44%;transition:transform .15s;border:1.5px solid #eee}
.ck-btn:active{transform:scale(.96)}
.ck-btn span{font-size:8px;font-weight:500;margin-top:2px;opacity:.7}
.ck-1{background:#E3F2FD;color:#0D47A1;border-color:#90CAF9}.ck-2{background:#FFF3E0;color:#E65100;border-color:#FFCC80}
.ck-3{background:#E8F5E9;color:#1B5E20;border-color:#A5D6A7}.ck-4{background:#F3E5F5;color:#4A148C;border-color:#CE93D8}
.ck-5{background:#FFF8E1;color:#F57F17;border-color:#FFE082}.ck-6{background:#E8F5E9;color:#00695C;border-color:#80CBC4}
.quick-links{display:inline-flex;gap:4px;margin-left:4px;vertical-align:middle}
.quick-links a{font-size:13px;text-decoration:none;opacity:.6}
.tag{display:inline-block;font-size:9px;font-weight:700;padding:2px 7px;border-radius:4px;background:#E8F0FE;color:#1967D2;margin-right:3px}
.grade-store{font-size:9px;font-weight:800;padding:2px 7px;border-radius:5px}
.ckb{width:22px;height:22px;border-radius:5px;border:2px solid #ccc;cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:all .15s;margin-right:6px}
.ckb.on{background:var(--c);border-color:var(--c)}.ckb.on::after{content:'âœ“';color:#fff;font-size:12px;font-weight:800}
.sel-bar{display:flex;align-items:center;gap:6px;padding:8px 10px;background:#FFF8E1;border-radius:10px;margin-bottom:8px;flex-wrap:wrap}
.sel-all{display:flex;align-items:center;gap:4px;cursor:pointer;font-size:11px;font-weight:700}
.sms-tpl{padding:8px 10px;border-radius:8px;border:1.5px solid #eee;cursor:pointer;font-size:11px}
.sms-tpl.on{border-color:var(--c);background:rgba(192,57,43,.05)}
.grade-A{background:#E8F5E9;color:#2E7D32}.grade-B{background:#FFF3E0;color:#E65100}.grade-C{background:#FFEBEE;color:#C62828}
.phone-link{color:var(--c);text-decoration:none;font-weight:600}
.smart-toolbar{display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap}
.voice-btn{background:#4CAF50;color:#fff;border:none;border-radius:10px;padding:9px 14px;font-size:12px;font-weight:700;cursor:pointer;font-family:inherit}
.voice-btn.recording{background:#E53935;animation:pulse 1s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.6}}
.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.6);z-index:200;display:flex;align-items:center;justify-content:center;padding:16px}
.modal-box{background:#fff;border-radius:16px;padding:20px;max-width:500px;width:100%;max-height:80vh;overflow-y:auto}
.hist-item{padding:8px 12px;border-radius:8px;background:var(--lt);margin-bottom:4px;font-size:11px;color:#666;cursor:pointer;border:1px solid #eee}
.link-item{padding:8px 12px;border-radius:8px;background:#E8F5E9;border:1px solid #C8E6C9;margin-bottom:4px;font-size:11px;display:flex;justify-content:space-between;align-items:center}
.dup-warn{padding:10px 14px;border-radius:10px;background:#FFF3E0;border:1px solid #FFE082;margin-bottom:10px;font-size:12px;color:#E65100;font-weight:600}
.status-chip{font-size:9px;font-weight:800;padding:2px 8px;border-radius:10px;margin-left:4px}
.st-new{background:#E3F2FD;color:#1565C0}.st-consult{background:#FFF3E0;color:#E65100}.st-contract{background:#FCE4EC;color:#C62828}.st-done{background:#E8F5E9;color:#2E7D32}.st-lost{background:#F5F5F5;color:#999}
.st-vacant{background:#FFEBEE;color:#C62828}.st-intro{background:#FFF3E0;color:#E65100}.st-contracting{background:#E3F2FD;color:#1565C0}.st-completed{background:#E8F5E9;color:#2E7D32}
@media(max-width:400px){.r2{grid-template-columns:1fr}.r3{grid-template-columns:1fr 1fr}.r4{grid-template-columns:1fr 1fr}.kpi{grid-template-columns:repeat(2,1fr)}.kpi4{grid-template-columns:repeat(2,1fr)}}
/* â•â•â• MOBILE (Galaxy S24 Ultra) â•â•â• */
.inp{padding:14px;font-size:15px;min-height:48px;border-radius:12px}
.btn{padding:14px 20px;font-size:14px;min-height:48px;border-radius:12px}
.btn-sm{padding:10px 14px;font-size:12px;min-height:38px}
.item{padding:16px;min-height:68px}
.item-no{width:32px;height:32px;border-radius:10px}
.item-nm{font-size:14px}.item-meta{font-size:12px}
.chip{padding:9px 14px;font-size:12px;min-height:38px;border-radius:20px;border-width:2px}
.kpi-card{padding:16px 10px;border-radius:14px}.kpi-v{font-size:28px}
.pipe-item{min-width:70px;padding:12px 8px;border-radius:12px;border-width:2px}.pipe-v{font-size:20px}
.memo{padding:12px 14px;border-radius:12px;margin-bottom:8px}.memo-txt{font-size:13px}
.todo-item{padding:14px;border-radius:12px;min-height:56px;margin-bottom:8px}
.photo-thumb{width:90px;height:90px;border-radius:12px}.photo-add{width:90px;height:90px;border-radius:12px;font-size:28px}
.map-btn{padding:10px 16px;min-height:42px;border-radius:10px}
.link-item{padding:10px 14px;min-height:44px;border-radius:10px}
.modal-overlay{align-items:flex-end}
.modal-box{border-radius:20px 20px 0 0;padding:20px 16px calc(20px + var(--safe-b))}
.ex{padding:12px 14px;min-height:44px;border-radius:12px;font-size:12px;display:flex;align-items:center}
.voice-btn{padding:14px 18px;font-size:14px;min-height:48px;border-radius:12px}
.ta{min-height:80px;font-size:15px}
select.inp{padding-right:32px}
</style>
</head>
<body>
<div class="top"><h1>ğŸ“‹ í†µí•© DB</h1></div>
<div class="tabs" id="tabs"></div>
<div class="main" id="main"></div>
<div id="modal"></div>
<nav class="nav" id="bnav"></nav>
<button class="fab" id="fab" onclick="fabAction()">+</button>

<script>
const $=id=>document.getElementById(id);
const uid=()=>Date.now().toString(36)+Math.random().toString(36).slice(2,6);
const now=()=>{const d=new Date();return`${d.getFullYear()}.${String(d.getMonth()+1).padStart(2,'0')}.${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;};
const today=()=>new Date().toISOString().slice(0,10);
const todayDot=()=>{const d=new Date();return`${d.getFullYear()}.${String(d.getMonth()+1).padStart(2,'0')}.${String(d.getDate()).padStart(2,'0')}`;};
const fW=n=>{if(!n&&n!==0)return'';const v=typeof n==='string'?parseInt(n.replace(/[, ]/g,'')):n;if(isNaN(v)||v===0)return'';if(v>=1e8)return(v/1e8).toFixed(1).replace(/\.0$/,'')+'ì–µ';if(v>=1e4)return Math.round(v/1e4)+'ë§Œ';return v.toLocaleString();};
const esc=s=>(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
const numVal=v=>{if(!v)return 0;const s=String(v).replace(/[, ]/g,'');
const m=s.match(/(\d+)\s*ì–µ\s*(\d*)\s*(ì²œë§Œ|ë§Œ)?/);if(m){let r=parseInt(m[1])*1e8;if(m[2]&&m[3]==='ì²œë§Œ')r+=parseInt(m[2])*1e7;else if(m[2]&&m[3]==='ë§Œ')r+=parseInt(m[2])*1e4;else if(m[2])r+=parseInt(m[2])*1e4;return r;}
const m2=s.match(/(\d+)\s*ì²œë§Œ/);if(m2)return parseInt(m2[1])*1e7;
const m3=s.match(/(\d+)\s*ë§Œ/);if(m3)return parseInt(m3[1])*1e4;
return parseInt(s)||0;};

const TABS=[{id:'dash',icon:'ğŸ“Š',label:'ëŒ€ì‹œë³´ë“œ'},{id:'smart',icon:'ğŸ“',label:'í†µí•©ì…ë ¥'},{id:'search',icon:'ğŸ”',label:'ê²€ìƒ‰'},{id:'cust',icon:'ğŸ‘¥',label:'ê³ ê°'},{id:'store',icon:'ğŸª',label:'ì í¬'},{id:'brand',icon:'ğŸ·',label:'ë¸Œëœë“œ'},{id:'set',icon:'âš™ï¸',label:'ì„¤ì •'}];
const GRADES=['VIP','ìš°ìˆ˜','ì¼ë°˜','ì‹ ê·œ','íœ´ë©´'];
const SGRADES=['Aê¸‰','Bê¸‰','Cê¸‰','ë¯¸ì •'];
const CTYPES=['ì „í™”','ë°©ë¬¸','ì¹´ì¹´ì˜¤í†¡','ë¬¸ì','ì´ë©”ì¼','ê¸°íƒ€'];
const CSTATUS=['ì‹ ê·œ','ìƒë‹´ì¤‘','ê³„ì•½ì§„í–‰','ê³„ì•½ì™„ë£Œ','ì´íƒˆ'];
const SSTATUS=['ê³µì‹¤','ì†Œê°œì¤‘','ê³„ì•½ì§„í–‰','ê³„ì•½ì™„ë£Œ'];
const PHONE_RE=/\d{2,3}-\d{3,4}-\d{4}/;
const ST_CLS={'ì‹ ê·œ':'st-new','ìƒë‹´ì¤‘':'st-consult','ê³„ì•½ì§„í–‰':'st-contract','ê³„ì•½ì™„ë£Œ':'st-done','ì´íƒˆ':'st-lost','ê³µì‹¤':'st-vacant','ì†Œê°œì¤‘':'st-intro','ê³„ì•½ì§„í–‰':'st-contracting','ê³„ì•½ì™„ë£Œ':'st-completed'};

let D={tab:'dash',customers:[],stores:[],brands:[],editId:null,search:'',fGrade:'all',fSGrade:'all',fCStatus:'all',fSStatus:'all',smartText:'',smartHistory:[],compareIds:[],
  sq:'',sScope:'all',sField:'all',sSort:'newest',sRentMin:'',sRentMax:'',sDepositMin:'',sDepositMax:'',sPremiumMin:'',sPremiumMax:'',sAreaMin:'',sAreaMax:'',
  sCkMemo:false,sCkPhoto:false,sCkPhone:false,sCkConsult:false,sCkNoPremium:false,sCkToday:false,sCk7d:false,sCk30d:false,sCkDateFrom:'',sCkDateTo:'',
  cfRegion:'',cfBudgetMin:'',cfBudgetMax:'',cfBizType:'',cfAreaMin:'',cfAreaMax:'',cfOpen:false,
  sfDistrict:'',sfRentMin:'',sfRentMax:'',sfDepositMin:'',sfDepositMax:'',sfPremiumMin:'',sfPremiumMax:'',sfAreaMin:'',sfAreaMax:'',sfFloor:'',sfOpen:false,
  custCats:['ì°¨ì•Œ DB','ë‚´ì¼ì‚¬ì¥ DB'],storeCats:['ë‚´ì¼ì‚¬ì¥DB','ì›ìœŒì•¤ì½”DB','ì°½ì—…ì›DB','í™©ì„ ì‘ íŒ€ì¥ DB'],fCustCat:'all',fStoreCat:'all'};
try{const s=JSON.parse(localStorage.getItem('udb6'));if(s){D.customers=s.customers||[];D.stores=s.stores||[];D.brands=s.brands||[];D.smartHistory=s.smartHistory||[];D.custCats=s.custCats||D.custCats;D.storeCats=s.storeCats||D.storeCats;D.aligoKey=s.aligoKey||'';D.aligoId=s.aligoId||'';D.aligoSender=s.aligoSender||'';D.aligoTest=s.aligoTest||'Y';}}catch{}
function save(){try{localStorage.setItem('udb6',JSON.stringify({customers:D.customers,stores:D.stores,brands:D.brands,smartHistory:D.smartHistory,custCats:D.custCats,storeCats:D.storeCats,aligoKey:D.aligoKey,aligoId:D.aligoId,aligoSender:D.aligoSender,aligoTest:D.aligoTest}));}catch{}}
function R(){renderTabs();renderMain();save();}

function renderTabs(){const todos=getTodos();
const navEl=$('bnav');if(navEl){const NAVS=[{id:'dash',icon:'ğŸ“Š',label:'ëŒ€ì‹œë³´ë“œ'},{id:'smart',icon:'ğŸ“',label:'ì…ë ¥'},{id:'search',icon:'ğŸ”',label:'ê²€ìƒ‰'},{id:'cust',icon:'ğŸ‘¥',label:'ê³ ê°'},{id:'store',icon:'ğŸª',label:'ì í¬'},{id:'brand',icon:'ğŸ·',label:'ë¸Œëœë“œ'},{id:'set',icon:'âš™ï¸',label:'ì„¤ì •'}];navEl.innerHTML=NAVS.map(n=>{const b2=(n.id==='dash'&&todos.length)?`<span class="nav-badge">${todos.length}</span>`:'';return`<div class="nav-item${D.tab===n.id?' on':''}" onclick="D.tab='${n.id}';D.editId=null;D.search='';R()"><i>${n.icon}</i><span>${n.label}</span>${b2}</div>`;}).join('');}
const fab=$('fab');if(fab){if(D.tab==='dash'||D.tab==='search'||D.tab==='set')fab.style.display='none';else{fab.style.display='flex';fab.textContent=D.editId?'â†‘':'+';}}
$('tabs').innerHTML='';}

function renderMain(){const m=$('main');
  if(D.tab==='dash')renderDash(m);
  else if(D.tab==='smart')renderSmart(m);
  else if(D.tab==='search')renderSearch(m);
  else if(D.tab==='cust')D.editId?renderCustEdit(m):renderCustList(m);
  else if(D.tab==='store')D.editId?renderStoreEdit(m):renderStoreList(m);
  else if(D.tab==='brand')D.editId?renderBrandEdit(m):renderBrandList(m);
  else if(D.tab==='set')renderSettings(m);}

// â•â•â• HELPERS â•â•â•
function phoneHTML(p){if(!p)return'-';return`<a href="tel:${p.replace(/-/g,'')}" class="phone-link" onclick="event.stopPropagation()">ğŸ“ ${esc(p)}</a>`;}
function mapBtns(addr){if(!addr)return'';const q=encodeURIComponent(addr);return`<div class="map-btns"><a href="https://map.naver.com/v5/search/${q}" target="_blank" class="map-btn map-naver">ğŸ—º ë„¤ì´ë²„</a><a href="https://map.kakao.com/?q=${q}" target="_blank" class="map-btn map-kakao">ğŸ—º ì¹´ì¹´ì˜¤</a><a href="https://maps.google.com/maps?q=${q}" target="_blank" class="map-btn map-google">ğŸ—º êµ¬ê¸€</a></div>`;}
function checkBtns(addr){if(!addr)return'';const q=encodeURIComponent(addr);return`<div class="c" style="border:1.5px solid #FFB74D"><div class="c-h" style="color:#E65100;background:#FFF3E0;border:none">ğŸ” ê¶Œë¦¬ í™•ì¸ Â· ì‹œì„¸</div><div class="c-b" style="padding:8px 10px"><div class="check-btns"><a href="https://new.land.naver.com/search?keyword=${q}" target="_blank" class="ck-btn ck-6">ğŸ  ë„¤ì´ë²„ë¶€ë™ì‚°<span>ì£¼ë³€ì‹œì„¸Â·ë§¤ë¬¼Â·ì‹¤ê±°ë˜</span></a><a href="https://www.iros.go.kr/PMainJ.jsp" target="_blank" class="ck-btn ck-1">ğŸ“‹ ë“±ê¸°ë¶€ë“±ë³¸<span>ì†Œìœ ê¶ŒÂ·ê·¼ì €ë‹¹Â·ê°€ì••ë¥˜</span></a><a href="https://www.gov.kr/search/apply?srhQuery=${q}+ê±´ì¶•ë¬¼ëŒ€ì¥" target="_blank" class="ck-btn ck-2">ğŸ— ê±´ì¶•ë¬¼ëŒ€ì¥<span>ìš©ë„Â·ë©´ì Â·ìœ„ë°˜ê±´ì¶•ë¬¼</span></a><a href="https://eum.go.kr/web/ar/lu/luLandDet.jsp" target="_blank" class="ck-btn ck-3">ğŸ—º í† ì§€ì´ìš©ê³„íš<span>ìš©ë„ì§€ì—­Â·ê·œì œ</span></a><a href="https://rt.molit.go.kr/" target="_blank" class="ck-btn ck-4">ğŸ’° ì‹¤ê±°ë˜ê°€<span>êµ­í† ë¶€ ê³µì‹</span></a><a href="https://www.nts.go.kr/nts/cm/cntnts/cntntsView.do?mi=2372&cntntsId=7778" target="_blank" class="ck-btn ck-5">ğŸ¢ ì‚¬ì—…ìí™•ì¸<span>íì—…Â·íœ´ì—…</span></a></div><div style="font-size:9px;color:#999;margin-top:6px;line-height:1.4">ğŸ’¡ ë„¤ì´ë²„ë¶€ë™ì‚°: ì£¼ë³€ ìƒê°€ ì‹œì„¸ ë¹„êµ<br>ğŸ’¡ ë“±ê¸°ë¶€ë“±ë³¸ ì„êµ¬: ê·¼ì €ë‹¹/ê°€ì••ë¥˜ í™•ì¸</div></div></div>`;}
function extractTags(t){const m=t.match(/#[ê°€-í£a-zA-Z0-9_]+/g);return m?[...new Set(m)]:[];}
function tagsHTML(tags){return(tags||[]).map(t=>`<span class="tag">${esc(t)}</span>`).join('');}
function stHTML(st){return st?`<span class="status-chip ${ST_CLS[st]||''}">${st}</span>`:'';}
function daysBetween(ds){if(!ds)return 9999;const p=ds.split(/[.\-\/\s]/);if(p.length<3)return 9999;const d=new Date(parseInt(p[0]),parseInt(p[1])-1,parseInt(p[2]));const n=new Date();n.setHours(0,0,0,0);return Math.floor((n-d)/(1e3*60*60*24));}

// â•â•â• ACTIVITY COUNTER â•â•â•
function addAct(collection,id,action){
  const item=D[collection].find(x=>x.id===id);if(!item)return;
  if(!item.actCount)item.actCount=0;
  if(!item.actLog)item.actLog=[];
  item.actCount++;
  item.actLog.push({no:item.actCount,action,time:now()});
  if(item.actLog.length>50)item.actLog=item.actLog.slice(-50);
  save();
}
function actBadge(item){const n=item.actCount||0;if(!n)return'';return`<span style="font-size:9px;font-weight:800;padding:2px 6px;border-radius:5px;background:#E3F2FD;color:#1565C0;margin-left:4px">ì‘ì—…${n}</span>`;}
function actHTML(item){const logs=(item.actLog||[]).slice().reverse().slice(0,10);
  return`<div class="c"><div class="c-h"><span>ğŸ“‹ ì‘ì—…ì´ë ¥ <b style="color:var(--c)">${item.actCount||0}íšŒ</b></span></div><div class="c-b">${logs.length?logs.map(l=>`<div style="font-size:11px;color:#666;padding:4px 0;border-bottom:1px solid #f5f5f5"><span style="font-weight:800;color:var(--c);margin-right:6px">#${l.no}</span>${esc(l.action)} <span style="color:#bbb;font-size:10px">${l.time}</span></div>`).join(''):'<div style="text-align:center;color:#ddd;font-size:12px;padding:12px">ì‘ì—…ì´ë ¥ ì—†ìŒ</div>'}</div></div>`;}

// â•â•â• FOLLOWUP / TODOS â•â•â•
function getTodos(){const td=todayDot();const todos=[];
  D.customers.forEach(c=>{if(c.followUp&&c.followUp<=td)todos.push({type:'cust',id:c.id,name:c.name||'(ë¯¸ì…ë ¥)',date:c.followUp,label:'ğŸ‘¥ '+c.name});});
  D.stores.forEach(s=>{if(s.followUp&&s.followUp<=td)todos.push({type:'store',id:s.id,name:s.name||'(ë¯¸ì…ë ¥)',date:s.followUp,label:'ğŸª '+s.name});});
  D.brands.forEach(b=>{if(b.followUp&&b.followUp<=td)todos.push({type:'brand',id:b.id,name:b.brandName||'(ë¯¸ì…ë ¥)',date:b.followUp,label:'ğŸ· '+b.brandName});});
  return todos;}

// â•â•â• LINKS (ì—°ê²°) â•â•â•
function getLinks(type,id){const item=D[type==='cust'?'customers':type==='store'?'stores':'brands'].find(x=>x.id===id);return item?.links||[];}
function addLink(fromType,fromId){
  let opts=[];
  D.customers.forEach(c=>opts.push({type:'cust',id:c.id,label:'ğŸ‘¥ '+c.name}));
  D.stores.forEach(s=>opts.push({type:'store',id:s.id,label:'ğŸª '+s.name}));
  D.brands.forEach(b=>opts.push({type:'brand',id:b.id,label:'ğŸ· '+b.brandName}));
  opts=opts.filter(o=>!(o.type===fromType&&o.id===fromId));
  const existing=getLinks(fromType,fromId).map(l=>l.id);
  opts=opts.filter(o=>!existing.includes(o.id));
  if(!opts.length){alert('ì—°ê²°í•  ëŒ€ìƒì´ ì—†ìŠµë‹ˆë‹¤');return;}
  $('modal').innerHTML=`<div class="modal-overlay" onclick="$('modal').innerHTML=''"><div class="modal-box" onclick="event.stopPropagation()"><div style="font-size:14px;font-weight:800;margin-bottom:12px">ğŸ”— ì—°ê²° ëŒ€ìƒ ì„ íƒ</div><input class="inp mb8" placeholder="ê²€ìƒ‰" oninput="filterLinkOpts(this.value,'${fromType}','${fromId}')"><div id="linkOpts">${opts.map(o=>`<div class="hist-item" onclick="doLink('${fromType}','${fromId}','${o.type}','${o.id}');$('modal').innerHTML=''">${o.label}</div>`).join('')}</div></div></div>`;
  window._linkOpts=opts;}
function filterLinkOpts(q,ft,fi){const opts=window._linkOpts.filter(o=>o.label.toLowerCase().includes(q.toLowerCase()));$('linkOpts').innerHTML=opts.map(o=>`<div class="hist-item" onclick="doLink('${ft}','${fi}','${o.type}','${o.id}');$('modal').innerHTML=''">${o.label}</div>`).join('');}
function doLink(ft,fi,tt,ti){
  const from=D[ft==='cust'?'customers':ft==='store'?'stores':'brands'].find(x=>x.id===fi);
  const to=D[tt==='cust'?'customers':tt==='store'?'stores':'brands'].find(x=>x.id===ti);
  if(!from||!to)return;
  if(!from.links)from.links=[];if(!to.links)to.links=[];
  const t=now();
  from.links.push({type:tt,id:ti,time:t});
  to.links.push({type:ft,id:fi,time:t});
  addAct(ft==='cust'?'customers':ft==='store'?'stores':'brands',fi,'ì—°ê²° ì¶”ê°€: '+linkName(tt,ti));
  R();}
function removeLink(ft,fi,ti){
  const from=D[ft==='cust'?'customers':ft==='store'?'stores':'brands'].find(x=>x.id===fi);
  if(from)from.links=(from.links||[]).filter(l=>l.id!==ti);
  ['customers','stores','brands'].forEach(col=>{D[col].forEach(item=>{if(item.id===ti)item.links=(item.links||[]).filter(l=>l.id!==fi);});});R();}
function linkName(type,id){
  if(type==='cust'){const c=D.customers.find(x=>x.id===id);return c?'ğŸ‘¥ '+c.name:'(ì‚­ì œë¨)';}
  if(type==='store'){const s=D.stores.find(x=>x.id===id);return s?'ğŸª '+s.name:'(ì‚­ì œë¨)';}
  const b=D.brands.find(x=>x.id===id);return b?'ğŸ· '+b.brandName:'(ì‚­ì œë¨)';}
function linksHTML(type,id){const links=getLinks(type,id);return`<div class="c"><div class="c-h"><span>ğŸ”— ì—°ê²° (${links.length})</span><button class="btn bp btn-sm" onclick="addLink('${type}','${id}')">+ ì—°ê²°</button></div><div class="c-b">${links.length?links.map(l=>`<div class="link-item"><span style="cursor:pointer" onclick="goToItem('${l.type}','${l.id}')">${esc(linkName(l.type,l.id))}</span><div class="fr"><span style="font-size:9px;color:#aaa">${l.time||''}</span><button style="background:none;border:none;color:#E53935;cursor:pointer;font-size:10px" onclick="event.stopPropagation();removeLink('${type}','${id}','${l.id}')">ì‚­ì œ</button></div></div>`).join(''):'<div style="text-align:center;color:#ddd;font-size:12px;padding:12px">ì—°ê²°ëœ í•­ëª© ì—†ìŒ</div>'}</div></div>`;}

// â•â•â• DASHBOARD â•â•â•
function renderDash(el){
  const todos=getTodos();const td=todayDot();
  const todayCust=D.customers.filter(c=>c.createdAt?.startsWith(td)).length;
  const todayStore=D.stores.filter(s=>s.createdAt?.startsWith(td)).length;
  const weekConsult=D.customers.reduce((n,c)=>n+(c.consultHistory||[]).filter(h=>daysBetween(h.time)<=7).length,0);

  const cheapStores=D.stores.filter(s=>{const r=numVal(s.rent);const m=numVal(s.marketRent);return r&&m&&r<=m;}).length;
  const expStores=D.stores.filter(s=>{const r=numVal(s.rent);const m=numVal(s.marketRent);return r&&m&&r>m;}).length;

  el.innerHTML=`<div style="font-size:18px;font-weight:900;color:var(--c);margin-bottom:12px">ğŸ“Š ëŒ€ì‹œë³´ë“œ</div>
  <div class="kpi kpi4">${[['ğŸ‘¥',D.customers.length,'ê³ ê°'],['ğŸª',D.stores.length,'ì í¬'],['ğŸ·',D.brands.length,'ë¸Œëœë“œ'],['ğŸ“',weekConsult,'ì£¼ê°„ìƒë‹´']].map(([i,v,l])=>`<div class="kpi-card" onclick="D.tab='${l==='ê³ ê°'?'cust':l==='ì í¬'?'store':l==='ë¸Œëœë“œ'?'brand':'cust'}';R()"><div class="kpi-v">${v}</div><div class="kpi-l">${i} ${l}</div></div>`).join('')}</div>
  ${cheapStores+expStores>0?`<div class="kpi r2" style="margin-bottom:12px"><div class="kpi-card" style="background:#E8F5E9;border:1.5px solid #A5D6A7"><div class="kpi-v" style="color:#2E7D32">âœ… ${cheapStores}</div><div class="kpi-l" style="color:#2E7D32">ì‹œì„¸â†“ ì €ë ´</div></div><div class="kpi-card" style="background:#FFF3E0;border:1.5px solid #FFCC80"><div class="kpi-v" style="color:#E65100">âš ï¸ ${expStores}</div><div class="kpi-l" style="color:#E65100">ì‹œì„¸â†‘ ë¹„ìŒˆ</div></div></div>`:''}

  ${todos.length?`<div class="c"><div class="c-h" style="color:var(--c)">ğŸ“Œ ì˜¤ëŠ˜ í•  ì¼ (${todos.length})</div><div class="c-b">${todos.map(t=>`<div class="todo-item" onclick="goToItem('${t.type}','${t.id}')"><div class="todo-icon">â°</div><div class="todo-body"><div class="todo-nm">${esc(t.label)}</div><div class="todo-sub">íŒ”ë¡œì—…: ${t.date}</div></div></div>`).join('')}</div></div>`:''}

  <div class="c"><div class="c-h">ğŸ‘¥ ê³ ê° íŒŒì´í”„ë¼ì¸</div><div class="c-b"><div class="pipe">${CSTATUS.map(st=>{const cnt=D.customers.filter(c=>(c.status||'ì‹ ê·œ')===st).length;return`<div class="pipe-item${D.fCStatus===st?' on':''}" onclick="D.tab='cust';D.fCStatus='${st}';R()"><div class="pipe-v">${cnt}</div><div class="pipe-l">${st}</div></div>`;}).join('')}</div></div></div>

  <div class="c"><div class="c-h">ğŸª ì í¬ í˜„í™©</div><div class="c-b"><div class="pipe">${SSTATUS.map(st=>{const cnt=D.stores.filter(s=>(s.status||'ê³µì‹¤')===st).length;return`<div class="pipe-item${D.fSStatus===st?' on':''}" onclick="D.tab='store';D.fSStatus='${st}';R()"><div class="pipe-v">${cnt}</div><div class="pipe-l">${st}</div></div>`;}).join('')}</div></div></div>

  <div class="kpi r2" style="margin-bottom:0"><div class="kpi-card"><div class="kpi-v">${todayCust}</div><div class="kpi-l">ì˜¤ëŠ˜ ê³ ê°</div></div><div class="kpi-card"><div class="kpi-v">${todayStore}</div><div class="kpi-l">ì˜¤ëŠ˜ ì í¬</div></div></div>`;
}

// â•â•â• SMART INPUT â•â•â•
// â•â•â• SMART INPUT â•â•â•
const KW_S=['í‰','ì„ëŒ€','ì›”ì„¸','ë³´ì¦ê¸ˆ','ê¶Œë¦¬ê¸ˆ','ê´€ë¦¬ë¹„','ê³µì‹¤','ì í¬','ë§¤ë¬¼','ìƒê°€'];
const KW_B=['ë³¸ì‚¬','ê°€ë§¹','í”„ëœì°¨ì´ì¦ˆ','ë¸Œëœë“œ','FC','ì°½ì—…ë¹„ìš©','ë¡œì—´í‹°','ê°€ë§¹ë¹„'];
const GRADE_MAP={'VIP':'VIP','vip':'VIP','ìš°ìˆ˜':'ìš°ìˆ˜','ì¼ë°˜':'ì¼ë°˜','ì‹ ê·œ':'ì‹ ê·œ','íœ´ë©´':'íœ´ë©´'};
const GRADE_RE2=/(VIP|vip|ìš°ìˆ˜|ì‹ ê·œ|íœ´ë©´)(\s*ê³ ê°)?/;
const BIZ_RE=/^(ì¹´í˜|ì»¤í”¼|ì»¤í”¼ìˆ|ì¹˜í‚¨|ë¶„ì‹|ê³ ê¸°|ì‚¼ê²¹ì‚´|ê³±ì°½|íšŸì§‘|ì´ˆë°¥|ì¼ì‹|ì¤‘ì‹|ì–‘ì‹|í•œì‹|ë² ì´ì»¤ë¦¬|ë¹µì§‘|í¸ì˜ì |PCë°©|ë…¸ë˜ë°©|ë‹¹êµ¬ì¥|ì„¸íƒì†Œ|ë¯¸ìš©ì‹¤|ë„¤ì¼|í—¬ìŠ¤|í•„ë¼í…ŒìŠ¤|ìš”ê°€|í•™ì›|ë…ì„œì‹¤|ì‹ë‹¹|ìŒì‹ì |ì£¼ì |ìˆ ì§‘|í˜¸í”„|ë§¥ì£¼|ì™€ì¸|ë””ì €íŠ¸|ì•„ì´ìŠ¤í¬ë¦¼|ë–¡ë³¶ì´|í”¼ì|í–„ë²„ê±°|ìƒŒë“œìœ„ì¹˜|ìƒëŸ¬ë“œ|ì£½|êµ­ë°¥|ì„¤ë íƒ•|ê°ìíƒ•|ì°Œê°œ|ìˆœëŒ€|ë§Œë‘|ê¹€ë°¥|ë„ì‹œë½|ë¹µ|ë–¡|ê½ƒì§‘|ì„¸ì°¨|ì£¼ìœ ì†Œ|ì•½êµ­|ë³‘ì›|ì¹˜ê³¼|í•œì˜ì›|ë™ë¬¼ë³‘ì›|ë¶€ë™ì‚°|íƒœê¶Œë„|ë°˜ì°¬|ì •ìœ¡ì |ê³¼ì¼|ë§ˆíŠ¸|ìŠˆí¼)$/;
const BIZ_SEARCH=/ì¹´í˜|ì»¤í”¼|ì»¤í”¼ìˆ|ì¹˜í‚¨|ë¶„ì‹|ê³ ê¸°|ì‚¼ê²¹ì‚´|ê³±ì°½|íšŸì§‘|ì´ˆë°¥|ì¼ì‹|ì¤‘ì‹|ì–‘ì‹|í•œì‹|ë² ì´ì»¤ë¦¬|ë¹µì§‘|í¸ì˜ì |PCë°©|ë…¸ë˜ë°©|ë‹¹êµ¬ì¥|ì„¸íƒì†Œ|ë¯¸ìš©ì‹¤|ë„¤ì¼|í—¬ìŠ¤|í•„ë¼í…ŒìŠ¤|ìš”ê°€|í•™ì›|ë…ì„œì‹¤|ì‹ë‹¹|ìŒì‹ì |ì£¼ì |ìˆ ì§‘|í˜¸í”„|ë§¥ì£¼|ì™€ì¸|ë””ì €íŠ¸|ì•„ì´ìŠ¤í¬ë¦¼|ë–¡ë³¶ì´|í”¼ì|í–„ë²„ê±°|ìƒŒë“œìœ„ì¹˜|ìƒëŸ¬ë“œ|ì£½|êµ­ë°¥|ì„¤ë íƒ•|ê°ìíƒ•|ì°Œê°œ|ìˆœëŒ€|ë§Œë‘|ê¹€ë°¥|ë„ì‹œë½|ë¹µ|ë–¡|ê½ƒì§‘|ì„¸ì°¨|ì£¼ìœ ì†Œ|ì•½êµ­|ë³‘ì›|ì¹˜ê³¼|í•œì˜ì›|ë™ë¬¼ë³‘ì›|ë¶€ë™ì‚°|íƒœê¶Œë„|ë°˜ì°¬|ì •ìœ¡ì |ê³¼ì¼|ë§ˆíŠ¸|ìŠˆí¼/;
const REGION_RE2=/^(ê°•ë‚¨|ì„œì´ˆ|ë§ˆí¬|ì†¡íŒŒ|ê°•ì„œ|ì˜ë“±í¬|ì¢…ë¡œ|ì„±ë™|ê´‘ì§„|ë™ëŒ€ë¬¸|ì¤‘ë‘|ì„±ë¶|ê°•ë¶|ë„ë´‰|ë…¸ì›|ì€í‰|ì„œëŒ€ë¬¸|ìš©ì‚°|ë™ì‘|ê´€ì•…|ê¸ˆì²œ|êµ¬ë¡œ|ì–‘ì²œ|ê°•ë™|ì¤‘êµ¬|ì„±ë‚¨|ë¶„ë‹¹|ì¼ì‚°|ìˆ˜ì›|ì¸ì²œ|ë¶€ì‚°|ëŒ€êµ¬|ê´‘ì£¼|ëŒ€ì „|ìš¸ì‚°|ì œì£¼|íŒŒì£¼|ê¹€í¬|í•˜ë‚¨|êµ¬ë¦¬|ë‚¨ì–‘ì£¼|ì˜ì •ë¶€|ê³ ì–‘|ìš©ì¸|í™”ì„±|í‰íƒ|ì•ˆì–‘|ì•ˆì‚°|ì‹œí¥|ê´‘ëª…|êµ°í¬|ì˜ì™•|ê³¼ì²œ|ë™íƒ„|íŒêµ|ìœ„ë¡€|ì ì‹¤|ì‹ ì‚¬|í™ëŒ€|ì´íƒœì›|ê±´ëŒ€|í•©ì •|ë§ì›|ìƒìˆ˜|ì—°ë‚¨|ì‹ ì´Œ|í˜œí™”|ì‚¼ì„±|ì„ ë¦‰|ì—­ì‚¼|ë…¼í˜„|ë°©ë°°|ì–‘ì¬|êµëŒ€|ì‚¬ë‹¹|ì´ìˆ˜|í•œë‚¨|ì²­ë‹´|ì••êµ¬ì •|ì„±ìˆ˜|ì™•ì‹­ë¦¬|íšŒê¸°|ë‹µì‹­ë¦¬|ë©´ëª©)[êµ¬ì‹œêµ°]?$/;
const REGION_SEARCH=/(ê°•ë‚¨|ì„œì´ˆ|ë§ˆí¬|ì†¡íŒŒ|ê°•ì„œ|ì˜ë“±í¬|ì¢…ë¡œ|ì„±ë™|ê´‘ì§„|ë™ëŒ€ë¬¸|ì¤‘ë‘|ì„±ë¶|ê°•ë¶|ë„ë´‰|ë…¸ì›|ì€í‰|ì„œëŒ€ë¬¸|ìš©ì‚°|ë™ì‘|ê´€ì•…|ê¸ˆì²œ|êµ¬ë¡œ|ì–‘ì²œ|ê°•ë™|ì¤‘êµ¬|ì„±ë‚¨|ë¶„ë‹¹|ì¼ì‚°|ìˆ˜ì›|ì¸ì²œ|ë¶€ì‚°|ëŒ€êµ¬|ê´‘ì£¼|ëŒ€ì „|ìš¸ì‚°|ì œì£¼|íŒŒì£¼|ê¹€í¬|í•˜ë‚¨|êµ¬ë¦¬|ë‚¨ì–‘ì£¼|ì˜ì •ë¶€|ê³ ì–‘|ìš©ì¸|í™”ì„±|í‰íƒ|ì•ˆì–‘|ì•ˆì‚°|ì‹œí¥|ê´‘ëª…|êµ°í¬|ì˜ì™•|ê³¼ì²œ|ë™íƒ„|íŒêµ|ìœ„ë¡€|ì ì‹¤|ì‹ ì‚¬|í™ëŒ€|ì´íƒœì›|ê±´ëŒ€|í•©ì •|ë§ì›|ìƒìˆ˜|ì—°ë‚¨|ì‹ ì´Œ|í˜œí™”|ì‚¼ì„±|ì„ ë¦‰|ì—­ì‚¼|ë…¼í˜„|ë°©ë°°|ì–‘ì¬|êµëŒ€|ì‚¬ë‹¹|ì´ìˆ˜|í•œë‚¨|ì²­ë‹´|ì••êµ¬ì •|ì„±ìˆ˜|ì™•ì‹­ë¦¬|íšŒê¸°|ë‹µì‹­ë¦¬|ë©´ëª©)[êµ¬ì‹œêµ°]?/;
const SKIP_NAMES=['ê³ ê°','ì‚¬ëŒ','ì´ë¦„','ë²ˆí˜¸','ê´€ì‹¬','í¬ë§','ì˜ˆì‚°','ì§€ì—­','ì—…ì¢…','ì°½ì—…','íˆ¬ì','ë°©ë¬¸','ìƒë‹´','ë¬¸ì˜','ëŒ€í‘œ','ê³„ì•½','ì¡°ê±´','ì •ë³´','ì˜¤ëŠ˜','ë‚´ì¼','ì–´ì œ','í™•ì¸','ìš”ì²­','ì¶”ì²œ','ì†Œê°œ','ì˜ë¢°','ì‹œì‘','ì™„ë£Œ','ì§„í–‰','ë§ˆê°','ì°¾ëŠ”','ì—°ë½ì²˜','ì—°ë½','ì „í™”','í•¸ë“œí°','íœ´ëŒ€í°'];
const SURNAMES='ê¹€ì´ë°•ìµœì •ê°•ì¡°ìœ¤ì¥ì„í•œì˜¤ì„œì‹ ê¶Œí™©ì•ˆì†¡ë¥˜ì „í™ê³ ë¬¸ì–‘ì†ë°°ë°±í—ˆìœ ë‚¨ì‹¬ë…¸í•˜ê³½ì„±ì°¨ì£¼ìš°êµ¬ì‹ ì„ë‚˜ì§„ë¯¼';

function parseAmt(text,kw){
const m1=text.match(new RegExp(kw+'[ë£Œë¹„ê¸ˆì„¸]?\\s*(\\d+)\\s*ì–µ\\s*(\\d+)?\\s*(ì²œë§Œ|ë§Œ)?'));
if(m1){let v=parseInt(m1[1])*1e8;if(m1[2]&&m1[3]==='ì²œë§Œ')v+=parseInt(m1[2])*1e7;else if(m1[2])v+=parseInt(m1[2])*1e4;return v;}
const m2=text.match(new RegExp(kw+'[ë£Œë¹„ê¸ˆì„¸]?\\s*(\\d+)\\s*(ì²œë§Œ|ë°±ë§Œ|ë§Œ)'));
if(m2){const n=parseInt(m2[1]);return m2[2]==='ì²œë§Œ'?n*1e7:m2[2]==='ë°±ë§Œ'?n*1e6:n*1e4;}
const m3=text.match(new RegExp(kw+'[ë£Œë¹„ê¸ˆì„¸]?\\s*(\\d+)\\s*(ë§Œì›|ì›)?'));
if(m3){const n=parseInt(m3[1]);if(m3[2]==='ë§Œì›')return n*1e4;if(m3[2]==='ì›')return n;return n>=1?n*1e4:n;}
return 0;}

function isName(w){
if(!w||w.length<2||w.length>4)return false;
if(!/^[ê°€-í£]+$/.test(w))return false;
if(SKIP_NAMES.includes(w))return false;
if(GRADE_MAP[w])return false;
if(BIZ_RE.test(w))return false;
if(REGION_RE2.test(w))return false;
if(SURNAMES.includes(w[0])&&w.length>=2&&w.length<=4)return true;
if(/êµ¬$|ë™$|ì‹œ$|êµ°$|ì$|ë©´$|ë¡œ$|ê¸¸$|ì—­$|ì§‘$/.test(w))return false;
if(w.length>=2&&w.length<=3)return true;
return false;}

function extractNameSuffix(w){
if(!w||w.length<3)return null;
const suf=['ì‚¬ì¥','ëŒ€í‘œ','ì´ì‚¬','ë¶€ì¥','ê³¼ì¥','ì°¨ì¥','ëŒ€ë¦¬','ì‚¬ì›','ì„ ìƒ','ì”¨','ë‹˜','íŒ€ì¥','ì‹¤ì¥','ì„¼í„°ì¥','ì›ì¥','ì†Œì¥','ë³¸ë¶€ì¥'];
for(const s of suf){if(w.endsWith(s)){const nm=w.slice(0,-s.length);if(nm.length>=2&&nm.length<=4&&/^[ê°€-í£]+$/.test(nm))return nm;}}return null;}

function classify(text){if(!text.trim())return null;const res={customers:[],stores:[],brands:[]};
const lines=text.split(/\n/).flatMap(line=>{
if(KW_S.some(k=>line.includes(k)))return[line];
return line.split(/\s*\/\s*/);}).filter(l=>l.trim());

lines.forEach(l=>{l=l.trim();
const isS=KW_S.some(k=>l.includes(k));const isB=KW_B.some(k=>l.includes(k));
const ph=(l.match(PHONE_RE)||[])[0]||'';const tags=extractTags(l);const cl=l.replace(/#[ê°€-í£a-zA-Z0-9_]+/g,'').trim();

if(isS){const s={name:'',address:'',area:'',rent:'',maintenance:'',premium:'',deposit:'',floor:'',grade:'ë¯¸ì •',memo:'',tags};
const aM=cl.match(/(\d+)\s*í‰/);if(aM)s.area=aM[1];
const flM=cl.match(/(B\d+|ì§€í•˜\s*\d+|\d+)\s*ì¸µ/)||cl.match(/\b(B\d+)\b/);
if(flM)s.floor=flM[0].includes('ì¸µ')?flM[0]:flM[0]+'ì¸µ';
const rent=parseAmt(cl,'ì„ëŒ€')||parseAmt(cl,'ì›”ì„¸');const maint=parseAmt(cl,'ê´€ë¦¬');const dep=parseAmt(cl,'ë³´ì¦');const prem=parseAmt(cl,'ê¶Œë¦¬');
if(rent)s.rent=String(rent);if(maint)s.maintenance=String(maint);if(dep)s.deposit=String(dep);if(prem)s.premium=String(prem);
if(cl.includes('Aê¸‰'))s.grade='Aê¸‰';else if(cl.includes('Bê¸‰'))s.grade='Bê¸‰';else if(cl.includes('Cê¸‰'))s.grade='Cê¸‰';
const nt=[];for(const p of cl.split(/\s+/)){if(/\d/.test(p)&&(/í‰|ë§Œ|ì–µ|ì¸µ/.test(p)))break;if(/^(ì„ëŒ€|ì›”ì„¸|ê´€ë¦¬|ë³´ì¦|ê¶Œë¦¬|ê³µì‹¤|Aê¸‰|Bê¸‰|Cê¸‰|ë§¤ë¬¼)/.test(p))break;if(/^\d+$/.test(p))break;nt.push(p);}
s.name=nt.join(' ')||cl.slice(0,15);
const ex=[];if(cl.includes('ì½”ë„ˆ'))ex.push('ì½”ë„ˆ');if(cl.includes('ì—­ì„¸ê¶Œ'))ex.push('ì—­ì„¸ê¶Œ');if(cl.includes('ëŒ€ë¡œë³€'))ex.push('ëŒ€ë¡œë³€');if(cl.includes('ì‹ ì¶•'))ex.push('ì‹ ì¶•');
if(ex.length)s.memo=ex.join(', ');res.stores.push(s);}

else if(isB){const b={brandName:'',companyName:'',contactName:'',position:'',phone:ph,consultContent:'',tags};
b.brandName=cl.split(/\s+/)[0]||'';
const coM=cl.match(/\(ì£¼\)[^\s]+|ì£¼ì‹íšŒì‚¬\s*[^\s]+/);if(coM)b.companyName=coM[0];
const di=cl.indexOf('ë‹´ë‹¹');if(di>=0){const af=cl.slice(di+2).trim().split(/\s+/);b.contactName=af[0]||'';if(af[1]&&!PHONE_RE.test(af[1]))b.position=af[1];}
['ë¬¸ì˜','ìƒë‹´','í™•ì¸','ìš”ì²­'].forEach(k=>{if(cl.includes(k))b.consultContent=cl.slice(Math.max(0,cl.indexOf(k)-15)).trim();});
if(cl.includes('ì°½ì—…ë¹„ìš©')){const v=parseAmt(cl,'ì°½ì—…ë¹„ìš©');if(v)b.consultContent='ì°½ì—…ë¹„ìš© '+fW(v)+'ì›';}
res.brands.push(b);}

else{const c={name:'',phone:ph,grade:'ì¼ë°˜',region:'',budget:'',bizType:'',memo:'',tags};
const grM=cl.match(GRADE_RE2);if(grM&&GRADE_MAP[grM[1]])c.grade=GRADE_MAP[grM[1]];
const words=cl.split(/\s+/);
if(ph){const pi=words.findIndex(w=>w.includes(ph)||PHONE_RE.test(w));
if(pi>0&&isName(words[pi-1]))c.name=words[pi-1];
else if(pi>=0&&pi<words.length-1&&isName(words[pi+1]))c.name=words[pi+1];
if(!c.name&&pi>0){const ext=extractNameSuffix(words[pi-1]);if(ext)c.name=ext;}}
if(!c.name){for(const w of words){if(isName(w)){c.name=w;break;}}}
if(!c.name){for(const w of words){const ext=extractNameSuffix(w);if(ext){c.name=ext;break;}}}
const regionM=cl.match(REGION_SEARCH);if(regionM)c.region=regionM[0];
const bizM=cl.match(BIZ_SEARCH);if(bizM)c.bizType=bizM[0];
const budgetM=cl.match(/ì˜ˆì‚°\s*(\d+\s*(ì–µ\s*\d*\s*(ì²œë§Œ|ë§Œ)?|ì²œë§Œ|ë°±ë§Œ|ë§Œ))/);
if(budgetM)c.budget=budgetM[1];
else{const amtM=cl.match(/(\d+\s*(ì–µ\s*\d*\s*(ì²œë§Œ|ë§Œ)?|ì²œë§Œ|ë§Œ))/);if(amtM)c.budget=amtM[0];}
let rest=cl;if(c.name)rest=rest.replace(c.name,'');if(ph)rest=rest.replace(ph,'');if(grM)rest=rest.replace(grM[0],'');
const regionM2=rest.match(REGION_SEARCH);if(regionM2)rest=rest.replace(regionM2[0],'');
const bizM2=rest.match(BIZ_SEARCH);if(bizM2)rest=rest.replace(bizM2[0],'');
if(budgetM)rest=rest.replace(budgetM[0],'');else{const amtM2=rest.match(/(\d+\s*(ì–µ\s*\d*\s*(ì²œë§Œ|ë§Œ)?|ì²œë§Œ|ë§Œ))/);if(amtM2)rest=rest.replace(amtM2[0],'');}
rest=rest.replace(/ì˜ˆì‚°|í¬ë§|ê´€ì‹¬|ìˆì–´ìš”|í• ë˜ìš”|ì¥ì‚¬/g,'').replace(/\s+/g,' ').trim();if(rest.length>1)c.memo=rest;
if(c.name||c.phone||c.memo)res.customers.push(c);}
});return(res.customers.length||res.stores.length||res.brands.length)?res:null;}

function renderSmart(el){el.innerHTML=`<div style="font-size:18px;font-weight:900;color:var(--c);margin-bottom:2px">ğŸ“ í†µí•© ì…ë ¥</div><p style="font-size:11px;color:var(--sub);margin-bottom:14px">ììœ ë¡­ê²Œ ì…ë ¥ â†’ ìë™ ë¶„ë¥˜ â†’ DB ì €ì¥</p><div class="c"><div class="c-b" style="padding-top:14px"><textarea class="inp ta" style="min-height:130px;font-size:14px;line-height:1.8" id="sTA" placeholder="ì˜ˆì‹œ:&#10;ê¹€ì² ìˆ˜ 010-1234-5678 VIP #ê°•ë‚¨&#10;ì—­ì‚¼ì—­ 35í‰ ì„ëŒ€ 350ë§Œ ë³´ì¦ê¸ˆ 5ì²œë§Œ Aê¸‰&#10;ë§˜ìŠ¤í„°ì¹˜ ë³¸ì‚¬ ë‹´ë‹¹ ë°•ê³¼ì¥ 010-5555-1234" oninput="D.smartText=this.value">${esc(D.smartText)}</textarea><div class="smart-toolbar mt8"><button class="btn bp" style="flex:1" onclick="runSmart()">âš¡ ìë™ ë¶„ë¥˜</button><button class="voice-btn" id="vBtn" onclick="toggleVoice()">ğŸ¤</button><button class="btn bg" onclick="pasteClip()">ğŸ“‹</button></div></div></div><div id="sRes"></div><div class="c"><div class="c-h">ğŸ’¡ ì˜ˆì‹œ</div><div class="c-b">${['ê¹€ì˜í¬ 010-9876-5432 ìš°ìˆ˜ê³ ê° #ê°•ë‚¨','ê°•ë‚¨ì—­ 2ë²ˆì¶œêµ¬ 35í‰ ì„ëŒ€ 350ë§Œ ê´€ë¦¬ë¹„ 30ë§Œ ë³´ì¦ê¸ˆ 5ì²œë§Œ ê¶Œë¦¬ê¸ˆ 8ì²œë§Œ 1ì¸µ ì½”ë„ˆ Aê¸‰','ë§˜ìŠ¤í„°ì¹˜ ë³¸ì‚¬ (ì£¼)ë§˜ìŠ¤í„°ì¹˜ì•¤ì»´í¼ë‹ˆ ë‹´ë‹¹ ì´ë¶€ì¥ 010-5555-1234 ê°€ë§¹ì¡°ê±´ ë¬¸ì˜'].map(x=>`<div class="ex" onclick="addEx(this.textContent)">${x}</div>`).join('')}</div></div>`;}
function addEx(t){D.smartText=D.smartText?(D.smartText+'\n'+t):t;R();}
async function pasteClip(){try{const t=await navigator.clipboard.readText();D.smartText=D.smartText?(D.smartText+'\n'+t):t;R();}catch{alert('ì§ì ‘ ë¶™ì—¬ë„£ê¸° í•´ì£¼ì„¸ìš”.');}}
let vRec=null;function toggleVoice(){if(!('webkitSpeechRecognition' in window||'SpeechRecognition' in window)){alert('ìŒì„±ì¸ì‹ ë¯¸ì§€ì›');return;}const b=$('vBtn');if(vRec){vRec.stop();vRec=null;b.classList.remove('recording');b.textContent='ğŸ¤';return;}const SR=window.SpeechRecognition||window.webkitSpeechRecognition;vRec=new SR();vRec.lang='ko-KR';vRec.continuous=true;vRec.interimResults=true;vRec.onresult=e=>{let t='';for(let i=e.resultIndex;i<e.results.length;i++)t+=e.results[i][0].transcript;const ta=$('sTA');if(ta){ta.value=D.smartText?(D.smartText+' '+t):t;D.smartText=ta.value;}};vRec.onend=()=>{b.classList.remove('recording');b.textContent='ğŸ¤';vRec=null;R();};vRec.onerror=()=>{b.classList.remove('recording');b.textContent='ğŸ¤';vRec=null;};vRec.start();b.classList.add('recording');b.textContent='â¹';}

function runSmart(){const res=classify(D.smartText);if(!res){$('sRes').innerHTML='<div class="c" style="border-color:var(--c);text-align:center;padding:16px;color:var(--c);font-weight:700">ë¶„ë¥˜í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤</div>';return;}let h='<div class="c smart-box"><div class="c-h" style="border:none;color:var(--c)">âœ… ë¶„ë¥˜ ê²°ê³¼</div><div class="c-b">';const sum=[];
if(res.customers.length){sum.push('ê³ ê°'+res.customers.length);h+=res.customers.map(c=>{let info=[];if(c.region)info.push('ğŸ“'+c.region);if(c.bizType)info.push('ğŸ·'+c.bizType);if(c.budget)info.push('ğŸ’°'+c.budget);return`<div class="smart-cat"><span class="smart-tag" style="background:#FFF3CD;color:#856404">ğŸ‘¥</span>${c.name?' <b>'+esc(c.name)+'</b>':''}${c.phone?' '+phoneHTML(c.phone):''}${c.grade!=='ì¼ë°˜'?' <span class="badge" style="background:#FFF3CD;color:#856404">'+c.grade+'</span>':''}${info.length?'<br><span style="font-size:11px;color:#666">'+info.join(' Â· ')+'</span>':''}${c.memo?'<br><span style="color:var(--sub);font-size:11px">'+esc(c.memo)+'</span>':''}</div>`;}).join('');}
if(res.stores.length){sum.push('ì í¬'+res.stores.length);h+=res.stores.map(s=>{let info=[];if(s.floor)info.push(s.floor);if(s.area)info.push(s.area+'í‰');if(s.rent)info.push('ì„ëŒ€'+fW(s.rent));if(s.maintenance)info.push('ê´€ë¦¬'+fW(s.maintenance));if(s.deposit)info.push('ë³´ì¦'+fW(s.deposit));if(s.premium)info.push('ê¶Œë¦¬'+fW(s.premium));if(s.grade&&s.grade!=='ë¯¸ì •')info.push(s.grade);return`<div class="smart-cat"><span class="smart-tag" style="background:#E8F5E9;color:#2E7D32">ğŸª</span> <b>${esc(s.name)}</b>${info.length?'<br><span style="font-size:11px;color:#666">'+info.join(' Â· ')+'</span>':''}${s.name?mapBtns(s.name):''}</div>`;}).join('');}
if(res.brands.length){sum.push('ë¸Œëœë“œ'+res.brands.length);h+=res.brands.map(b=>`<div class="smart-cat"><span class="smart-tag" style="background:#E3F2FD;color:#1565C0">ğŸ·</span> <b>${esc(b.brandName)}</b>${b.contactName?'<br>ğŸ‘¤ '+esc(b.contactName)+' '+esc(b.position)+' '+(b.phone?phoneHTML(b.phone):''):''}${b.consultContent?'<br><span style="color:var(--sub);font-size:11px">'+esc(b.consultContent)+'</span>':''}</div>`).join('');}
h+=`<div class="fr fw mt12"><button class="btn bp" style="flex:1" onclick="applySmart()">âœ… ì €ì¥</button><button class="btn bg btn-sm" onclick="$('sRes').innerHTML=''">ì·¨ì†Œ</button></div></div></div>`;$('sRes').innerHTML=h;window._sR=res;window._sS=sum.join(', ');}

function applySmart(){const r=window._sR;if(!r)return;const t=now();
r.customers.forEach(c=>{D.customers.unshift({id:uid(),name:c.name||'',phone:c.phone||'',grade:GRADES.includes(c.grade)?c.grade:'ì¼ë°˜',status:'ì‹ ê·œ',region:c.region||'',budget:c.budget||'',bizType:c.bizType||'',wantArea:'',tags:c.tags||[],memos:c.memo?[{id:uid(),text:c.memo,time:t,pinned:false}]:[],consultHistory:[],links:[],followUp:'',interests:'',createdAt:t});});
r.stores.forEach(s=>{D.stores.unshift({id:uid(),name:s.name||'',address:s.address||s.name||'',district:'',area:s.area||'',rent:s.rent||'',maintenance:s.maintenance||'',premium:s.premium||'',deposit:s.deposit||'',floor:s.floor||'',grade:s.grade||'ë¯¸ì •',status:'ê³µì‹¤',tags:s.tags||[],photos:[],mapQuery:s.name||'',memos:s.memo?[{id:uid(),text:s.memo,time:t,pinned:false}]:[],links:[],followUp:'',createdAt:t});});
r.brands.forEach(b=>{D.brands.unshift({id:uid(),brandName:b.brandName||'',companyName:b.companyName||'',contactName:b.contactName||'',position:b.position||'',phone:b.phone||'',tags:b.tags||[],memos:b.consultContent?[{id:uid(),text:b.consultContent,time:t,pinned:false}]:[],links:[],followUp:'',createdAt:t});});
D.smartHistory.unshift({text:D.smartText,time:t,summary:window._sS||''});if(D.smartHistory.length>20)D.smartHistory=D.smartHistory.slice(0,20);D.smartText='';window._sR=null;$('sRes').innerHTML='';save();}

// â•â•â• SEARCH â•â•â•
function inRange(val,min,max){const v=numVal(val);const mn=numVal(min);const mx=numVal(max);if(mn&&v<mn)return false;if(mx&&v>mx)return false;return true;}
function dateMatch(ds){if(D.sCkToday&&daysBetween(ds)!==0)return false;if(D.sCk7d&&daysBetween(ds)>7)return false;if(D.sCk30d&&daysBetween(ds)>30)return false;if(D.sCkDateFrom){const p=ds.split(/[.\-\/\s]/);const d=p[0]+'-'+p[1].padStart(2,'0')+'-'+p[2].padStart(2,'0');if(d<D.sCkDateFrom)return false;}if(D.sCkDateTo){const p=ds.split(/[.\-\/\s]/);const d=p[0]+'-'+p[1].padStart(2,'0')+'-'+p[2].padStart(2,'0');if(d>D.sCkDateTo)return false;}return true;}

function searchAll(){const q=(D.sq||'').toLowerCase().trim();let results=[];
if(D.sScope==='all'||D.sScope==='cust'){D.customers.forEach((c,i)=>{let m=true;const f=[];if(D.sField==='all'||D.sField==='name')f.push(c.name);if(D.sField==='all'||D.sField==='phone')f.push(c.phone);if(D.sField==='all'||D.sField==='address'){f.push(c.region);f.push(c.bizType);f.push(c.budget);f.push(c.interests);f.push(c.dbCat);}if(D.sField==='all'||D.sField==='memo'){f.push(...(c.memos||[]).map(x=>x.text));f.push(...(c.consultHistory||[]).map(h=>h.content+' '+h.result));}if(D.sField==='all'||D.sField==='grade')f.push(c.grade);if(D.sField==='all'){f.push(c.region);f.push(c.bizType);f.push(c.interests);f.push(c.dbCat);f.push(...(c.tags||[]));}if(q&&!f.some(x=>(x||'').toLowerCase().includes(q)))m=false;if(m&&D.sCkPhone&&!c.phone)m=false;if(m&&D.sCkMemo&&(!c.memos||!c.memos.length))m=false;if(m&&D.sCkConsult&&(!c.consultHistory||!c.consultHistory.length))m=false;if(m&&!dateMatch(c.createdAt))m=false;if(m)results.push({type:'cust',no:i+1,item:c,label:'ğŸ‘¥ '+(c.name||'(ë¯¸ì…ë ¥)'),sub:`${c.phone||'-'} Â· ${c.grade} Â· ${c.status||'ì‹ ê·œ'}`,date:c.createdAt,sortVal:0});});}
if(D.sScope==='all'||D.sScope==='store'){D.stores.forEach((s,i)=>{let m=true;const f=[];if(D.sField==='all'||D.sField==='name')f.push(s.name);if(D.sField==='all'||D.sField==='address'){f.push(s.address);f.push(s.district);f.push(s.dbCat);}if(D.sField==='all'||D.sField==='memo')f.push(...(s.memos||[]).map(x=>x.text));if(D.sField==='all'||D.sField==='grade')f.push(s.grade);if(D.sField==='all'){f.push(s.area+'í‰');f.push(s.floor);f.push(s.rent);f.push(s.deposit);f.push(s.premium);f.push(s.status);f.push(s.dbCat);f.push(s.district);f.push(...(s.tags||[]));}if(q&&!f.some(x=>(x||'').toLowerCase().includes(q)))m=false;if(m&&(D.sRentMin||D.sRentMax))m=inRange(s.rent,D.sRentMin,D.sRentMax);if(m&&(D.sDepositMin||D.sDepositMax))m=inRange(s.deposit,D.sDepositMin,D.sDepositMax);if(m&&(D.sPremiumMin||D.sPremiumMax))m=inRange(s.premium,D.sPremiumMin,D.sPremiumMax);if(m&&(D.sAreaMin||D.sAreaMax)){const a=parseInt(s.area)||0;if(D.sAreaMin&&a<parseInt(D.sAreaMin))m=false;if(D.sAreaMax&&a>parseInt(D.sAreaMax))m=false;}if(m&&D.sCkPhoto&&(!s.photos||!s.photos.length))m=false;if(m&&D.sCkMemo&&(!s.memos||!s.memos.length))m=false;if(m&&D.sCkNoPremium&&numVal(s.premium)>0)m=false;if(m&&!dateMatch(s.createdAt))m=false;if(m){let info=[];if(s.area)info.push(s.area+'í‰');if(s.rent)info.push('ì„ëŒ€'+fW(s.rent));if(s.deposit)info.push('ë³´ì¦'+fW(s.deposit));results.push({type:'store',no:i+1,item:s,label:'ğŸª '+(s.name||'(ë¯¸ì…ë ¥)'),sub:info.join(' Â· ')||s.address||'-',date:s.createdAt,sortVal:numVal(s.rent)});}});}
if(D.sScope==='all'||D.sScope==='brand'){D.brands.forEach((b,i)=>{let m=true;const f=[];if(D.sField==='all'||D.sField==='name'){f.push(b.brandName);f.push(b.companyName);}if(D.sField==='all'||D.sField==='phone')f.push(b.phone);if(D.sField==='all'||D.sField==='contact'){f.push(b.contactName);f.push(b.position);}if(D.sField==='all'||D.sField==='memo')f.push(...(b.memos||[]).map(x=>x.text));if(D.sField==='all')f.push(...(b.tags||[]));if(q&&!f.some(x=>(x||'').toLowerCase().includes(q)))m=false;if(m&&D.sCkPhone&&!b.phone)m=false;if(m&&D.sCkMemo&&(!b.memos||!b.memos.length))m=false;if(m&&!dateMatch(b.createdAt))m=false;if(m)results.push({type:'brand',no:i+1,item:b,label:'ğŸ· '+(b.brandName||'(ë¯¸ì…ë ¥)'),sub:`${b.contactName||'-'} ${b.position||''} Â· ${b.phone||'-'}`,date:b.createdAt,sortVal:0});});}
if(D.sSort==='oldest')results.sort((a,b)=>a.date.localeCompare(b.date));else if(D.sSort==='rent_low')results.sort((a,b)=>(a.sortVal||0)-(b.sortVal||0));else if(D.sSort==='rent_high')results.sort((a,b)=>(b.sortVal||0)-(a.sortVal||0));else if(D.sSort==='name')results.sort((a,b)=>a.label.localeCompare(b.label));else if(D.sSort==='area_big')results.sort((a,b)=>(parseInt(b.item.area)||0)-(parseInt(a.item.area)||0));else results.sort((a,b)=>b.date.localeCompare(a.date));
return results;}

function goToItem(type,id){if(type==='cust'){D.tab='cust';addAct('customers',id,'ì¡°íšŒ');}else if(type==='store'){D.tab='store';addAct('stores',id,'ì¡°íšŒ');}else{D.tab='brand';addAct('brands',id,'ì¡°íšŒ');}D.editId=id;R();}
function exportSR(results){const rows=[['No.','êµ¬ë¶„','ì´ë¦„','ì—°ë½ì²˜','ìƒì„¸','ë“±ë¡ì¼']];results.forEach((r,i)=>{let ph='',nm='';if(r.type==='cust'){nm=r.item.name;ph=r.item.phone;}else if(r.type==='store'){nm=r.item.name;}else{nm=r.item.brandName;ph=r.item.phone;}rows.push([i+1,r.type==='cust'?'ê³ ê°':r.type==='store'?'ì í¬':'ë¸Œëœë“œ',nm,ph,r.sub,r.date]);});const csv='\uFEFF'+rows.map(r=>r.map(c=>'"'+String(c||'').replace(/"/g,'""')+'"').join(',')).join('\n');const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8'}));a.download=`ê²€ìƒ‰ê²°ê³¼_${today()}.csv`;a.click();}
function resetS(){D.sq='';D.sScope='all';D.sField='all';D.sSort='newest';D.sRentMin='';D.sRentMax='';D.sDepositMin='';D.sDepositMax='';D.sPremiumMin='';D.sPremiumMax='';D.sAreaMin='';D.sAreaMax='';D.sCkMemo=false;D.sCkPhoto=false;D.sCkPhone=false;D.sCkConsult=false;D.sCkNoPremium=false;D.sCkToday=false;D.sCk7d=false;D.sCk30d=false;D.sCkDateFrom='';D.sCkDateTo='';R();}
function ck(f){return D[f]?'on':'';}

function renderSearch(el){const showAdv=D.sScope==='store'||D.sScope==='all';const any=D.sq||D.sScope!=='all'||D.sField!=='all'||D.sRentMin||D.sRentMax||D.sDepositMin||D.sDepositMax||D.sPremiumMin||D.sPremiumMax||D.sAreaMin||D.sAreaMax||D.sCkMemo||D.sCkPhoto||D.sCkPhone||D.sCkConsult||D.sCkNoPremium||D.sCkToday||D.sCk7d||D.sCk30d||D.sCkDateFrom||D.sCkDateTo;
const results=any?searchAll():[];
el.innerHTML=`<div style="font-size:18px;font-weight:900;color:var(--c);margin-bottom:12px">ğŸ” í†µí•© ê²€ìƒ‰</div>
<div class="c"><div class="c-b" style="padding-top:14px">
<input class="inp mb8" placeholder="ğŸ” ì´ë¦„, ì—°ë½ì²˜, ì£¼ì†Œ, ë©”ëª¨, #íƒœê·¸" value="${esc(D.sq)}" oninput="D.sq=this.value" onkeydown="if(event.key==='Enter')R()">
<div class="mb6" style="font-size:10px;font-weight:700;color:#999">ğŸ“‚ ë²”ìœ„</div>
<div class="chips mb8">${[['all','ì „ì²´'],['cust','ğŸ‘¥ê³ ê°'],['store','ğŸªì í¬'],['brand','ğŸ·ë¸Œëœë“œ']].map(([v,l])=>`<span class="chip${D.sScope===v?' on':''}" onclick="D.sScope='${v}';R()">${l}</span>`).join('')}</div>
<div class="mb6" style="font-size:10px;font-weight:700;color:#999">ğŸ· í•„ë“œ</div>
<div class="chips mb8">${[['all','ì „ì²´'],['name','ì´ë¦„'],['phone','ì—°ë½ì²˜'],['address','ì£¼ì†Œ'],['memo','ë©”ëª¨/ìƒë‹´'],['grade','ë“±ê¸‰'],['contact','ë‹´ë‹¹ì']].map(([v,l])=>`<span class="chip${D.sField===v?' on':''}" onclick="D.sField='${v}';R()">${l}</span>`).join('')}</div>
<div class="mb6" style="font-size:10px;font-weight:700;color:#999">âœ… ì¡°ê±´</div>
<div class="chips mb8"><span class="chip ${ck('sCkPhone')}" onclick="D.sCkPhone=!D.sCkPhone;R()">ğŸ“ì—°ë½ì²˜æœ‰</span><span class="chip ${ck('sCkMemo')}" onclick="D.sCkMemo=!D.sCkMemo;R()">ğŸ“ë©”ëª¨æœ‰</span><span class="chip ${ck('sCkConsult')}" onclick="D.sCkConsult=!D.sCkConsult;R()">ğŸ’¬ìƒë‹´æœ‰</span><span class="chip ${ck('sCkPhoto')}" onclick="D.sCkPhoto=!D.sCkPhoto;R()">ğŸ“·ì‚¬ì§„æœ‰</span><span class="chip ${ck('sCkNoPremium')}" onclick="D.sCkNoPremium=!D.sCkNoPremium;R()">ğŸ’°ê¶Œë¦¬ê¸ˆç„¡</span></div>
<div class="mb6" style="font-size:10px;font-weight:700;color:#999">ğŸ“… ê¸°ê°„</div>
<div class="chips mb6"><span class="chip ${ck('sCkToday')}" onclick="D.sCkToday=!D.sCkToday;D.sCk7d=false;D.sCk30d=false;R()">ì˜¤ëŠ˜</span><span class="chip ${ck('sCk7d')}" onclick="D.sCk7d=!D.sCk7d;D.sCkToday=false;D.sCk30d=false;R()">7ì¼</span><span class="chip ${ck('sCk30d')}" onclick="D.sCk30d=!D.sCk30d;D.sCkToday=false;D.sCk7d=false;R()">30ì¼</span></div>
<div class="row r2 mb8"><div><label class="lbl">ì‹œì‘ì¼</label><input class="inp" type="date" value="${D.sCkDateFrom}" onchange="D.sCkDateFrom=this.value;R()"></div><div><label class="lbl">ì¢…ë£Œì¼</label><input class="inp" type="date" value="${D.sCkDateTo}" onchange="D.sCkDateTo=this.value;R()"></div></div>
${showAdv?`<div class="mb6" style="font-size:10px;font-weight:700;color:#999">ğŸ“Š ìˆ«ìë²”ìœ„(ì í¬)</div><div class="row r2"><div><label class="lbl">í‰ìˆ˜min</label><input class="inp" value="${esc(D.sAreaMin)}" oninput="D.sAreaMin=this.value"></div><div><label class="lbl">í‰ìˆ˜max</label><input class="inp" value="${esc(D.sAreaMax)}" oninput="D.sAreaMax=this.value"></div></div><div class="row r2"><div><label class="lbl">ì„ëŒ€min</label><input class="inp" value="${esc(D.sRentMin)}" oninput="D.sRentMin=this.value"></div><div><label class="lbl">ì„ëŒ€max</label><input class="inp" value="${esc(D.sRentMax)}" oninput="D.sRentMax=this.value"></div></div><div class="row r2"><div><label class="lbl">ë³´ì¦min</label><input class="inp" value="${esc(D.sDepositMin)}" oninput="D.sDepositMin=this.value"></div><div><label class="lbl">ë³´ì¦max</label><input class="inp" value="${esc(D.sDepositMax)}" oninput="D.sDepositMax=this.value"></div></div><div class="row r2 mb8"><div><label class="lbl">ê¶Œë¦¬min</label><input class="inp" value="${esc(D.sPremiumMin)}" oninput="D.sPremiumMin=this.value"></div><div><label class="lbl">ê¶Œë¦¬max</label><input class="inp" value="${esc(D.sPremiumMax)}" oninput="D.sPremiumMax=this.value"></div></div>`:''}
<div class="mb6" style="font-size:10px;font-weight:700;color:#999">ğŸ”„ ì •ë ¬</div>
<div class="chips mb8">${[['newest','ìµœì‹ '],['oldest','ì˜¤ë˜ëœ'],['name','ì´ë¦„'],['rent_low','ì„ëŒ€â†‘'],['rent_high','ì„ëŒ€â†“'],['area_big','í‰ìˆ˜â†“']].map(([v,l])=>`<span class="chip${D.sSort===v?' on':''}" onclick="D.sSort='${v}';R()">${l}</span>`).join('')}</div>
<div class="fr"><button class="btn bp" style="flex:1" onclick="R()">ğŸ” ê²€ìƒ‰</button><button class="btn bg" onclick="resetS()">ì´ˆê¸°í™”</button></div>
</div></div>
${any?`<div class="c"><div class="c-h"><span>ê²°ê³¼ <b style="color:var(--c)">${results.length}ê±´</b></span><div class="fr">${results.filter(r=>r.type==='cust').length?`<button class="btn bo btn-sm" onclick="exportCustomers(searchAll().filter(r=>r.type==='cust').map(r=>r.item))">ğŸ‘¥(${results.filter(r=>r.type==='cust').length})</button>`:''} ${results.filter(r=>r.type==='store').length?`<button class="btn bo btn-sm" onclick="exportStores(searchAll().filter(r=>r.type==='store').map(r=>r.item))">ğŸª(${results.filter(r=>r.type==='store').length})</button>`:''}<button class="btn bo btn-sm" onclick="exportSR(searchAll())">ğŸ“±ì „ì²´</button></div></div>${results.length?results.map(r=>`<div class="item" onclick="goToItem('${r.type}','${r.item.id}')"><div class="item-no">${r.no}</div><div class="item-body"><div class="item-nm">${esc(r.label)}${r.item.grade&&r.item.grade!=='ì¼ë°˜'&&r.item.grade!=='ë¯¸ì •'?' <span class="badge" style="background:rgba(192,57,43,.08);color:var(--c)">'+r.item.grade+'</span>':''} ${stHTML(r.item.status)} ${tagsHTML(r.item.tags)}</div><div class="item-meta">${esc(r.sub)}</div><div class="item-date">${r.date}</div></div></div>`).join(''):'<div class="c-b"><div class="empty">ê²°ê³¼ ì—†ìŒ</div></div>'}</div>`:'<div class="empty">ê²€ìƒ‰ì–´ ë˜ëŠ” í•„í„° ì„¤ì •</div>'}
`;}

// â•â•â• CUSTOMER â•â•â•
function renderCustList(el){let list=D.customers;
if(D.fGrade!=='all')list=list.filter(c=>c.grade===D.fGrade);
if(D.fCStatus&&D.fCStatus!=='all')list=list.filter(c=>(c.status||'ì‹ ê·œ')===D.fCStatus);
if(D.search){const q=D.search.toLowerCase();list=list.filter(c=>[c.name,c.phone,c.region,c.bizType,c.interests,c.budget,c.wantArea,c.grade,c.status,c.dbCat,...(c.tags||[]),...(c.memos||[]).map(m=>m.text),...(c.consultHistory||[]).map(h=>h.content+' '+h.result)].some(v=>(v||'').toLowerCase().includes(q)));}
if(D.cfRegion)list=list.filter(c=>(c.region||'').includes(D.cfRegion));
if(D.cfBizType)list=list.filter(c=>(c.bizType||'').includes(D.cfBizType)||(c.interests||'').includes(D.cfBizType));
if(D.cfBudgetMin||D.cfBudgetMax){list=list.filter(c=>{const v=numVal(c.budget);if(!v)return false;if(D.cfBudgetMin&&v<numVal(D.cfBudgetMin))return false;if(D.cfBudgetMax&&v>numVal(D.cfBudgetMax))return false;return true;});}
if(D.cfAreaMin||D.cfAreaMax){list=list.filter(c=>{const v=parseInt(c.wantArea)||0;if(!v)return false;if(D.cfAreaMin&&v<parseInt(D.cfAreaMin))return false;if(D.cfAreaMax&&v>parseInt(D.cfAreaMax))return false;return true;});}
if(D.fCustCat&&D.fCustCat!=='all')list=list.filter(c=>(c.dbCat||'')===D.fCustCat);
window._custList=list;if(!D.selCust)D.selCust={};const hasF=D.cfRegion||D.cfBizType||D.cfBudgetMin||D.cfBudgetMax||D.cfAreaMin||D.cfAreaMax;
const selN=list.filter(c=>D.selCust[c.id]).length;const allSel=list.length>0&&selN===list.length;
el.innerHTML=`<div class="fb mb10"><div style="font-size:18px;font-weight:900">ğŸ‘¥ ê³ ê° <span style="font-size:12px;color:var(--sub)">${list.length}/${D.customers.length}</span></div><div class="fr"><button class="btn bo btn-sm" onclick="exportCustomers(window._custList)">ğŸ“±ì—‘ì…€(${list.length})</button><button class="btn bp" onclick="addCust()">+ ì¶”ê°€</button></div></div>
<input class="inp mb8" placeholder="ğŸ” ì´ë¦„, ì—°ë½ì²˜, ì§€ì—­, ì—…ì¢…" value="${esc(D.search)}" oninput="D.search=this.value;R()">
<div class="chips mb6">${['all',...GRADES].map(g=>`<span class="chip${D.fGrade===g?' on':''}" onclick="D.fGrade='${g}';R()">${g==='all'?'ì „ì²´':g}</span>`).join('')}</div>
<div class="chips mb6">${['all',...CSTATUS].map(s=>`<span class="chip${(D.fCStatus||'all')===s?' on':''}" onclick="D.fCStatus='${s}';R()">${s==='all'?'ì „ì²´':s}</span>`).join('')}</div>
${(D.custCats&&D.custCats.length)?`<div class="chips mb6"><span class="chip${D.fCustCat==='all'?' on':''}" onclick="D.fCustCat='all';R()">ğŸ“‚ì „ì²´</span>${D.custCats.map(cat=>`<span class="chip${D.fCustCat===cat?' on':''}" onclick="D.fCustCat='${cat}';R()">${cat}</span>`).join('')}</div>`:''}
<div class="c mb10"><div class="c-h" style="cursor:pointer" onclick="D.cfOpen=!D.cfOpen;R()"><span>ğŸ” ìƒì„¸í•„í„°${hasF?' <b style=color:var(--c)>ì ìš©ì¤‘</b>':''}</span><span style="font-size:12px">${D.cfOpen?'â–²':'â–¼'}</span></div>${D.cfOpen?`<div class="c-b">
<div class="row r2"><div><label class="lbl">ì§€ì—­</label><input class="inp" value="${esc(D.cfRegion)}" oninput="D.cfRegion=this.value;R()" placeholder="ê°•ë‚¨, ë§ˆí¬"></div><div><label class="lbl">í¬ë§ì—…ì¢…</label><input class="inp" value="${esc(D.cfBizType)}" oninput="D.cfBizType=this.value;R()" placeholder="ì¹´í˜, ì¹˜í‚¨"></div></div>
<div class="row r2"><div><label class="lbl">ì˜ˆì‚° min</label><input class="inp" value="${esc(D.cfBudgetMin)}" oninput="D.cfBudgetMin=this.value;R()" placeholder="5000ë§Œ"></div><div><label class="lbl">ì˜ˆì‚° max</label><input class="inp" value="${esc(D.cfBudgetMax)}" oninput="D.cfBudgetMax=this.value;R()" placeholder="2ì–µ"></div></div>
<div class="row r2"><div><label class="lbl">í‰ìˆ˜ min</label><input class="inp" value="${esc(D.cfAreaMin)}" oninput="D.cfAreaMin=this.value;R()" placeholder="20"></div><div><label class="lbl">í‰ìˆ˜ max</label><input class="inp" value="${esc(D.cfAreaMax)}" oninput="D.cfAreaMax=this.value;R()" placeholder="50"></div></div>
<button class="btn bg btn-sm mt8" onclick="D.cfRegion='';D.cfBizType='';D.cfBudgetMin='';D.cfBudgetMax='';D.cfAreaMin='';D.cfAreaMax='';R()">í•„í„° ì´ˆê¸°í™”</button>
</div>`:''}</div>
${list.length?`<div class="sel-bar"><label class="sel-all" onclick="toggleAllCust(${allSel?0:1})"><span class="ckb ${allSel?'on':''}"></span> ì „ì²´</label><span style="font-size:10px;color:var(--sub)">${selN}ëª…</span><div class="fr">${selN?`<button class="btn bp btn-sm" onclick="openSMS()">ğŸ“© ë¬¸ì(${selN})</button><button class="btn bo btn-sm" onclick="exportSelCust()">ğŸ“±(${selN})</button>`:'<span style="font-size:9px;color:#ccc">ì„ íƒ ì‹œ ë¬¸ì</span>'}</div></div><div class="c">`+list.map(c=>{const sel=D.selCust[c.id];return`<div class="item"><div class="ckb ${sel?'on':''}" onclick="event.stopPropagation();toggleSelCust('${c.id}')"></div><div class="item-body" onclick="addAct('customers','${c.id}','ì¡°íšŒ');D.editId='${c.id}';R()"><div class="item-nm">${esc(c.name)||'(ë¯¸ì…ë ¥)'}${c.grade!=='ì¼ë°˜'?'<span class="badge" style="background:#FFF3CD;color:#856404">'+c.grade+'</span>':''}${c.dbCat?'<span class="badge" style="background:#E3F2FD;color:#1565C0">ğŸ“‚'+c.dbCat+'</span>':''}${stHTML(c.status)}${actBadge(c)}</div><div class="item-meta">${phoneHTML(c.phone)}${c.region?' Â· ğŸ“'+esc(c.region):''}${c.bizType?' Â· ğŸ·'+esc(c.bizType):''}${c.budget?' Â· ğŸ’°'+esc(c.budget):''}</div><div class="item-meta">ë©”ëª¨${c.memos?.length||0} Â· ìƒë‹´${c.consultHistory?.length||0}${c.followUp?' Â· â°'+c.followUp:''} ${tagsHTML(c.tags)}</div><div class="item-date">${c.createdAt}</div></div></div>`;}).join('')+'</div>':'<div class="empty">ê³ ê°ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”</div>'}`;}

function renderCustEdit(el){const c=D.customers.find(x=>x.id===D.editId);if(!c){D.editId=null;R();return;}const no=D.customers.indexOf(c)+1;
el.innerHTML=`<div class="fb mb12"><button class="btn bg" onclick="D.editId=null;D.fCStatus='all';R()">â† ëª©ë¡</button><div class="fr"><span style="font-size:12px;font-weight:800;color:var(--c)">No.${no} ${actBadge(c)}</span>${c.phone?`<button class="btn btn-sm" style="background:#E65100;color:#fff" onclick="sendOneSMS('${c.id}')">ğŸ“©</button><a class="btn btn-sm" style="background:#2E7D32;color:#fff;text-decoration:none" href="tel:${c.phone}">ğŸ“</a>`:''}<button class="btn bd btn-sm" onclick="delItem('customers','${c.id}')">ì‚­ì œ</button></div></div>
<div class="c"><div class="c-h" style="color:var(--c)">ê¸°ë³¸ ì •ë³´</div><div class="c-b">
<div class="row r3"><div><label class="lbl">ì´ë¦„</label><input class="inp" value="${esc(c.name)}" onchange="updItem('customers','${c.id}','name',this.value)"></div><div><label class="lbl">ë“±ê¸‰</label><select class="inp" onchange="updItemR('customers','${c.id}','grade',this.value)">${GRADES.map(g=>`<option${c.grade===g?' selected':''}>${g}</option>`).join('')}</select></div><div><label class="lbl">ìƒíƒœ</label><select class="inp" onchange="updItemR('customers','${c.id}','status',this.value)">${CSTATUS.map(s=>`<option${(c.status||'ì‹ ê·œ')===s?' selected':''}>${s}</option>`).join('')}</select></div></div>
<div class="row r2"><div><label class="lbl">ì—°ë½ì²˜</label><input class="inp" value="${esc(c.phone)}" onchange="updItem('customers','${c.id}','phone',this.value)"></div><div><label class="lbl">â° íŒ”ë¡œì—…</label><input class="inp" type="date" value="${c.followUp||''}" onchange="updItemR('customers','${c.id}','followUp',this.value)"></div></div>
<div class="row r2"><div><label class="lbl">ì§€ì—­</label><input class="inp" value="${esc(c.region||'')}" onchange="updItem('customers','${c.id}','region',this.value)" placeholder="ê°•ë‚¨êµ¬"></div><div><label class="lbl">ì°½ì—…ì˜ˆì‚°</label><input class="inp" value="${esc(c.budget||'')}" onchange="updItem('customers','${c.id}','budget',this.value)" placeholder="1ì–µ"></div></div>
<div class="row r2"><div><label class="lbl">í¬ë§ì—…ì¢…</label><input class="inp" value="${esc(c.bizType||'')}" onchange="updItem('customers','${c.id}','bizType',this.value)" placeholder="ì¹´í˜, ì¹˜í‚¨"></div><div><label class="lbl">í¬ë§í‰ìˆ˜</label><input class="inp" value="${esc(c.wantArea||'')}" onchange="updItem('customers','${c.id}','wantArea',this.value)" placeholder="20~35"></div></div>
<div class="row"><label class="lbl">ê´€ì‹¬ ë¸Œëœë“œ/ë§¤ë¬¼</label><input class="inp" value="${esc(c.interests||'')}" onchange="updItem('customers','${c.id}','interests',this.value)" placeholder="ë§˜ìŠ¤í„°ì¹˜, ë¹½ë‹¤ë°©, ê°•ë‚¨ì—­ 35í‰ ë“±"></div>
<div class="row"><label class="lbl">ğŸ“‚ ì†Œì† DB</label><select class="inp" onchange="if(this.value==='__add'){this.value='';addCat('cust');return;}updItemR('customers','${c.id}','dbCat',this.value)"><option value="">ë¯¸ë¶„ë¥˜</option>${(D.custCats||[]).map(cat=>`<option${c.dbCat===cat?' selected':''}>${cat}</option>`).join('')}<option value="__add">+ ìƒˆ ì¹´í…Œê³ ë¦¬</option></select></div>
<div style="font-size:10px;color:#ccc;margin-top:8px">ë“±ë¡: ${c.createdAt} ${tagsHTML(c.tags)}</div>
</div></div>${linksHTML('cust',c)}${memoHTML('customers',c)}${consultHTML(c)}${actHTML(c)}`;}

// â•â•â• STORE â•â•â•
function renderStoreList(el){let list=D.stores;
if(D.fSGrade!=='all')list=list.filter(s=>s.grade===D.fSGrade);
if(D.fSStatus&&D.fSStatus!=='all')list=list.filter(s=>(s.status||'ê³µì‹¤')===D.fSStatus);
if(D.search){const q=D.search.toLowerCase();list=list.filter(s=>[s.name,s.address,s.district,s.floor,s.area,s.rent,s.maintenance,s.deposit,s.premium,s.grade,s.status,s.dbCat,s.marketRent,s.marketDeposit,...(s.tags||[]),...(s.memos||[]).map(m=>m.text)].some(v=>(v||'').toLowerCase().includes(q)));}
if(D.sfDistrict)list=list.filter(s=>(s.district||'').includes(D.sfDistrict)||(s.address||'').includes(D.sfDistrict));
if(D.sfFloor)list=list.filter(s=>(s.floor||'').includes(D.sfFloor));
if(D.sfRentMin||D.sfRentMax){list=list.filter(s=>{const v=numVal(s.rent);if(!v)return!D.sfRentMin;if(D.sfRentMin&&v<numVal(D.sfRentMin))return false;if(D.sfRentMax&&v>numVal(D.sfRentMax))return false;return true;});}
if(D.sfDepositMin||D.sfDepositMax){list=list.filter(s=>{const v=numVal(s.deposit);if(!v)return!D.sfDepositMin;if(D.sfDepositMin&&v<numVal(D.sfDepositMin))return false;if(D.sfDepositMax&&v>numVal(D.sfDepositMax))return false;return true;});}
if(D.sfPremiumMin||D.sfPremiumMax){list=list.filter(s=>{const v=numVal(s.premium);if(D.sfPremiumMin&&v<numVal(D.sfPremiumMin))return false;if(D.sfPremiumMax&&v>numVal(D.sfPremiumMax))return false;return true;});}
if(D.sfAreaMin||D.sfAreaMax){list=list.filter(s=>{const v=parseInt(s.area)||0;if(!v)return!D.sfAreaMin;if(D.sfAreaMin&&v<parseInt(D.sfAreaMin))return false;if(D.sfAreaMax&&v>parseInt(D.sfAreaMax))return false;return true;});}
if(D.fStoreCat&&D.fStoreCat!=='all')list=list.filter(s=>(s.dbCat||'')===D.fStoreCat);
window._storeList=list;const hasF=D.sfDistrict||D.sfFloor||D.sfRentMin||D.sfRentMax||D.sfDepositMin||D.sfDepositMax||D.sfPremiumMin||D.sfPremiumMax||D.sfAreaMin||D.sfAreaMax;
el.innerHTML=`<div class="fb mb10"><div style="font-size:18px;font-weight:900">ğŸª ì í¬ <span style="font-size:12px;color:var(--sub)">${list.length}/${D.stores.length}</span></div><div class="fr">${D.compareIds.length>=2?`<button class="btn bgreen btn-sm" onclick="showCompare()">âš–ï¸ë¹„êµ(${D.compareIds.length})</button>`:''}<button class="btn bo btn-sm" onclick="exportStores(window._storeList)">ğŸ“±ì—‘ì…€(${list.length})</button><button class="btn bp" onclick="addStore()">+ ì¶”ê°€</button></div></div>
<input class="inp mb8" placeholder="ğŸ” ì í¬ëª…, ì£¼ì†Œ, ì§€ì—­êµ¬" value="${esc(D.search)}" oninput="D.search=this.value;R()">
<div class="chips mb6">${['all',...SGRADES].map(g=>`<span class="chip${D.fSGrade===g?' on':''}" onclick="D.fSGrade='${g}';R()">${g==='all'?'ì „ì²´':g}</span>`).join('')}</div>
<div class="chips mb6">${['all',...SSTATUS].map(s=>`<span class="chip${(D.fSStatus||'all')===s?' on':''}" onclick="D.fSStatus='${s}';R()">${s==='all'?'ì „ì²´':s}</span>`).join('')}</div>
${(D.storeCats&&D.storeCats.length)?`<div class="chips mb6"><span class="chip${D.fStoreCat==='all'?' on':''}" onclick="D.fStoreCat='all';R()">ğŸ“‚ì „ì²´</span>${D.storeCats.map(cat=>`<span class="chip${D.fStoreCat===cat?' on':''}" onclick="D.fStoreCat='${cat}';R()">${cat}</span>`).join('')}</div>`:''}
<div class="c mb10"><div class="c-h" style="cursor:pointer" onclick="D.sfOpen=!D.sfOpen;R()"><span>ğŸ” ìƒì„¸í•„í„°${hasF?' <b style=color:var(--c)>ì ìš©ì¤‘</b>':''}</span><span style="font-size:12px">${D.sfOpen?'â–²':'â–¼'}</span></div>${D.sfOpen?`<div class="c-b">
<div class="row r2"><div><label class="lbl">ì§€ì—­êµ¬</label><input class="inp" value="${esc(D.sfDistrict)}" oninput="D.sfDistrict=this.value;R()" placeholder="ê°•ë‚¨, ë§ˆí¬"></div><div><label class="lbl">ì¸µìˆ˜</label><input class="inp" value="${esc(D.sfFloor)}" oninput="D.sfFloor=this.value;R()" placeholder="1ì¸µ, B1"></div></div>
<div class="row r2"><div><label class="lbl">í‰ìˆ˜ min</label><input class="inp" value="${esc(D.sfAreaMin)}" oninput="D.sfAreaMin=this.value;R()" placeholder="20"></div><div><label class="lbl">í‰ìˆ˜ max</label><input class="inp" value="${esc(D.sfAreaMax)}" oninput="D.sfAreaMax=this.value;R()" placeholder="50"></div></div>
<div class="row r2"><div><label class="lbl">ì„ëŒ€ë£Œ min</label><input class="inp" value="${esc(D.sfRentMin)}" oninput="D.sfRentMin=this.value;R()" placeholder="200ë§Œ"></div><div><label class="lbl">ì„ëŒ€ë£Œ max</label><input class="inp" value="${esc(D.sfRentMax)}" oninput="D.sfRentMax=this.value;R()" placeholder="500ë§Œ"></div></div>
<div class="row r2"><div><label class="lbl">ë³´ì¦ê¸ˆ min</label><input class="inp" value="${esc(D.sfDepositMin)}" oninput="D.sfDepositMin=this.value;R()" placeholder="3000ë§Œ"></div><div><label class="lbl">ë³´ì¦ê¸ˆ max</label><input class="inp" value="${esc(D.sfDepositMax)}" oninput="D.sfDepositMax=this.value;R()" placeholder="1ì–µ"></div></div>
<div class="row r2"><div><label class="lbl">ê¶Œë¦¬ê¸ˆ min</label><input class="inp" value="${esc(D.sfPremiumMin)}" oninput="D.sfPremiumMin=this.value;R()" placeholder="ì—†ìŒ"></div><div><label class="lbl">ê¶Œë¦¬ê¸ˆ max</label><input class="inp" value="${esc(D.sfPremiumMax)}" oninput="D.sfPremiumMax=this.value;R()" placeholder="1ì–µ"></div></div>
<button class="btn bg btn-sm mt8" onclick="D.sfDistrict='';D.sfFloor='';D.sfRentMin='';D.sfRentMax='';D.sfDepositMin='';D.sfDepositMax='';D.sfPremiumMin='';D.sfPremiumMax='';D.sfAreaMin='';D.sfAreaMax='';R()">í•„í„° ì´ˆê¸°í™”</button>
</div>`:''}</div>
${list.length?'<div class="c">'+list.map(s=>{const no=D.stores.indexOf(s)+1;let info=[];if(s.district)info.push('ğŸ“'+s.district);if(s.floor)info.push(s.floor);if(s.area)info.push(s.area+'í‰');if(s.rent)info.push('ì„ëŒ€'+fW(s.rent));if(s.deposit)info.push('ë³´ì¦'+fW(s.deposit));const myR=numVal(s.rent);const mkR=numVal(s.marketRent);if(myR&&mkR){const d=myR-mkR;const p=Math.round((d/mkR)*100);info.push(d<=0?'<span style="color:#2E7D32;font-weight:800">âœ…â†“'+Math.abs(p)+'%</span>':'<span style="color:#C0392B;font-weight:800">âš ï¸â†‘'+p+'%</span>');}const sel=D.compareIds.includes(s.id);
return`<div class="item" onclick="addAct('stores','${s.id}','ì¡°íšŒ');D.editId='${s.id}';R()"><div class="item-no">${no}</div><div class="item-body"><div class="item-nm">${esc(s.name)||'(ë¯¸ì…ë ¥)'}${s.grade&&s.grade!=='ë¯¸ì •'?' <span class="grade-store grade-'+s.grade[0]+'">'+s.grade+'</span>':''}${stHTML(s.status)}${actBadge(s)}${s.photos?.length?' ğŸ“·'+s.photos.length:''}${s.files?.length?' ğŸ“'+s.files.length:''}</div><div class="item-meta">${info.join(' Â· ')||'-'} ${tagsHTML(s.tags)}</div>${s.address?'<div class="item-meta">'+esc(s.address)+' <span class="quick-links" onclick="event.stopPropagation()"><a href="https://new.land.naver.com/search?keyword='+encodeURIComponent(s.address)+'" target="_blank">ğŸ </a><a href="https://www.iros.go.kr/PMainJ.jsp" target="_blank">ğŸ“‹</a><a href="https://map.naver.com/v5/search/'+encodeURIComponent(s.address)+'" target="_blank">ğŸ—º</a></span></div>':''}<div class="item-date">${s.createdAt}${s.followUp?' Â· â°'+s.followUp:''}</div></div><button class="btn-sm ${sel?'bp':'bg'}" onclick="event.stopPropagation();toggleCompare('${s.id}')" style="flex-shrink:0;margin-top:4px">${sel?'âœ“':'âš–ï¸'}</button></div>`;}).join('')+'</div>':'<div class="empty">ì í¬ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”</div>'}`;}

function toggleCompare(id){if(D.compareIds.includes(id))D.compareIds=D.compareIds.filter(x=>x!==id);else if(D.compareIds.length<4)D.compareIds.push(id);R();}
function showCompare(){const stores=D.compareIds.map(id=>D.stores.find(s=>s.id===id)).filter(Boolean);if(stores.length<2)return;
const vals=stores.map(s=>({n:s.name||'ë¯¸ì…ë ¥',rent:numVal(s.rent),maint:numVal(s.maintenance),dep:numVal(s.deposit),prem:numVal(s.premium),area:parseInt(s.area)||0,total:numVal(s.rent)+numVal(s.maintenance),init:numVal(s.deposit)+numVal(s.premium),grade:s.grade||'ë¯¸ì •',floor:s.floor||'-',district:s.district||'-',status:s.status||'ê³µì‹¤'}));
function best(arr,key,low){const vs=arr.map(v=>v[key]).filter(v=>v>0);if(!vs.length)return-1;const t=low?Math.min(...vs):Math.max(...vs);return arr.findIndex(v=>v[key]===t);}
function worst(arr,key,low){const vs=arr.map(v=>v[key]).filter(v=>v>0);if(!vs.length)return-1;const t=low?Math.max(...vs):Math.min(...vs);return arr.findIndex(v=>v[key]===t);}
const rentPer=vals.map(v=>v.area>0&&v.rent>0?Math.round(v.rent/v.area):0);
const pros=vals.map((v,i)=>{const p=[];
if(best(vals,'total',true)===i)p.push('ğŸ’° ì›”ë¹„ìš© ìµœì €');
if(best(vals,'init',true)===i)p.push('ğŸ’µ ì´ˆê¸°íˆ¬ì ìµœì €');
if(best(vals,'area',false)===i)p.push('ğŸ“ ë©´ì  ìµœëŒ€');
if(rentPer[i]>0&&rentPer.filter(x=>x>0).length>1&&rentPer[i]===Math.min(...rentPer.filter(x=>x>0)))p.push('ğŸ“Š í‰ë‹¹ì„ëŒ€ ìµœì €');
if(v.grade==='Aê¸‰')p.push('â­ Aê¸‰');
if(v.floor&&(v.floor.includes('1ì¸µ')||v.floor==='1ì¸µ'))p.push('ğŸšª 1ì¸µ');
return p;});
const cons=vals.map((v,i)=>{const c=[];
if(worst(vals,'total',true)===i&&vals.filter(x=>x.total>0).length>1)c.push('ì›”ë¹„ìš© ìµœê³ ');
if(worst(vals,'init',true)===i&&vals.filter(x=>x.init>0).length>1)c.push('ì´ˆê¸°íˆ¬ì ìµœê³ ');
if(worst(vals,'area',false)===i&&vals.filter(x=>x.area>0).length>1)c.push('ë©´ì  ìµœì†Œ');
if(v.grade==='Cê¸‰')c.push('Cê¸‰');
if(v.floor&&v.floor.includes('B'))c.push('ì§€í•˜');
return c;});
const maxT=Math.max(...vals.map(v=>v.total||1));const maxI=Math.max(...vals.map(v=>v.init||1));const maxA=Math.max(...vals.map(v=>v.area||1));
const scores=vals.map(v=>{const gS=v.grade==='Aê¸‰'?0:v.grade==='Bê¸‰'?50:100;return Math.round((v.total/maxT)*40+(v.init/maxI)*30+((maxA-v.area)/maxA)*20+gS*0.1);});
const bestIdx=scores.indexOf(Math.min(...scores));
const comments=[];
if(vals.length>=2){const s0=vals[0],s1=vals[1];
if(s0.total>0&&s1.total>0){const d=s0.total-s1.total;if(Math.abs(d)>100000)comments.push(`ì›”ë¹„ìš©: <b>${d>0?s1.n:s0.n}</b>ì´ ${fW(Math.abs(d))}ì› ì €ë ´`);}
if(s0.init>0&&s1.init>0){const d=s0.init-s1.init;if(Math.abs(d)>1000000)comments.push(`ì´ˆê¸°íˆ¬ì: <b>${d>0?s1.n:s0.n}</b>ì´ ${fW(Math.abs(d))}ì› ì ìŒ`);}
if(s0.area>0&&s1.area>0&&s0.area!==s1.area)comments.push(`ë©´ì : <b>${s0.area>s1.area?s0.n:s1.n}</b>ì´ ${Math.abs(s0.area-s1.area)}í‰ ë„“ìŒ`);}
$('modal').innerHTML=`<div class="modal-overlay" onclick="$('modal').innerHTML=''"><div class="modal-box" style="max-width:95vw;max-height:90vh;overflow-y:auto" onclick="event.stopPropagation()">
<div style="font-size:16px;font-weight:900;margin-bottom:14px">âš–ï¸ ì í¬ ë¹„êµ ë¶„ì„</div>
<div class="compare-grid" style="grid-template-columns:70px repeat(${stores.length},1fr)">
<div class="compare-cell hd">í•­ëª©</div>${stores.map((s,i)=>`<div class="compare-cell hd" style="color:${bestIdx===i?'#2E7D32':'var(--c)'};${bestIdx===i?'background:#E8F5E9':''}"><div style="font-size:11px">${esc(s.name)}</div>${bestIdx===i?'<div style="font-size:9px;margin-top:2px">â­ì¶”ì²œ</div>':''}</div>`).join('')}
${[['ì§€ì—­êµ¬','district','',false],['ì¸µìˆ˜','floor','',false],['í‰ìˆ˜','area','í‰',false],['ì„ëŒ€ë£Œ','rent','',true],['ê´€ë¦¬ë¹„','maintenance','',true],['ë³´ì¦ê¸ˆ','deposit','',true],['ê¶Œë¦¬ê¸ˆ','premium','',true],['ë“±ê¸‰','grade','',false],['ìƒíƒœ','status','',false]].map(([l,k,u,isMoney])=>{
const numVals=stores.map(s=>numVal(s[k]));const hasNum=numVals.some(v=>v>0);
const minI=hasNum&&isMoney?numVals.indexOf(Math.min(...numVals.filter(v=>v>0))):-1;
const maxI=hasNum&&isMoney?numVals.indexOf(Math.max(...numVals.filter(v=>v>0))):-1;
return`<div class="compare-cell hd">${l}</div>${stores.map((s,i)=>{
const v=k==='grade'||k==='status'||k==='district'||k==='floor'?s[k]||'-':(fW(s[k])||s[k]||'-')+(u&&s[k]?u:'');
let st='';if(isMoney&&minI===i&&minI!==maxI)st='color:#2E7D32;font-weight:700';if(isMoney&&maxI===i&&minI!==maxI)st='color:#C0392B;font-weight:700';if(k==='grade'&&s.grade==='Aê¸‰')st='color:#2E7D32;font-weight:700';
return`<div class="compare-cell" style="${st}">${v}</div>`;}).join('')}`;}).join('')}
<div class="compare-cell hd" style="background:#FFF3CD">ì›”ì´ë¹„ìš©</div>${stores.map((s,i)=>{const t=numVal(s.rent)+numVal(s.maintenance);const isMin=best(vals,'total',true)===i;return`<div class="compare-cell" style="font-weight:900;${isMin?'color:#2E7D32;background:#E8F5E9':'color:var(--c)'}">${fW(t)||'-'}ì›</div>`;}).join('')}
<div class="compare-cell hd" style="background:#FFF3CD">ì´ˆê¸°íˆ¬ì</div>${stores.map((s,i)=>{const t=numVal(s.deposit)+numVal(s.premium);const isMin=best(vals,'init',true)===i;return`<div class="compare-cell" style="font-weight:900;${isMin?'color:#2E7D32;background:#E8F5E9':'color:var(--c)'}">${fW(t)||'-'}ì›</div>`;}).join('')}
${rentPer.some(v=>v>0)?`<div class="compare-cell hd" style="background:#E3F2FD">í‰ë‹¹ì„ëŒ€</div>${rentPer.map((v,i)=>{const isMin=v>0&&v===Math.min(...rentPer.filter(x=>x>0));return`<div class="compare-cell" style="font-weight:700;${isMin?'color:#2E7D32':'color:#666'}">${v?fW(v)+'ì›/í‰':'-'}</div>`;}).join('')}`:''}
</div>
<div style="margin-top:14px">
${stores.map((s,i)=>`<div style="margin-bottom:8px;padding:10px;border-radius:10px;background:${bestIdx===i?'#E8F5E9':'#F9F9F9'};border:1px solid ${bestIdx===i?'#A5D6A7':'#eee'}">
<div style="font-weight:800;font-size:12px;color:${bestIdx===i?'#2E7D32':'#333'}">${bestIdx===i?'â­ ':''}${esc(s.name)}</div>
${pros[i].length?'<div style="font-size:10px;color:#2E7D32;margin-top:2px">ğŸ‘ '+pros[i].join(' Â· ')+'</div>':''}
${cons[i].length?'<div style="font-size:10px;color:#C0392B;margin-top:1px">ğŸ‘ '+cons[i].join(' Â· ')+'</div>':''}
</div>`).join('')}
</div>
${comments.length?`<div style="margin-top:8px;padding:10px;background:#FFF8E1;border-radius:10px;border:1px solid #FFE082"><div style="font-weight:800;font-size:11px;color:#F57F17;margin-bottom:4px">ğŸ“Š í•µì‹¬ ë¹„êµ</div>${comments.map(c=>`<div style="font-size:10px;color:#333;margin-bottom:2px">â€¢ ${c}</div>`).join('')}</div>`:''}
<button class="btn bg bf mt12" onclick="D.compareIds=[];$('modal').innerHTML='';R()">ë¹„êµ í•´ì œ</button>
</div></div>`;}

function renderStoreEdit(el){const s=D.stores.find(x=>x.id===D.editId);if(!s){D.editId=null;R();return;}const no=D.stores.indexOf(s)+1;
el.innerHTML=`<div class="fb mb12"><button class="btn bg" onclick="D.editId=null;D.fSStatus='all';R()">â† ëª©ë¡</button><div class="fr"><span style="font-size:12px;font-weight:800;color:var(--c)">No.${no} ${actBadge(s)}</span><button class="btn bo btn-sm" onclick="genPDF('${s.id}')">ğŸ“„PDF</button><button class="btn bd btn-sm" onclick="delItem('stores','${s.id}')">ì‚­ì œ</button></div></div>
<div class="c"><div class="c-h" style="color:var(--c)">ì í¬ ì •ë³´</div><div class="c-b">
<div class="row r3"><div style="grid-column:1/3"><label class="lbl">ì í¬ëª…</label><input class="inp" value="${esc(s.name)}" onchange="updItem('stores','${s.id}','name',this.value)"></div><div><label class="lbl">ë“±ê¸‰</label><select class="inp" onchange="updItemR('stores','${s.id}','grade',this.value)">${SGRADES.map(g=>`<option${s.grade===g?' selected':''}>${g}</option>`).join('')}</select></div></div>
<div class="row r2"><div><label class="lbl">ìƒíƒœ</label><select class="inp" onchange="updItemR('stores','${s.id}','status',this.value)">${SSTATUS.map(st=>`<option${(s.status||'ê³µì‹¤')===st?' selected':''}>${st}</option>`).join('')}</select></div><div><label class="lbl">â° íŒ”ë¡œì—…</label><input class="inp" type="date" value="${s.followUp||''}" onchange="updItemR('stores','${s.id}','followUp',this.value)"></div></div>
<div class="row"><label class="lbl">ğŸ“‚ ì†Œì† DB</label><select class="inp" onchange="if(this.value==='__add'){this.value='';addCat('store');return;}updItemR('stores','${s.id}','dbCat',this.value)"><option value="">ë¯¸ë¶„ë¥˜</option>${(D.storeCats||[]).map(cat=>`<option${s.dbCat===cat?' selected':''}>${cat}</option>`).join('')}<option value="__add">+ ìƒˆ ì¹´í…Œê³ ë¦¬</option></select></div>
<div class="row r2"><div><label class="lbl">ì£¼ì†Œ</label><input class="inp" value="${esc(s.address)}" onchange="updAddr('${s.id}',this.value)"></div><div><label class="lbl">ì§€ì—­êµ¬</label><input class="inp" value="${esc(s.district||'')}" onchange="updItem('stores','${s.id}','district',this.value)" placeholder="ê°•ë‚¨êµ¬"></div></div>${s.address?mapBtns(s.address):''}
<div class="row r3 mt8"><div><label class="lbl">ì¸µìˆ˜</label><input class="inp" value="${esc(s.floor||'')}" onchange="updItem('stores','${s.id}','floor',this.value)" placeholder="1ì¸µ, B1"></div><div><label class="lbl">í‰ìˆ˜</label><input class="inp" value="${esc(s.area)}" onchange="updItem('stores','${s.id}','area',this.value)"></div><div><label class="lbl">ì„ëŒ€ë£Œ(ì›”)</label><input class="inp" value="${esc(s.rent)}" onchange="updItem('stores','${s.id}','rent',this.value)"></div></div>
<div class="row r2"><div><label class="lbl">ê´€ë¦¬ë¹„(ì›”)</label><input class="inp" value="${esc(s.maintenance)}" onchange="updItem('stores','${s.id}','maintenance',this.value)"></div><div><label class="lbl">ë³´ì¦ê¸ˆ</label><input class="inp" value="${esc(s.deposit)}" onchange="updItem('stores','${s.id}','deposit',this.value)"></div></div>
<div class="row r2"><div><label class="lbl">ê¶Œë¦¬ê¸ˆ</label><input class="inp" value="${esc(s.premium)}" onchange="updItem('stores','${s.id}','premium',this.value)"></div><div><label class="lbl">ì›”ì´ë¹„ìš©</label><div class="inp" style="background:#f9f9f9;font-weight:800;color:var(--c)">${fW(numVal(s.rent)+numVal(s.maintenance))}ì›</div></div></div>
</div></div>
${(()=>{const myRent=numVal(s.rent);const mktRent=numVal(s.marketRent);const myDep=numVal(s.deposit);const mktDep=numVal(s.marketDeposit);
const rentDiff=myRent&&mktRent?myRent-mktRent:0;const depDiff=myDep&&mktDep?myDep-mktDep:0;
const rentPct=myRent&&mktRent?Math.round((rentDiff/mktRent)*100):0;const depPct=myDep&&mktDep?Math.round((depDiff/mktDep)*100):0;
return`<div class="c" style="border:1.5px solid #42A5F5"><div class="c-h" style="color:#0D47A1;background:#E3F2FD;border:none">ğŸ“Š ì£¼ë³€ ì‹œì„¸ ë¹„êµ ${s.address?'<a href="https://new.land.naver.com/search?keyword='+encodeURIComponent(s.address)+'" target="_blank" style="font-size:10px;color:#03C75A;text-decoration:none;font-weight:800;float:right">ğŸ  ë„¤ì´ë²„ë¶€ë™ì‚° â†’</a>':''}</div><div class="c-b">
<div style="font-size:9px;color:#999;margin-bottom:8px">ë„¤ì´ë²„ë¶€ë™ì‚° ì‹œì„¸ í™•ì¸ â†’ ì•„ë˜ ì…ë ¥ â†’ ìë™ ë¹„êµ</div>
<div class="row r2"><div><label class="lbl">ì£¼ë³€ ì„ëŒ€ì‹œì„¸(ì›”)</label><input class="inp" value="${esc(s.marketRent||'')}" onchange="updItem('stores','${s.id}','marketRent',this.value)" placeholder="ì‹œì„¸ ì…ë ¥"></div><div><label class="lbl">ì£¼ë³€ ë³´ì¦ê¸ˆì‹œì„¸</label><input class="inp" value="${esc(s.marketDeposit||'')}" onchange="updItem('stores','${s.id}','marketDeposit',this.value)" placeholder="ì‹œì„¸ ì…ë ¥"></div></div>
${myRent&&mktRent?`<div style="margin-top:8px;padding:10px;border-radius:10px;background:${rentDiff<=0?'#E8F5E9':'#FFF3E0'};border:1px solid ${rentDiff<=0?'#A5D6A7':'#FFCC80'}">
<div style="display:flex;justify-content:space-between;align-items:center"><span style="font-weight:800;font-size:11px;color:${rentDiff<=0?'#2E7D32':'#E65100'}">ì„ëŒ€: ${rentDiff<=0?'âœ… ì €ë ´':'âš ï¸ ë¹„ìŒˆ'}</span><span style="font-weight:900;font-size:13px;color:${rentDiff<=0?'#2E7D32':'#C0392B'}">${rentDiff>0?'+':''}${fW(rentDiff)}ì› (${rentDiff>0?'+':''}${rentPct}%)</span></div>
<div style="font-size:9px;color:#666;margin-top:3px">ìš°ë¦¬ ${fW(myRent)} vs ì‹œì„¸ ${fW(mktRent)}</div>
</div>`:''}
${myDep&&mktDep?`<div style="margin-top:6px;padding:10px;border-radius:10px;background:${depDiff<=0?'#E8F5E9':'#FFF3E0'};border:1px solid ${depDiff<=0?'#A5D6A7':'#FFCC80'}">
<div style="display:flex;justify-content:space-between;align-items:center"><span style="font-weight:800;font-size:11px;color:${depDiff<=0?'#2E7D32':'#E65100'}">ë³´ì¦ê¸ˆ: ${depDiff<=0?'âœ… ì €ë ´':'âš ï¸ ë¹„ìŒˆ'}</span><span style="font-weight:900;font-size:13px;color:${depDiff<=0?'#2E7D32':'#C0392B'}">${depDiff>0?'+':''}${fW(depDiff)}ì› (${depDiff>0?'+':''}${depPct}%)</span></div>
<div style="font-size:9px;color:#666;margin-top:3px">ìš°ë¦¬ ${fW(myDep)} vs ì‹œì„¸ ${fW(mktDep)}</div>
</div>`:''}
</div></div>`;})()}
<div class="c"><div class="c-h">ğŸ“· ì‚¬ì§„</div><div class="c-b"><div class="photos">${(s.photos||[]).map((p,i)=>`<div style="position:relative"><img src="${p}" class="photo-thumb" onclick="viewImg('${s.id}',${i})"><button style="position:absolute;top:-4px;right:-4px;width:18px;height:18px;border-radius:9px;background:#E53935;color:#fff;border:none;font-size:10px;cursor:pointer" onclick="event.stopPropagation();delPhoto('${s.id}',${i})">âœ•</button></div>`).join('')}<label class="photo-add"><input type="file" accept="image/*" multiple style="display:none" onchange="addPhotos('${s.id}',this.files)">+</label></div></div></div>
<div class="c"><div class="c-h">ğŸ“ ì²¨ë¶€íŒŒì¼</div><div class="c-b">
${(s.files||[]).map((f,i)=>`<div style="display:flex;align-items:center;gap:6px;padding:6px;background:#F5F5F5;border-radius:8px;margin-bottom:4px"><span style="font-size:14px">${fileIcon(f.name)}</span><div style="flex:1;min-width:0"><div style="font-size:11px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc(f.name)}</div><div style="font-size:8px;color:#999">${fSize(f.size)}</div></div><button class="btn bo btn-sm" onclick="openFile('${s.id}',${i})">ì—´ê¸°</button><button style="width:20px;height:20px;border-radius:10px;background:#E53935;color:#fff;border:none;font-size:9px;cursor:pointer" onclick="delFile('${s.id}',${i})">âœ•</button></div>`).join('')}
<label style="display:flex;align-items:center;justify-content:center;padding:10px;border:2px dashed #ddd;border-radius:10px;cursor:pointer;color:#999;font-size:11px;font-weight:700"><input type="file" multiple style="display:none" onchange="addFiles('${s.id}',this.files)" accept=".pdf,.doc,.docx,.xls,.xlsx,.hwp,.hwpx,.ppt,.pptx,.txt,.zip,.jpg,.jpeg,.png">ğŸ“ íŒŒì¼ ì¶”ê°€</label>
</div></div>
<div class="c"><div class="c-h">â˜ï¸ êµ¬ê¸€ ë“œë¼ì´ë¸Œ</div><div class="c-b" style="display:flex;gap:6px;flex-wrap:wrap">
<button class="btn bo btn-sm" onclick="openDriveFolder('${s.id}')">ğŸ“‚ í´ë” ì—´ê¸°</button>
<button class="btn bo btn-sm" onclick="dlAllFiles('${s.id}')">ğŸ’¾ ì „ì²´ ë‹¤ìš´</button>
</div></div>
<div class="c"><div class="c-h">ğŸ—º ì§€ë„</div><div class="c-b"><div class="fr mb8"><input class="inp" id="mq_${s.id}" value="${esc(s.mapQuery||s.address)}" style="flex:1"><button class="btn bp btn-sm" onclick="searchMap('${s.id}')">ê²€ìƒ‰</button></div><div id="mf_${s.id}">${s.mapQuery?`<iframe src="https://maps.google.com/maps?q=${encodeURIComponent(s.mapQuery)}&output=embed&z=16" style="width:100%;height:200px;border:none;border-radius:10px"></iframe>`:'<div style="text-align:center;padding:20px;color:#ccc;font-size:12px;background:var(--lt);border-radius:10px">ì£¼ì†Œ ì…ë ¥ í›„ ê²€ìƒ‰</div>'}</div></div></div>
${checkBtns(s.address)}
${linksHTML('store',s)}${memoHTML('stores',s)}${actHTML(s)}`;}

function addPhotos(sid,files){const s=D.stores.find(x=>x.id===sid);if(!s)return;if(!s.photos)s.photos=[];Array.from(files).forEach(f=>{const r=new FileReader();r.onload=e=>{s.photos.push(e.target.result);R();};r.readAsDataURL(f);});}
function delPhoto(sid,i){const s=D.stores.find(x=>x.id===sid);if(s)s.photos.splice(i,1);R();}
function viewImg(sid,i){const s=D.stores.find(x=>x.id===sid);if(!s?.photos?.[i])return;$('modal').innerHTML=`<div class="modal-overlay" onclick="$('modal').innerHTML=''"><img src="${s.photos[i]}" style="max-width:95%;max-height:90vh;border-radius:12px;object-fit:contain" onclick="event.stopPropagation()"></div>`;}
function fileIcon(name){const ext=(name||'').split('.').pop().toLowerCase();const m={'pdf':'ğŸ“„','doc':'ğŸ“','docx':'ğŸ“','xls':'ğŸ“Š','xlsx':'ğŸ“Š','hwp':'ğŸ“ƒ','hwpx':'ğŸ“ƒ','ppt':'ğŸ“½','pptx':'ğŸ“½','txt':'ğŸ“‹','zip':'ğŸ“¦','jpg':'ğŸ–¼','jpeg':'ğŸ–¼','png':'ğŸ–¼'};return m[ext]||'ğŸ“';}
function fSize(b){if(!b)return'';if(b<1024)return b+'B';if(b<1048576)return(b/1024).toFixed(1)+'KB';return(b/1048576).toFixed(1)+'MB';}
function addFiles(sid,fileList){const s=D.stores.find(x=>x.id===sid);if(!s)return;if(!s.files)s.files=[];
Array.from(fileList).forEach(f=>{if(f.size>10*1048576)return alert(f.name+': 10MB ì´ˆê³¼');
const r=new FileReader();r.onload=e=>{s.files.push({name:f.name,size:f.size,type:f.type,data:e.target.result,date:today()});R();};r.readAsDataURL(f);});}
function delFile(sid,i){const s=D.stores.find(x=>x.id===sid);if(!s||!confirm('ì‚­ì œ?'))return;s.files.splice(i,1);R();}
function openFile(sid,i){const s=D.stores.find(x=>x.id===sid);const f=s?.files?.[i];if(!f)return;
if(f.type&&f.type.startsWith('image')){$('modal').innerHTML=`<div class="modal-overlay" onclick="$('modal').innerHTML=''"><img src="${f.data}" style="max-width:95%;max-height:90vh;border-radius:12px;object-fit:contain" onclick="event.stopPropagation()"></div>`;return;}
const w=window.open('');if(w){w.document.write('<iframe src="'+f.data+'" style="width:100%;height:100%;border:none;position:fixed;top:0;left:0"></iframe>');}}
function dlFile(sid,i){const s=D.stores.find(x=>x.id===sid);const f=s?.files?.[i];if(!f)return;
const a=document.createElement('a');a.href=f.data;a.download=f.name;a.click();}
function dlAllFiles(sid){const s=D.stores.find(x=>x.id===sid);if(!s)return;
const all=[...(s.photos||[]).map((p,i)=>({data:p,name:(s.name||'ì í¬')+'_ì‚¬ì§„'+(i+1)+'.jpg'})),...(s.files||[]).map(f=>({data:f.data,name:f.name}))];
if(!all.length)return alert('íŒŒì¼ ì—†ìŒ');
all.forEach((f,i)=>{setTimeout(()=>{const a=document.createElement('a');a.href=f.data;a.download=f.name;a.click();},i*300);});}
function openDriveFolder(sid){const s=D.stores.find(x=>x.id===sid);
window.open('https://drive.google.com/drive/my-drive','_blank');}
function updAddr(sid,val){const s=D.stores.find(x=>x.id===sid);if(s){s.address=val;s.mapQuery=val;}R();}
function searchMap(sid){const q=document.getElementById('mq_'+sid)?.value?.trim();if(!q)return;const s=D.stores.find(x=>x.id===sid);if(s)s.mapQuery=q;document.getElementById('mf_'+sid).innerHTML=`<iframe src="https://maps.google.com/maps?q=${encodeURIComponent(q)}&output=embed&z=16" style="width:100%;height:200px;border:none;border-radius:10px"></iframe>`;save();}

function genPDF(sid){const s=D.stores.find(x=>x.id===sid);if(!s)return;const no=D.stores.indexOf(s)+1;const info=[];if(s.floor)info.push(['ì¸µìˆ˜',s.floor]);if(s.area)info.push(['í‰ìˆ˜',s.area+'í‰']);if(s.rent)info.push(['ì„ëŒ€ë£Œ(ì›”)',fW(s.rent)+'ì›']);if(s.maintenance)info.push(['ê´€ë¦¬ë¹„(ì›”)',fW(s.maintenance)+'ì›']);if(s.deposit)info.push(['ë³´ì¦ê¸ˆ',fW(s.deposit)+'ì›']);if(s.premium)info.push(['ê¶Œë¦¬ê¸ˆ',fW(s.premium)+'ì›']);info.push(['ì›”ì´ë¹„ìš©',fW(numVal(s.rent)+numVal(s.maintenance))+'ì›']);if(s.grade&&s.grade!=='ë¯¸ì •')info.push(['ë“±ê¸‰',s.grade]);if(s.status)info.push(['ìƒíƒœ',s.status]);
const w=window.open('','_blank');w.document.write(`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${esc(s.name)}</title><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,'Pretendard','Noto Sans KR',sans-serif;padding:32px;color:#1a1a1a;max-width:700px;margin:0 auto}@media print{body{padding:16px}.np{display:none!important}}h1{font-size:22px;font-weight:900;color:#C0392B;margin-bottom:4px}.sub{font-size:12px;color:#888;margin-bottom:20px}.ig{display:grid;grid-template-columns:1fr 1fr;gap:1px;background:#eee;border-radius:10px;overflow:hidden;margin-bottom:20px}.ic{background:#fff;padding:12px 16px}.ic .l{font-size:10px;color:#999;font-weight:700}.ic .v{font-size:15px;font-weight:800;margin-top:2px}.sec{margin-bottom:20px}.sec h3{font-size:14px;font-weight:800;color:#C0392B;margin-bottom:10px;padding-bottom:6px;border-bottom:2px solid #C0392B}.ph{display:flex;gap:8px;flex-wrap:wrap}.ph img{width:160px;height:120px;object-fit:cover;border-radius:8px}.mi{padding:8px 12px;background:#f9f9f9;border-radius:8px;margin-bottom:4px;font-size:12px}.mt{font-size:9px;color:#bbb}.ft{text-align:center;margin-top:24px;padding-top:16px;border-top:1px solid #eee;font-size:10px;color:#bbb}.pb{position:fixed;bottom:20px;right:20px;padding:12px 24px;background:#C0392B;color:#fff;border:none;border-radius:10px;font-size:14px;font-weight:700;cursor:pointer}.mb{margin-top:8px;display:flex;gap:6px}.mbtn{padding:6px 12px;border-radius:8px;font-size:11px;font-weight:700;color:#fff;text-decoration:none}.nv{background:#03C75A}.kk{background:#FEE500;color:#000}</style></head><body>
<h1>ğŸª ${esc(s.name)}</h1><div class="sub">No.${no} Â· ${esc(s.address||'')} Â· ${s.createdAt}</div>
${info.length?'<div class="ig">'+info.map(([l,v])=>`<div class="ic"><div class="l">${l}</div><div class="v">${v}</div></div>`).join('')+'</div>':''}
${s.address?`<div class="sec"><h3>ğŸ“ ìœ„ì¹˜</h3><p style="font-size:13px;margin-bottom:8px">${esc(s.address)}</p><div class="mb np"><a href="https://map.naver.com/v5/search/${encodeURIComponent(s.address)}" target="_blank" class="mbtn nv">ë„¤ì´ë²„ì§€ë„</a><a href="https://map.kakao.com/?q=${encodeURIComponent(s.address)}" target="_blank" class="mbtn kk">ì¹´ì¹´ì˜¤ë§µ</a></div>${s.mapQuery?`<iframe src="https://maps.google.com/maps?q=${encodeURIComponent(s.mapQuery)}&output=embed&z=16" style="width:100%;height:250px;border:none;border-radius:10px;margin-top:10px"></iframe>`:''}</div><div class="sec np"><h3>ğŸ” ê¶Œë¦¬ í™•ì¸</h3><div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:8px"><a href="https://www.iros.go.kr/PMainJ.jsp" target="_blank" style="padding:8px 14px;background:#E3F2FD;color:#0D47A1;border-radius:8px;text-decoration:none;font-size:12px;font-weight:700">ğŸ“‹ ë“±ê¸°ë¶€ë“±ë³¸</a><a href="https://www.gov.kr/search/apply?srhQuery=${encodeURIComponent(s.address)}+ê±´ì¶•ë¬¼ëŒ€ì¥" target="_blank" style="padding:8px 14px;background:#FFF3E0;color:#E65100;border-radius:8px;text-decoration:none;font-size:12px;font-weight:700">ğŸ— ê±´ì¶•ë¬¼ëŒ€ì¥</a><a href="https://eum.go.kr/web/ar/lu/luLandDet.jsp" target="_blank" style="padding:8px 14px;background:#E8F5E9;color:#1B5E20;border-radius:8px;text-decoration:none;font-size:12px;font-weight:700">ğŸ—º í† ì§€ì´ìš©ê³„íš</a><a href="https://rt.molit.go.kr/" target="_blank" style="padding:8px 14px;background:#F3E5F5;color:#4A148C;border-radius:8px;text-decoration:none;font-size:12px;font-weight:700">ğŸ’° ì‹¤ê±°ë˜ê°€</a></div></div>`:''}
${s.photos?.length?'<div class="sec"><h3>ğŸ“· ì‚¬ì§„</h3><div class="ph">'+s.photos.map(p=>`<img src="${p}">`).join('')+'</div></div>':''}
${s.memos?.length?'<div class="sec"><h3>ğŸ“ ë©”ëª¨</h3>'+s.memos.map(m=>`<div class="mi"><div class="mt">ğŸ• ${m.time}</div>${esc(m.text)}</div>`).join('')+'</div>':''}
<div class="ft">í†µí•© DB Â· ${today()}</div><button class="pb np" onclick="window.print()">ğŸ–¨ ì¸ì‡„/PDF</button></body></html>`);w.document.close();}

// â•â•â• BRAND â•â•â•
function renderBrandList(el){let list=D.brands;if(D.search){const q=D.search.toLowerCase();list=list.filter(b=>[b.brandName,b.companyName,b.contactName,b.position,b.phone,b.consultContent,...(b.tags||[]),...(b.memos||[]).map(m=>m.text)].some(v=>(v||'').toLowerCase().includes(q)));}
el.innerHTML=`<div class="fb mb10"><div style="font-size:18px;font-weight:900">ğŸ· ë¸Œëœë“œ <span style="font-size:12px;color:var(--sub)">${D.brands.length}</span></div><div class="fr"><button class="btn bo btn-sm" onclick="exportPhones('brand')">ğŸ“±ì—‘ì…€</button><button class="btn bp" onclick="addBrand()">+ ì¶”ê°€</button></div></div>
<input class="inp mb10" placeholder="ğŸ” ê²€ìƒ‰" value="${esc(D.search)}" oninput="D.search=this.value;R()">
${list.length?'<div class="c">'+list.map(b=>{const no=D.brands.indexOf(b)+1;return`<div class="item" onclick="addAct('brands','${b.id}','ì¡°íšŒ');D.editId='${b.id}';R()"><div class="item-no">${no}</div><div class="item-body"><div class="item-nm">${esc(b.brandName)||'(ë¯¸ì…ë ¥)'}${b.companyName?' <span style="font-size:11px;color:var(--sub)">'+esc(b.companyName)+'</span>':''}${actBadge(b)}</div><div class="item-meta">${b.contactName?esc(b.contactName)+(b.position?' '+esc(b.position):''):'-'} Â· ${phoneHTML(b.phone)} ${tagsHTML(b.tags)}</div><div class="item-date">${b.createdAt}${b.followUp?' Â· â°'+b.followUp:''}</div></div></div>`;}).join('')+'</div>':'<div class="empty">ë¸Œëœë“œë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”</div>'}`;}

function renderBrandEdit(el){const b=D.brands.find(x=>x.id===D.editId);if(!b){D.editId=null;R();return;}const no=D.brands.indexOf(b)+1;
el.innerHTML=`<div class="fb mb12"><button class="btn bg" onclick="D.editId=null;R()">â† ëª©ë¡</button><div class="fr"><span style="font-size:12px;font-weight:800;color:var(--c)">No.${no} ${actBadge(b)}</span><button class="btn bd btn-sm" onclick="delItem('brands','${b.id}')">ì‚­ì œ</button></div></div>
<div class="c"><div class="c-h" style="color:var(--c)">ë¸Œëœë“œ ì •ë³´</div><div class="c-b">
<div class="row r2"><div><label class="lbl">ë¸Œëœë“œëª…</label><input class="inp" value="${esc(b.brandName)}" onchange="updItem('brands','${b.id}','brandName',this.value)"></div><div><label class="lbl">íšŒì‚¬ëª…</label><input class="inp" value="${esc(b.companyName)}" onchange="updItem('brands','${b.id}','companyName',this.value)"></div></div>
<div class="row r3"><div><label class="lbl">ë‹´ë‹¹ì</label><input class="inp" value="${esc(b.contactName)}" onchange="updItem('brands','${b.id}','contactName',this.value)"></div><div><label class="lbl">ì§ì±…</label><input class="inp" value="${esc(b.position)}" onchange="updItem('brands','${b.id}','position',this.value)"></div><div><label class="lbl">ì „í™”ë²ˆí˜¸</label><input class="inp" value="${esc(b.phone)}" onchange="updItem('brands','${b.id}','phone',this.value)"></div></div>
<div class="row"><label class="lbl">â° íŒ”ë¡œì—…</label><input class="inp" type="date" value="${b.followUp||''}" onchange="updItem('brands','${b.id}','followUp',this.value)"></div>
<div style="font-size:10px;color:#ccc;margin-top:8px">ë“±ë¡: ${b.createdAt} ${tagsHTML(b.tags)}</div>
</div></div>${linksHTML('brand',b)}${memoHTML('brands',b)}${actHTML(b)}`;}

// â•â•â• CRUD â•â•â•
function addCust(){D.customers.unshift({id:uid(),name:'',phone:'',grade:'ì¼ë°˜',status:'ì‹ ê·œ',tags:[],memos:[],consultHistory:[],links:[],followUp:'',interests:'',region:'',budget:'',bizType:'',wantArea:'',createdAt:now()});D.editId=D.customers[0].id;D.tab='cust';R();}
function addStore(){D.stores.unshift({id:uid(),name:'',address:'',floor:'',area:'',rent:'',maintenance:'',premium:'',deposit:'',district:'',grade:'ë¯¸ì •',status:'ê³µì‹¤',marketRent:'',marketDeposit:'',tags:[],photos:[],mapQuery:'',memos:[],links:[],followUp:'',actCount:0,actLog:[],createdAt:now()});D.editId=D.stores[0].id;D.tab='store';R();}
function addBrand(){D.brands.unshift({id:uid(),brandName:'',companyName:'',contactName:'',position:'',phone:'',tags:[],memos:[],links:[],followUp:'',createdAt:now()});D.editId=D.brands[0].id;D.tab='brand';R();}
function updItem(t,id,f,v){const x=D[t].find(i=>i.id===id);if(x)x[f]=v;save();}
function updItemR(t,id,f,v){const x=D[t].find(i=>i.id===id);if(x)x[f]=v;R();}
function delItem(t,id){if(!confirm('ì‚­ì œ?'))return;D[t]=D[t].filter(x=>x.id!==id);D.editId=null;R();}

function memoHTML(t,item){const sorted=[...(item.memos||[])].sort((a,b)=>(b.pinned?1:0)-(a.pinned?1:0));
return`<div class="c"><div class="c-h"><span>ğŸ“ ë©”ëª¨ (${item.memos?.length||0})</span><button class="btn bp btn-sm" onclick="addMemo('${t}','${item.id}')">+ ì¶”ê°€</button></div><div class="c-b"><div class="fr mb8"><input class="inp" id="mi_${item.id}" placeholder="ë©”ëª¨ â†’ Enter" onkeydown="if(event.key==='Enter')addMemo('${t}','${item.id}')" style="flex:1"></div>${sorted.map(m=>`<div class="memo${m.pinned?' pinned':''}"><div class="memo-t"><span>${m.pinned?'ğŸ“Œ ':''}ğŸ• ${m.time}</span><div class="fr"><button style="background:none;border:none;cursor:pointer;font-size:10px" onclick="togglePin('${t}','${item.id}','${m.id}')">${m.pinned?'ğŸ“Œ':'ğŸ“'}</button><button style="background:none;border:none;color:#E53935;cursor:pointer;font-size:10px" onclick="delMemo('${t}','${item.id}','${m.id}')">ì‚­ì œ</button></div></div><div class="memo-txt">${esc(m.text)}</div></div>`).join('')}${sorted.length===0?'<div style="text-align:center;color:#ddd;font-size:12px;padding:12px">ë©”ëª¨ ì…ë ¥</div>':''}</div></div>`;}
function addMemo(t,id){const inp=document.getElementById('mi_'+id);const tx=inp?.value?.trim();if(!tx)return;const item=D[t].find(x=>x.id===id);if(item){if(!item.memos)item.memos=[];item.memos.unshift({id:uid(),text:tx,time:now(),pinned:false});addAct(t,id,'ë©”ëª¨ ì¶”ê°€');}R();}
function delMemo(t,id,mid){const item=D[t].find(x=>x.id===id);if(item)item.memos=item.memos.filter(m=>m.id!==mid);R();}
function togglePin(t,id,mid){const item=D[t].find(x=>x.id===id);if(item){const m=item.memos.find(x=>x.id===mid);if(m)m.pinned=!m.pinned;}R();}

function consultHTML(c){return`<div class="c"><div class="c-h"><span>ğŸ“ ìƒë‹´ (${c.consultHistory?.length||0})</span><button class="btn bp btn-sm" onclick="addCon('${c.id}')">+ ì¶”ê°€</button></div><div class="c-b">${(c.consultHistory||[]).map(h=>`<div class="memo"><div class="memo-t"><span>ğŸ• ${h.time} Â· <b>${h.type}</b></span><button style="background:none;border:none;color:#E53935;cursor:pointer;font-size:10px" onclick="delCon('${c.id}','${h.id}')">ì‚­ì œ</button></div><textarea class="inp ta" style="margin:6px 0;min-height:40px" onchange="updCon('${c.id}','${h.id}','content',this.value)">${esc(h.content)}</textarea><div class="row r2"><select class="inp" onchange="updCon('${c.id}','${h.id}','type',this.value)">${CTYPES.map(t=>`<option${h.type===t?' selected':''}>${t}</option>`).join('')}</select><input class="inp" value="${esc(h.result)}" onchange="updCon('${c.id}','${h.id}','result',this.value)" placeholder="ê²°ê³¼"></div></div>`).join('')}${(c.consultHistory||[]).length===0?'<div style="text-align:center;color:#ddd;font-size:12px;padding:12px">ìƒë‹´ì´ë ¥ ì—†ìŒ</div>':''}</div></div>`;}
function addCon(cid){const c=D.customers.find(x=>x.id===cid);if(c){if(!c.consultHistory)c.consultHistory=[];c.consultHistory.unshift({id:uid(),time:now(),type:'ì „í™”',content:'',result:''});addAct('customers',cid,'ìƒë‹´ ì¶”ê°€');}R();}
function updCon(cid,hid,f,v){const c=D.customers.find(x=>x.id===cid);if(c){const h=c.consultHistory.find(x=>x.id===hid);if(h)h[f]=v;}R();}
function delCon(cid,hid){const c=D.customers.find(x=>x.id===cid);if(c)c.consultHistory=c.consultHistory.filter(x=>x.id!==hid);R();}

function exportPhones(t){let rows;if(t==='cust'){rows=[['No.','ì´ë¦„','ì „í™”ë²ˆí˜¸','ë“±ê¸‰','ìƒíƒœ','ë“±ë¡ì¼']];D.customers.forEach((c,i)=>{if(c.phone)rows.push([i+1,c.name,c.phone,c.grade,c.status||'ì‹ ê·œ',c.createdAt]);});}else{rows=[['No.','ë¸Œëœë“œ','íšŒì‚¬','ë‹´ë‹¹ì','ì§ì±…','ì „í™”ë²ˆí˜¸','ë“±ë¡ì¼']];D.brands.forEach((b,i)=>{if(b.phone)rows.push([i+1,b.brandName,b.companyName,b.contactName,b.position,b.phone,b.createdAt]);});}const csv='\uFEFF'+rows.map(r=>r.map(c=>'"'+String(c||'').replace(/"/g,'""')+'"').join(',')).join('\n');const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8'}));a.download=`${t==='cust'?'ê³ ê°':'ë¸Œëœë“œ'}_ì—°ë½ì²˜_${today()}.csv`;a.click();}

function exportCustomers(list){
if(!list)list=D.customers;
const filtered=list!==D.customers;
const sheetName=filtered?'ê³ ê°DB_í•„í„°':'ê³ ê°DB';
const headers=['No.','ë“±ë¡ì¼','ì´ë¦„','ì—°ë½ì²˜','ë“±ê¸‰','ìƒíƒœ','ì§€ì—­','ì°½ì—…ì˜ˆì‚°','í¬ë§ì—…ì¢…','í¬ë§í‰ìˆ˜','ê´€ì‹¬ì‚¬','íŒ”ë¡œì—…','ë©”ëª¨','ìƒë‹´ì´ë ¥','íƒœê·¸','ì‘ì—…ìˆ˜'];
const data=list.map((c,i)=>{
const memos=(c.memos||[]).map(m=>m.text).join(' / ');
const consults=(c.consultHistory||[]).map(h=>`[${h.type}] ${h.content||''} â†’ ${h.result||''}`).join(' / ');
return[i+1,c.createdAt||'',c.name||'','  '+(c.phone||'')+'  ',c.grade||'ì¼ë°˜',c.status||'ì‹ ê·œ',c.region||'',c.budget||'',c.bizType||'',c.wantArea||'',c.interests||'',c.followUp||'',memos,consults,(c.tags||[]).join(' '),c.actCount||0];
});
const colW=[5,15,12,18,8,9,12,12,12,9,22,12,35,35,16,8];
const bdr='<Borders><Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="1" ss:Color="#D0D0D0"/><Border ss:Position="Top" ss:LineStyle="Continuous" ss:Weight="1" ss:Color="#D0D0D0"/><Border ss:Position="Left" ss:LineStyle="Continuous" ss:Weight="1" ss:Color="#D0D0D0"/><Border ss:Position="Right" ss:LineStyle="Continuous" ss:Weight="1" ss:Color="#D0D0D0"/></Borders>';
let xml='<?xml version="1.0" encoding="UTF-8"?>\n<?mso-application progid="Excel.Sheet"?>\n<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet" xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet" xmlns:x="urn:schemas-microsoft-com:office:excel">\n<Styles>\n';
xml+=`<Style ss:ID="ti"><Font ss:FontName="ë§‘ì€ ê³ ë”•" ss:Size="14" ss:Bold="1" ss:Color="#1A1A1A"/><Alignment ss:Vertical="Center"/></Style>\n`;
xml+=`<Style ss:ID="ti2"><Font ss:FontName="ë§‘ì€ ê³ ë”•" ss:Size="10" ss:Color="#888888"/><Alignment ss:Vertical="Center"/></Style>\n`;
xml+=`<Style ss:ID="hd"><Font ss:FontName="ë§‘ì€ ê³ ë”•" ss:Size="10" ss:Bold="1" ss:Color="#FFFFFF"/><Interior ss:Color="#1565C0" ss:Pattern="Solid"/><Alignment ss:Horizontal="Center" ss:Vertical="Center" ss:WrapText="1" ss:Indent="1"/>${bdr}</Style>\n`;
xml+=`<Style ss:ID="td"><Font ss:FontName="ë§‘ì€ ê³ ë”•" ss:Size="10" ss:Color="#333333"/><Alignment ss:Vertical="Center" ss:WrapText="1" ss:Indent="1"/>${bdr}</Style>\n`;
xml+=`<Style ss:ID="ct"><Font ss:FontName="ë§‘ì€ ê³ ë”•" ss:Size="10" ss:Color="#333333"/><Alignment ss:Horizontal="Center" ss:Vertical="Center"/>${bdr}</Style>\n`;
xml+=`<Style ss:ID="nm"><Font ss:FontName="ë§‘ì€ ê³ ë”•" ss:Size="10" ss:Bold="1" ss:Color="#1A1A1A"/><Alignment ss:Vertical="Center" ss:Indent="1"/>${bdr}</Style>\n`;
xml+=`<Style ss:ID="ph"><Font ss:FontName="ë§‘ì€ ê³ ë”•" ss:Size="10" ss:Color="#1565C0"/><Alignment ss:Vertical="Center" ss:Indent="1"/>${bdr}</Style>\n`;
xml+=`<Style ss:ID="num"><Font ss:FontName="ë§‘ì€ ê³ ë”•" ss:Size="10" ss:Color="#333333"/><NumberFormat ss:Format="#,##0"/><Alignment ss:Horizontal="Center" ss:Vertical="Center"/>${bdr}</Style>\n`;
xml+=`<Style ss:ID="td2"><Font ss:FontName="ë§‘ì€ ê³ ë”•" ss:Size="10" ss:Color="#333333"/><Alignment ss:Vertical="Center" ss:WrapText="1" ss:Indent="1"/><Interior ss:Color="#F0F4FA" ss:Pattern="Solid"/>${bdr}</Style>\n`;
xml+=`<Style ss:ID="ct2"><Font ss:FontName="ë§‘ì€ ê³ ë”•" ss:Size="10" ss:Color="#333333"/><Alignment ss:Horizontal="Center" ss:Vertical="Center"/><Interior ss:Color="#F0F4FA" ss:Pattern="Solid"/>${bdr}</Style>\n`;
xml+=`<Style ss:ID="nm2"><Font ss:FontName="ë§‘ì€ ê³ ë”•" ss:Size="10" ss:Bold="1" ss:Color="#1A1A1A"/><Alignment ss:Vertical="Center" ss:Indent="1"/><Interior ss:Color="#F0F4FA" ss:Pattern="Solid"/>${bdr}</Style>\n`;
xml+=`<Style ss:ID="ph2"><Font ss:FontName="ë§‘ì€ ê³ ë”•" ss:Size="10" ss:Color="#1565C0"/><Alignment ss:Vertical="Center" ss:Indent="1"/><Interior ss:Color="#F0F4FA" ss:Pattern="Solid"/>${bdr}</Style>\n`;
xml+=`<Style ss:ID="num2"><Font ss:FontName="ë§‘ì€ ê³ ë”•" ss:Size="10" ss:Color="#333333"/><NumberFormat ss:Format="#,##0"/><Alignment ss:Horizontal="Center" ss:Vertical="Center"/><Interior ss:Color="#F0F4FA" ss:Pattern="Solid"/>${bdr}</Style>\n`;
xml+=`<Style ss:ID="gv"><Font ss:FontName="ë§‘ì€ ê³ ë”•" ss:Size="10" ss:Bold="1" ss:Color="#C0392B"/><Alignment ss:Horizontal="Center" ss:Vertical="Center"/><Interior ss:Color="#FFF3CD" ss:Pattern="Solid"/>${bdr}</Style>\n`;
xml+=`<Style ss:ID="gv2"><Font ss:FontName="ë§‘ì€ ê³ ë”•" ss:Size="10" ss:Bold="1" ss:Color="#C0392B"/><Alignment ss:Horizontal="Center" ss:Vertical="Center"/><Interior ss:Color="#FFF3CD" ss:Pattern="Solid"/>${bdr}</Style>\n`;
xml+=`<Style ss:ID="gu"><Font ss:FontName="ë§‘ì€ ê³ ë”•" ss:Size="10" ss:Bold="1" ss:Color="#1565C0"/><Alignment ss:Horizontal="Center" ss:Vertical="Center"/><Interior ss:Color="#E3F2FD" ss:Pattern="Solid"/>${bdr}</Style>\n`;
xml+=`<Style ss:ID="gu2"><Font ss:FontName="ë§‘ì€ ê³ ë”•" ss:Size="10" ss:Bold="1" ss:Color="#1565C0"/><Alignment ss:Horizontal="Center" ss:Vertical="Center"/><Interior ss:Color="#E3F2FD" ss:Pattern="Solid"/>${bdr}</Style>\n`;
xml+=`<Style ss:ID="gh"><Font ss:FontName="ë§‘ì€ ê³ ë”•" ss:Size="10" ss:Color="#999999"/><Alignment ss:Horizontal="Center" ss:Vertical="Center"/><Interior ss:Color="#F5F5F5" ss:Pattern="Solid"/>${bdr}</Style>\n`;
xml+=`<Style ss:ID="sd"><Font ss:FontName="ë§‘ì€ ê³ ë”•" ss:Size="10" ss:Bold="1" ss:Color="#2E7D32"/><Alignment ss:Horizontal="Center" ss:Vertical="Center"/><Interior ss:Color="#E8F5E9" ss:Pattern="Solid"/>${bdr}</Style>\n`;
xml+=`<Style ss:ID="sc"><Font ss:FontName="ë§‘ì€ ê³ ë”•" ss:Size="10" ss:Bold="1" ss:Color="#E65100"/><Alignment ss:Horizontal="Center" ss:Vertical="Center"/><Interior ss:Color="#FFF3E0" ss:Pattern="Solid"/>${bdr}</Style>\n`;
xml+=`<Style ss:ID="sl"><Font ss:FontName="ë§‘ì€ ê³ ë”•" ss:Size="10" ss:Color="#999999"/><Alignment ss:Horizontal="Center" ss:Vertical="Center"/><Interior ss:Color="#F5F5F5" ss:Pattern="Solid"/>${bdr}</Style>\n`;
xml+=`<Style ss:ID="sum"><Font ss:FontName="ë§‘ì€ ê³ ë”•" ss:Size="10" ss:Bold="1" ss:Color="#1565C0"/><Alignment ss:Horizontal="Center" ss:Vertical="Center"/><Interior ss:Color="#E3F2FD" ss:Pattern="Solid"/>${bdr}</Style>\n`;
xml+='</Styles>\n';
xml+=`<Worksheet ss:Name="${sheetName}"><Table ss:DefaultRowHeight="26">\n`;
colW.forEach(w=>{xml+=`<Column ss:Width="${w*7.5}"/>\n`;});
xml+=`<Row ss:Height="36"><Cell ss:StyleID="ti" ss:MergeAcross="5"><Data ss:Type="String">  ğŸ‘¥ ê³ ê° DB${filtered?' (í•„í„° ì ìš©)':''}</Data></Cell><Cell ss:StyleID="ti2" ss:MergeAcross="3"><Data ss:Type="String">ì¶œë ¥ì¼: ${today()}  |  ${list.length}ê±´</Data></Cell></Row>\n`;
xml+='<Row ss:Height="6"></Row>\n';
xml+='<Row ss:Height="32">';headers.forEach(h=>{xml+=`<Cell ss:StyleID="hd"><Data ss:Type="String">${h}</Data></Cell>`;});xml+='</Row>\n';
const gradeIdx=4;const statusIdx=5;const nameIdx=2;const phoneIdx=3;const numIdx=15;const centerIdx=[0,4,5,9,15];
data.forEach((row,ri)=>{const ev=ri%2===1;xml+='<Row ss:Height="28">';row.forEach((cell,ci)=>{
let sid=ev?'td2':'td';
if(ci===nameIdx)sid=ev?'nm2':'nm';
else if(ci===phoneIdx)sid=ev?'ph2':'ph';
else if(ci===gradeIdx){const g=String(cell);sid=g==='VIP'?(ev?'gv2':'gv'):g==='ìš°ìˆ˜'?(ev?'gu2':'gu'):g==='íœ´ë©´'?'gh':(ev?'ct2':'ct');}
else if(ci===statusIdx){const st=String(cell);sid=st==='ê³„ì•½ì™„ë£Œ'?'sd':(st==='ìƒë‹´ì¤‘'||st==='ê³„ì•½ì§„í–‰')?'sc':st==='ì´íƒˆ'?'sl':(ev?'ct2':'ct');}
else if(ci===numIdx&&cell>0)sid=ev?'num2':'num';
else if(centerIdx.includes(ci))sid=ev?'ct2':'ct';
if(ci===numIdx&&cell>0)xml+=`<Cell ss:StyleID="${sid}"><Data ss:Type="Number">${cell}</Data></Cell>`;
else xml+=`<Cell ss:StyleID="${sid}"><Data ss:Type="String">${String(cell||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</Data></Cell>`;
});xml+='</Row>\n';});
const vipN=data.filter(r=>r[gradeIdx]==='VIP').length;const activeN=data.filter(r=>r[statusIdx]==='ìƒë‹´ì¤‘'||r[statusIdx]==='ê³„ì•½ì§„í–‰').length;const doneN=data.filter(r=>r[statusIdx]==='ê³„ì•½ì™„ë£Œ').length;
xml+=`<Row ss:Height="30"><Cell ss:StyleID="sum" ss:MergeAcross="3"><Data ss:Type="String">í•©ê³„: ${data.length}ëª…</Data></Cell><Cell ss:StyleID="sum"><Data ss:Type="String">VIP ${vipN}</Data></Cell><Cell ss:StyleID="sum"><Data ss:Type="String">ì§„í–‰ ${activeN}</Data></Cell><Cell ss:StyleID="sum" ss:MergeAcross="3"><Data ss:Type="String">ê³„ì•½ì™„ë£Œ ${doneN}</Data></Cell></Row>\n`;
xml+='</Table>\n<WorksheetOptions xmlns="urn:schemas-microsoft-com:office:excel"><FreezePanes/><FrozenNoSplit/><SplitHorizontal>3</SplitHorizontal><TopRowBottomPane>3</TopRowBottomPane></WorksheetOptions>\n</Worksheet></Workbook>';
const fname=filtered?`ê³ ê°DB_í•„í„°${list.length}ê±´_${today()}.xls`:`ê³ ê°DB_ì „ì²´${list.length}ê±´_${today()}.xls`;
const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([xml],{type:'application/vnd.ms-excel;charset=utf-8'}));a.download=fname;a.click();
}

function exportStores(list){
if(!list)list=D.stores;
const fmtN=n=>{if(!n&&n!==0)return'';const v=typeof n==='string'?parseInt(n.replace(/[, ]/g,'')):n;return isNaN(v)?'':v;};
const fmtC=n=>{const v=fmtN(n);return v?v.toLocaleString('ko-KR'):'';};
const filtered=list!==D.stores;
const sheetName=filtered?'ì í¬DB_í•„í„°':'ì í¬DB';
const headers=['No.','ë“±ë¡ì¼','ì í¬ëª…','ì£¼ì†Œ','ì§€ì—­êµ¬','ì¸µìˆ˜','í‰ìˆ˜(í‰)','ë³´ì¦ê¸ˆ','ê¶Œë¦¬ê¸ˆ','ì„ëŒ€ë£Œ(ì›”)','ê´€ë¦¬ë¹„(ì›”)','ì›”ì´ë¹„ìš©','ì£¼ë³€ì„ëŒ€ì‹œì„¸','ì„ëŒ€ì°¨ì´','ë“±ê¸‰','ìƒíƒœ','íŒ”ë¡œì—…','íƒœê·¸','ë©”ëª¨'];
const data=list.map((s,i)=>{
const tm=fmtN(s.rent)+fmtN(s.maintenance);const myR=numVal(s.rent);const mkR=numVal(s.marketRent);const rdiff=myR&&mkR?myR-mkR:0;
return[i+1,s.createdAt||'',s.name||'',s.address||'',s.district||'',s.floor||'',s.area||'',fmtC(s.deposit),fmtC(s.premium),fmtC(s.rent),fmtC(s.maintenance),fmtC(tm),mkR?fmtC(mkR):'',rdiff?((rdiff>0?'+':'')+fW(rdiff)+'ì›'):'',s.grade||'',s.status||'',s.followUp||'',(s.tags||[]).join(' '),(s.memos||[]).map(m=>m.text).join(' / ')];
});
const colW=[5,15,20,34,11,7,8,14,14,14,14,14,14,14,8,9,12,16,34];
const bdr='<Borders><Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="1" ss:Color="#D0D0D0"/><Border ss:Position="Top" ss:LineStyle="Continuous" ss:Weight="1" ss:Color="#D0D0D0"/><Border ss:Position="Left" ss:LineStyle="Continuous" ss:Weight="1" ss:Color="#D0D0D0"/><Border ss:Position="Right" ss:LineStyle="Continuous" ss:Weight="1" ss:Color="#D0D0D0"/></Borders>';
let xml='<?xml version="1.0" encoding="UTF-8"?>\n<?mso-application progid="Excel.Sheet"?>\n<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet" xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet" xmlns:x="urn:schemas-microsoft-com:office:excel">\n<Styles>\n';
xml+=`<Style ss:ID="ti"><Font ss:FontName="ë§‘ì€ ê³ ë”•" ss:Size="14" ss:Bold="1" ss:Color="#1A1A1A"/><Alignment ss:Vertical="Center"/></Style>\n`;
xml+=`<Style ss:ID="ti2"><Font ss:FontName="ë§‘ì€ ê³ ë”•" ss:Size="10" ss:Color="#888888"/><Alignment ss:Vertical="Center"/></Style>\n`;
xml+=`<Style ss:ID="hd"><Font ss:FontName="ë§‘ì€ ê³ ë”•" ss:Size="10" ss:Bold="1" ss:Color="#FFFFFF"/><Interior ss:Color="#C0392B" ss:Pattern="Solid"/><Alignment ss:Horizontal="Center" ss:Vertical="Center" ss:WrapText="1" ss:Indent="1"/>${bdr}</Style>\n`;
xml+=`<Style ss:ID="td"><Font ss:FontName="ë§‘ì€ ê³ ë”•" ss:Size="10" ss:Color="#333333"/><Alignment ss:Vertical="Center" ss:WrapText="1" ss:Indent="1"/>${bdr}</Style>\n`;
xml+=`<Style ss:ID="ct"><Font ss:FontName="ë§‘ì€ ê³ ë”•" ss:Size="10" ss:Color="#333333"/><Alignment ss:Horizontal="Center" ss:Vertical="Center"/>${bdr}</Style>\n`;
xml+=`<Style ss:ID="nm"><Font ss:FontName="ë§‘ì€ ê³ ë”•" ss:Size="10" ss:Bold="1" ss:Color="#1A1A1A"/><Alignment ss:Vertical="Center" ss:Indent="1"/>${bdr}</Style>\n`;
xml+=`<Style ss:ID="mn"><Font ss:FontName="ë§‘ì€ ê³ ë”•" ss:Size="10" ss:Color="#333333"/><NumberFormat ss:Format="#,##0"/><Alignment ss:Horizontal="Right" ss:Vertical="Center" ss:Indent="1"/>${bdr}</Style>\n`;
xml+=`<Style ss:ID="td2"><Font ss:FontName="ë§‘ì€ ê³ ë”•" ss:Size="10" ss:Color="#333333"/><Alignment ss:Vertical="Center" ss:WrapText="1" ss:Indent="1"/><Interior ss:Color="#FBF5F3" ss:Pattern="Solid"/>${bdr}</Style>\n`;
xml+=`<Style ss:ID="ct2"><Font ss:FontName="ë§‘ì€ ê³ ë”•" ss:Size="10" ss:Color="#333333"/><Alignment ss:Horizontal="Center" ss:Vertical="Center"/><Interior ss:Color="#FBF5F3" ss:Pattern="Solid"/>${bdr}</Style>\n`;
xml+=`<Style ss:ID="nm2"><Font ss:FontName="ë§‘ì€ ê³ ë”•" ss:Size="10" ss:Bold="1" ss:Color="#1A1A1A"/><Alignment ss:Vertical="Center" ss:Indent="1"/><Interior ss:Color="#FBF5F3" ss:Pattern="Solid"/>${bdr}</Style>\n`;
xml+=`<Style ss:ID="mn2"><Font ss:FontName="ë§‘ì€ ê³ ë”•" ss:Size="10" ss:Color="#333333"/><NumberFormat ss:Format="#,##0"/><Alignment ss:Horizontal="Right" ss:Vertical="Center" ss:Indent="1"/><Interior ss:Color="#FBF5F3" ss:Pattern="Solid"/>${bdr}</Style>\n`;
xml+=`<Style ss:ID="tt"><Font ss:FontName="ë§‘ì€ ê³ ë”•" ss:Size="10" ss:Bold="1" ss:Color="#C0392B"/><NumberFormat ss:Format="#,##0"/><Alignment ss:Horizontal="Right" ss:Vertical="Center" ss:Indent="1"/><Interior ss:Color="#FFF8E1" ss:Pattern="Solid"/>${bdr}</Style>\n`;
xml+=`<Style ss:ID="tt2"><Font ss:FontName="ë§‘ì€ ê³ ë”•" ss:Size="10" ss:Bold="1" ss:Color="#C0392B"/><NumberFormat ss:Format="#,##0"/><Alignment ss:Horizontal="Right" ss:Vertical="Center" ss:Indent="1"/><Interior ss:Color="#FFF8E1" ss:Pattern="Solid"/>${bdr}</Style>\n`;
xml+=`<Style ss:ID="ga"><Font ss:FontName="ë§‘ì€ ê³ ë”•" ss:Size="10" ss:Bold="1" ss:Color="#2E7D32"/><Alignment ss:Horizontal="Center" ss:Vertical="Center"/><Interior ss:Color="#E8F5E9" ss:Pattern="Solid"/>${bdr}</Style>\n`;
xml+=`<Style ss:ID="gb"><Font ss:FontName="ë§‘ì€ ê³ ë”•" ss:Size="10" ss:Bold="1" ss:Color="#E65100"/><Alignment ss:Horizontal="Center" ss:Vertical="Center"/><Interior ss:Color="#FFF3E0" ss:Pattern="Solid"/>${bdr}</Style>\n`;
xml+=`<Style ss:ID="gc"><Font ss:FontName="ë§‘ì€ ê³ ë”•" ss:Size="10" ss:Bold="1" ss:Color="#C62828"/><Alignment ss:Horizontal="Center" ss:Vertical="Center"/><Interior ss:Color="#FFEBEE" ss:Pattern="Solid"/>${bdr}</Style>\n`;
xml+=`<Style ss:ID="sv"><Font ss:FontName="ë§‘ì€ ê³ ë”•" ss:Size="10" ss:Bold="1" ss:Color="#C62828"/><Alignment ss:Horizontal="Center" ss:Vertical="Center"/><Interior ss:Color="#FFEBEE" ss:Pattern="Solid"/>${bdr}</Style>\n`;
xml+=`<Style ss:ID="si"><Font ss:FontName="ë§‘ì€ ê³ ë”•" ss:Size="10" ss:Bold="1" ss:Color="#E65100"/><Alignment ss:Horizontal="Center" ss:Vertical="Center"/><Interior ss:Color="#FFF3E0" ss:Pattern="Solid"/>${bdr}</Style>\n`;
xml+=`<Style ss:ID="sp"><Font ss:FontName="ë§‘ì€ ê³ ë”•" ss:Size="10" ss:Bold="1" ss:Color="#1565C0"/><Alignment ss:Horizontal="Center" ss:Vertical="Center"/><Interior ss:Color="#E3F2FD" ss:Pattern="Solid"/>${bdr}</Style>\n`;
xml+=`<Style ss:ID="sd"><Font ss:FontName="ë§‘ì€ ê³ ë”•" ss:Size="10" ss:Bold="1" ss:Color="#2E7D32"/><Alignment ss:Horizontal="Center" ss:Vertical="Center"/><Interior ss:Color="#E8F5E9" ss:Pattern="Solid"/>${bdr}</Style>\n`;
xml+=`<Style ss:ID="sum"><Font ss:FontName="ë§‘ì€ ê³ ë”•" ss:Size="10" ss:Bold="1" ss:Color="#C0392B"/><Alignment ss:Horizontal="Center" ss:Vertical="Center"/><Interior ss:Color="#FFEBEE" ss:Pattern="Solid"/>${bdr}</Style>\n`;
xml+=`<Style ss:ID="sumR"><Font ss:FontName="ë§‘ì€ ê³ ë”•" ss:Size="10" ss:Bold="1" ss:Color="#C0392B"/><NumberFormat ss:Format="#,##0"/><Alignment ss:Horizontal="Right" ss:Vertical="Center" ss:Indent="1"/><Interior ss:Color="#FFEBEE" ss:Pattern="Solid"/>${bdr}</Style>\n`;
xml+='</Styles>\n';
xml+=`<Worksheet ss:Name="${sheetName}"><Table ss:DefaultRowHeight="26">\n`;
colW.forEach(w=>{xml+=`<Column ss:Width="${w*7.5}"/>\n`;});
xml+=`<Row ss:Height="36"><Cell ss:StyleID="ti" ss:MergeAcross="5"><Data ss:Type="String">  ğŸª ì í¬ DB${filtered?' (í•„í„° ì ìš©)':''}</Data></Cell><Cell ss:StyleID="ti2" ss:MergeAcross="3"><Data ss:Type="String">ì¶œë ¥ì¼: ${today()}  |  ${list.length}ê±´</Data></Cell></Row>\n`;
xml+='<Row ss:Height="6"></Row>\n';
xml+='<Row ss:Height="32">';headers.forEach(h=>{xml+=`<Cell ss:StyleID="hd"><Data ss:Type="String">${h}</Data></Cell>`;});xml+='</Row>\n';
const moneyIdx=[7,8,9,10];const totalIdx=11;const mktIdx=12;const diffIdx=13;const gradeIdx=14;const statusIdx=15;const nameIdx=2;const centerIdx=[0,5,6];
data.forEach((row,ri)=>{const ev=ri%2===1;xml+='<Row ss:Height="28">';row.forEach((cell,ci)=>{
let sid=ev?'td2':'td';
if(ci===nameIdx)sid=ev?'nm2':'nm';
else if(ci===totalIdx)sid=ev?'tt2':'tt';
else if(moneyIdx.includes(ci))sid=ev?'mn2':'mn';
else if(ci===gradeIdx){const g=String(cell);sid=g.startsWith('A')?'ga':g.startsWith('B')?'gb':g.startsWith('C')?'gc':(ev?'ct2':'ct');}
else if(ci===statusIdx){const st=String(cell);sid=st==='ê³µì‹¤'?'sv':st==='ì†Œê°œì¤‘'?'si':st==='ê³„ì•½ì§„í–‰'?'sp':st==='ê³„ì•½ì™„ë£Œ'?'sd':(ev?'ct2':'ct');}
else if(centerIdx.includes(ci))sid=ev?'ct2':'ct';
const isNum=moneyIdx.includes(ci)||ci===totalIdx;
const raw=String(cell||'').replace(/,/g,'');const numV=parseInt(raw);
if(isNum&&!isNaN(numV)&&numV>0)xml+=`<Cell ss:StyleID="${sid}"><Data ss:Type="Number">${numV}</Data></Cell>`;
else xml+=`<Cell ss:StyleID="${sid}"><Data ss:Type="String">${String(cell||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</Data></Cell>`;
});xml+='</Row>\n';});
const avgR=data.length?Math.round(data.reduce((n,r)=>{const v=parseInt(String(r[9]||'').replace(/,/g,''))||0;return n+v;},0)/data.length):0;
const avgD=data.length?Math.round(data.reduce((n,r)=>{const v=parseInt(String(r[7]||'').replace(/,/g,''))||0;return n+v;},0)/data.length):0;
const emptyN=data.filter(r=>r[statusIdx]==='ê³µì‹¤').length;
xml+=`<Row ss:Height="30"><Cell ss:StyleID="sum" ss:MergeAcross="6"><Data ss:Type="String">í•©ê³„: ${data.length}ê±´  |  ê³µì‹¤ ${emptyN}ê±´</Data></Cell><Cell ss:StyleID="sumR"><Data ss:Type="Number">${avgD}</Data></Cell><Cell ss:StyleID="sum"><Data ss:Type="String">í‰ê· </Data></Cell><Cell ss:StyleID="sumR"><Data ss:Type="Number">${avgR}</Data></Cell></Row>\n`;
xml+='</Table>\n<WorksheetOptions xmlns="urn:schemas-microsoft-com:office:excel"><FreezePanes/><FrozenNoSplit/><SplitHorizontal>3</SplitHorizontal><TopRowBottomPane>3</TopRowBottomPane></WorksheetOptions>\n</Worksheet></Workbook>';
const fname=filtered?`ì í¬DB_í•„í„°${list.length}ê±´_${today()}.xls`:`ì í¬DB_ì „ì²´${list.length}ê±´_${today()}.xls`;
const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([xml],{type:'application/vnd.ms-excel;charset=utf-8'}));a.download=fname;a.click();
}

// â•â•â• SETTINGS â•â•â•
function renderSettings(el){el.innerHTML=`<div style="font-size:18px;font-weight:900;margin-bottom:14px">âš™ï¸ ì„¤ì •</div>
<div class="kpi"><div class="kpi-card"><div class="kpi-v">${D.customers.length}</div><div class="kpi-l">ğŸ‘¥ ê³ ê°</div></div><div class="kpi-card"><div class="kpi-v">${D.stores.length}</div><div class="kpi-l">ğŸª ì í¬</div></div><div class="kpi-card"><div class="kpi-v">${D.brands.length}</div><div class="kpi-l">ğŸ· ë¸Œëœë“œ</div></div></div>
<div class="c"><div class="c-h" style="color:var(--c)">ğŸ’¾ ë°ì´í„°</div><div class="c-b">
<button class="btn bp bf mb8" onclick="exportAll()">ğŸ“¥ ì „ì²´ ë°±ì—…</button>
<button class="btn bo bf mb8" onclick="exportCustomers()">ğŸ“± ê³ ê° DB ì—‘ì…€</button>
<button class="btn bo bf mb8" onclick="exportStores()">ğŸ“± ì í¬ DB ì—‘ì…€</button>
<button class="btn bo bf mb8" onclick="exportPhones('brand')">ğŸ“± ë¸Œëœë“œ ì—°ë½ì²˜</button>
<button class="btn bg bf mb8" onclick="$('fi').click()">ğŸ“¤ ë¶ˆëŸ¬ì˜¤ê¸°</button>
<input type="file" id="fi" accept=".json" onchange="importAll(event)" style="display:none">
<button class="btn bd bf mt12" onclick="resetAll()">ğŸ—‘ ì´ˆê¸°í™”</button>
<div style="font-size:10px;color:#ccc;margin-top:14px;line-height:1.8">â€» ìë™ì €ì¥ (localStorage) Â· ì •ê¸° ë°±ì—… ê¶Œì¥<br>â€» ì‚¬ì§„ ë§ìœ¼ë©´ ìš©ëŸ‰ ì£¼ì˜ (~5MB)</div>
</div></div>
<div class="c mt12"><div class="c-h" style="color:#1565C0">ğŸ”— êµ¬ê¸€ ì—°ë™</div><div class="c-b">
<button class="btn bf mb8" onclick="window.open('https://drive.google.com/drive/my-drive','_blank')" style="background:#4285F4;color:#fff">ğŸ“¤ êµ¬ê¸€ ë“œë¼ì´ë¸Œ ì—´ê¸°</button>
<button class="btn bf mb8" onclick="window.open('https://sheets.google.com/create','_blank')" style="background:#0F9D58;color:#fff">ğŸ“Š êµ¬ê¸€ ì‹œíŠ¸ ìƒˆë¡œ ë§Œë“¤ê¸°</button>
</div></div>
<div class="c mt12"><div class="c-h" style="color:#E65100;background:#FFF3E0">ğŸ“© ì•Œë¦¬ê³  ë¬¸ì API</div><div class="c-b">
<div style="font-size:9px;color:#666;margin-bottom:8px;line-height:1.5"><a href="https://smartsms.aligo.in/admin/api/auth.html" target="_blank" style="color:var(--c);font-weight:700">ì•Œë¦¬ê³  API Key ë°œê¸‰</a> â†’ ì•„ë˜ ì…ë ¥ â†’ ê³ ê° ì„ íƒ í›„ ë°”ë¡œ ë°œì†¡</div>
<div class="row r2"><div><label class="lbl">API Key</label><input class="inp" value="${esc(D.aligoKey||'')}" onchange="D.aligoKey=this.value;save()" placeholder="API Key"></div><div><label class="lbl">ì‚¬ìš©ì ID</label><input class="inp" value="${esc(D.aligoId||'')}" onchange="D.aligoId=this.value;save()" placeholder="ë¡œê·¸ì¸ ID"></div></div>
<div class="row r2"><div><label class="lbl">ë°œì‹ ë²ˆí˜¸</label><input class="inp" value="${esc(D.aligoSender||'')}" onchange="D.aligoSender=this.value;save()" placeholder="01012345678"></div><div><label class="lbl">í…ŒìŠ¤íŠ¸</label><select class="inp" onchange="D.aligoTest=this.value;save()"><option value="Y"${(D.aligoTest||'Y')==='Y'?' selected':''}>Y (ë¬´ë£Œ)</option><option value="N"${D.aligoTest==='N'?' selected':''}>N (ì‹¤ë°œì†¡)</option></select></div></div>
${D.aligoKey&&D.aligoId&&D.aligoSender?'<div style="padding:6px;background:#E8F5E9;border-radius:8px;font-size:10px;color:#2E7D32;font-weight:700;margin-top:6px">âœ… ì„¤ì • ì™„ë£Œ</div>':'<div style="padding:6px;background:#FFF3E0;border-radius:8px;font-size:10px;color:#E65100;margin-top:6px">âš ï¸ 3í•­ëª© ëª¨ë‘ ì…ë ¥ í•„ìš”</div>'}
</div></div>
<div class="c mt12"><div class="c-h" style="color:#8E24AA">ğŸ¤– AI ë¶„ì„ ì—°ë™</div><div class="c-b">
<div style="font-size:11px;color:#666;margin-bottom:10px;line-height:1.6">ë¶„ì„ ìœ í˜• ì„ íƒ â†’ <b>í”„ë¡¬í”„íŠ¸ ìë™ ìƒì„±</b> â†’ AIì— <b>ë¶™ì—¬ë„£ê¸°</b></div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:12px">
<button class="btn btn-sm" onclick="copyAI('match')" style="background:#FF6F00;color:#fff;min-height:48px">ğŸ¯ ê³ ê°-ì í¬<br>ë§¤ì¹­</button>
<button class="btn btn-sm" onclick="copyAI('insight')" style="background:#6A1B9A;color:#fff;min-height:48px">ğŸ“Š ì‹œì¥<br>ì¸ì‚¬ì´íŠ¸</button>
<button class="btn btn-sm" onclick="copyAI('action')" style="background:#1B5E20;color:#fff;min-height:48px">âš¡ ì˜¤ëŠ˜<br>í• ì¼ ì¶”ì²œ</button>
<button class="btn btn-sm" onclick="copyAI('proposal')" style="background:#B71C1C;color:#fff;min-height:48px">ğŸ“ ì œì•ˆì„œ<br>ì´ˆì•ˆ</button>
</div>
<div style="border-top:1px solid #eee;padding-top:10px;font-size:11px;font-weight:800;color:#555;margin-bottom:8px">ğŸ‘‡ ë³µì‚¬ í›„ ë°”ë¡œ ì—´ê¸°</div>
<button class="btn bf mb8" onclick="copyAI(window._lastAI||'match');setTimeout(()=>window.open('https://claude.ai/new','_blank'),300)" style="background:#D97706;color:#fff">ğŸŸ  Claudeì— ë¶„ì„ ìš”ì²­</button>
<button class="btn bf mb8" onclick="copyAI(window._lastAI||'match');setTimeout(()=>window.open('https://gemini.google.com/','_blank'),300)" style="background:#1A73E8;color:#fff">ğŸ”µ Geminiì— ë¶„ì„ ìš”ì²­</button>
<div style="font-size:10px;color:#aaa;margin-top:12px;line-height:1.8">
ğŸ’¡ ë§¤ì¹­ â†’ ì˜ˆì‚°/ì§€ì—­/ì—…ì¢… ê¸°ì¤€ ìë™ ë§¤ì¹­<br>
ğŸ’¡ ì¸ì‚¬ì´íŠ¸ â†’ ê°€ê²© ë¶„í¬, ìˆ˜ìš”-ê³µê¸‰ ê°­<br>
ğŸ’¡ í• ì¼ â†’ íŒ”ë¡œì—… ìš°ì„ ìˆœìœ„ + ì „í™” ìŠ¤í¬ë¦½íŠ¸<br>
ğŸ’¡ ì œì•ˆì„œ â†’ VIP ë§ì¶¤ ì œì•ˆì„œ + ROI ì‹œë®¬
</div>
</div></div>`;}
function genDBSummary(){
const td2=today();
const vipC=D.customers.filter(c=>c.grade==='VIP').length;
const activeC=D.customers.filter(c=>['ìƒë‹´ì¤‘','ê³„ì•½ì§„í–‰'].includes(c.status)).length;
const doneC=D.customers.filter(c=>c.status==='ê³„ì•½ì™„ë£Œ').length;
const emptyS=D.stores.filter(s=>(s.status||'ê³µì‹¤')==='ê³µì‹¤').length;
const aGrade=D.stores.filter(s=>s.grade==='Aê¸‰').length;
const avgRent=D.stores.length?Math.round(D.stores.reduce((n,s)=>n+numVal(s.rent),0)/D.stores.length):0;
const regions=[...new Set(D.stores.map(s=>s.district||'').filter(Boolean))];
const bizTypes=[...new Set(D.customers.map(c=>c.bizType||'').filter(Boolean))];
let txt=`[DB í˜„í™© ìš”ì•½ - ${td2}]\n\n`;
txt+=`â–  ê³ ê° ${D.customers.length}ëª… (VIP ${vipC} / ìƒë‹´ì¤‘ ${activeC} / ê³„ì•½ì™„ë£Œ ${doneC})\n`;
txt+=`â–  ì í¬ ${D.stores.length}ê°œ (ê³µì‹¤ ${emptyS} / Aê¸‰ ${aGrade} / í‰ê· ì„ëŒ€ ${fW(avgRent)}ì›)\n`;
txt+=`â–  ë¸Œëœë“œ ${D.brands.length}ê°œ\n`;
if(regions.length)txt+=`â–  ì í¬ ì§€ì—­: ${regions.join(', ')}\n`;
if(bizTypes.length)txt+=`â–  í¬ë§ì—…ì¢…: ${bizTypes.join(', ')}\n`;
txt+=`\n[ê³ ê° ëª©ë¡]\n`;
D.customers.forEach((c,i)=>{txt+=`${i+1}. ${c.name||'ë¯¸ì…ë ¥'} | ${c.grade} | ${c.status||'ì‹ ê·œ'} | ì§€ì—­:${c.region||'-'} | ì˜ˆì‚°:${c.budget||'-'} | ì—…ì¢…:${c.bizType||'-'} | í‰ìˆ˜:${c.wantArea||'-'} | ê´€ì‹¬:${c.interests||'-'}${c.followUp?' | íŒ”ë¡œì—…:'+c.followUp:''}\n`;});
txt+=`\n[ì í¬ ëª©ë¡]\n`;
D.stores.forEach((s,i)=>{const myR=numVal(s.rent);const mkR=numVal(s.marketRent);const diff=myR&&mkR?myR-mkR:0;const diffTxt=diff?(diff>0?'ì‹œì„¸ëŒ€ë¹„+'+fW(diff):'ì‹œì„¸ëŒ€ë¹„'+fW(diff)):'';txt+=`${i+1}. ${s.name||'ë¯¸ì…ë ¥'} | ${s.address||'-'} | ${s.district||'-'} | ${s.floor||'-'} ${s.area||'-'}í‰ | ì„ëŒ€${fW(s.rent)} ë³´ì¦${fW(s.deposit)} ê¶Œë¦¬${fW(s.premium)} ê´€ë¦¬${fW(s.maintenance)} | ì›”ì´${fW(numVal(s.rent)+numVal(s.maintenance))} | ${s.grade} ${s.status||'ê³µì‹¤'}${diffTxt?' | '+diffTxt:''}${s.followUp?' | íŒ”ë¡œì—…:'+s.followUp:''}\n`;});
if(D.brands.length){txt+=`\n[ë¸Œëœë“œ ëª©ë¡]\n`;
D.brands.forEach((b,i)=>{txt+=`${i+1}. ${b.brandName||'ë¯¸ì…ë ¥'} | íšŒì‚¬:${b.companyName||'-'} | ë‹´ë‹¹:${b.contactName||'-'} ${b.position||''} | ${b.phone||'-'}\n`;});}
return txt;}
function genAIPrompt(type){
const td2=today();const data=genDBSummary();
if(type==='match')return`ë‹¹ì‹ ì€ í”„ëœì°¨ì´ì¦ˆ ì í¬ ê°œë°œ ì „ë¬¸ ì»¨ì„¤í„´íŠ¸ì…ë‹ˆë‹¤.\n\n${data}\n\nìœ„ ê³ ê° DBì™€ ì í¬ DBë¥¼ êµì°¨ ë¶„ì„í•´ì„œ:\n1. ê° ê³ ê°ì—ê²Œ ê°€ì¥ ì í•©í•œ ì í¬ë¥¼ 1~3ê°œì”© ë§¤ì¹­ (ì˜ˆì‚°, ì§€ì—­, ì—…ì¢…, í‰ìˆ˜, ì¸µìˆ˜ ê¸°ì¤€)\n2. ë§¤ì¹­ ì´ìœ ë¥¼ ê³ ê°ë³„ë¡œ êµ¬ì²´ì ìœ¼ë¡œ ì„¤ëª…\n3. ì¦‰ì‹œ ì—°ë½í•´ì•¼ í•  ìš°ì„ ìˆœìœ„ TOP 3 ê³ ê°ê³¼ ì¶”ì²œ ì „í™” ë©˜íŠ¸\n4. ë§¤ì¹­ì´ ì•ˆ ë˜ëŠ” ê³ ê° â†’ ì–´ë–¤ ë§¤ë¬¼ì„ í™•ë³´í•´ì•¼ í•˜ëŠ”ì§€\n5. ë¸Œëœë“œ DBì™€ ì—°ê²°í•˜ì—¬ ì¶”ì²œ ê°€ëŠ¥í•œ í”„ëœì°¨ì´ì¦ˆ ì¡°í•©\n\ní‘œ í˜•ì‹ìœ¼ë¡œ ì •ë¦¬í•´ì£¼ì„¸ìš”.`;
if(type==='insight')return`ë‹¹ì‹ ì€ ìƒì—…ìš© ë¶€ë™ì‚° ì‹œì¥ ë¶„ì„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.\n\n${data}\n\nìœ„ DBë¥¼ ê¸°ë°˜ìœ¼ë¡œ:\n1. ì§€ì—­ë³„ ì„ëŒ€ë£Œ/ë³´ì¦ê¸ˆ/ê¶Œë¦¬ê¸ˆ ê°€ê²© ë¶„í¬ ë¶„ì„\n2. ê³µì‹¤ ë§¤ë¬¼ ì¤‘ ê°€ì„±ë¹„ TOP 3 (íˆ¬ì ëŒ€ë¹„ ìˆ˜ìµì„±)\n3. ê³ ê° ìˆ˜ìš” íŠ¸ë Œë“œ (ì—…ì¢…, ì˜ˆì‚°, ì§€ì—­ ì„ í˜¸ë„)\n4. ê³µê¸‰-ìˆ˜ìš” ê°­ ë¶„ì„: ê³ ê°ì€ ì›í•˜ëŠ”ë° ë§¤ë¬¼ì´ ì—†ëŠ” ì˜ì—­\n5. ë¸Œëœë“œë³„ ì í•© ë§¤ë¬¼ ë¶„ì„\n6. í–¥í›„ í™•ë³´í•´ì•¼ í•  ë§¤ë¬¼ ìœ í˜• ì œì•ˆ\n\nêµ¬ì²´ì  ìˆ˜ì¹˜ì™€ í•¨ê»˜ ë¶„ì„í•´ì£¼ì„¸ìš”.`;
if(type==='action')return`ë‹¹ì‹ ì€ í”„ëœì°¨ì´ì¦ˆ ì˜ì—… ê´€ë¦¬ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì˜¤ëŠ˜ì€ ${td2}ì…ë‹ˆë‹¤.\n\n${data}\n\nì˜¤ëŠ˜ ì¦‰ì‹œ ì‹¤í–‰í•  ì•¡ì…˜ í”Œëœ:\n1. ê¸´ê¸‰ íŒ”ë¡œì—… ëŒ€ìƒ (VIP + ìƒë‹´ì¤‘ + íŒ”ë¡œì—… ë‚ ì§œ ë„ë˜ ê³ ê°)\n2. ê° ê³ ê°ë³„ ì „í™” ì˜¤í”„ë‹ ë©˜íŠ¸ (ìƒí™©ì— ë§ì¶˜ ë§ì¶¤ ìŠ¤í¬ë¦½íŠ¸)\n3. í˜„ì¥ ë°©ë¬¸í•  ì í¬ ë£¨íŠ¸ ì¶”ì²œ (ì§€ì—­ë³„ ë¬¶ì–´ì„œ)\n4. ì´ë²ˆ ì£¼ ê³„ì•½ ê°€ëŠ¥ì„± ë†’ì€ ë”œ TOP 3\n5. ì´íƒˆ ìœ„í—˜ ê³ ê° êµ¬ì œ ì „ëµ\n6. ë¸Œëœë“œ ë³¸ì‚¬ ë¯¸íŒ… í•„ìš” ê±´\n\nì‹œê°„ ìˆœì„œ íƒ€ì„ë¼ì¸ìœ¼ë¡œ ì •ë¦¬í•´ì£¼ì„¸ìš”.`;
if(type==='proposal')return`ë‹¹ì‹ ì€ í”„ëœì°¨ì´ì¦ˆ ì í¬ ì œì•ˆì„œ ì‘ì„± ì „ë¬¸ê°€ì…ë‹ˆë‹¤.\n\n${data}\n\nVIP ë° ê³„ì•½ì§„í–‰ ê³ ê° ê°ê°ì— ëŒ€í•´:\n1. ë§ì¶¤í˜• ì í¬ ì¶”ì²œ ì œì•ˆì„œ (ê³ ê°ëª…, ì¶”ì²œ ì í¬, ì¶”ì²œ ì´ìœ )\n2. ì˜ˆìƒ ì›” ìˆ˜ìµ/ë¹„ìš© ì‹œë®¬ë ˆì´ì…˜ (ì„ëŒ€+ê´€ë¦¬ë¹„+ì¸ê±´ë¹„+ì¬ë£Œë¹„)\n3. í•´ë‹¹ ì§€ì—­ ê²½ìŸ ë¶„ì„\n4. íˆ¬ì íšŒìˆ˜ ê¸°ê°„ ì˜ˆì¸¡\n5. ì í•©í•œ ë¸Œëœë“œ ì¶”ì²œê³¼ ì´ìœ \n6. ê³„ì•½ ì²´ê²° í´ë¡œì§• í¬ì¸íŠ¸\n\nê³ ê°ë³„ë¡œ ë¶„ë¦¬í•´ì„œ ì‹¤ì œ ì „ë‹¬ ê°€ëŠ¥ ìˆ˜ì¤€ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.`;
return data;}
function copyAI(type){window._lastAI=type;const txt=genAIPrompt(type);navigator.clipboard.writeText(txt).then(()=>{const names={match:'ğŸ¯ ê³ ê°-ì í¬ ë§¤ì¹­',insight:'ğŸ“Š ì‹œì¥ ì¸ì‚¬ì´íŠ¸',action:'âš¡ ì˜¤ëŠ˜ í• ì¼',proposal:'ğŸ“ ì œì•ˆì„œ ì´ˆì•ˆ'};alert('âœ… '+names[type]+' í”„ë¡¬í”„íŠ¸ ë³µì‚¬!\n\nAIì— ë¶™ì—¬ë„£ê¸°');}).catch(()=>{prompt('ë³µì‚¬:',txt);});}
function sendOneSMS(cid){const c=D.customers.find(x=>x.id===cid);if(!c||!c.phone)return alert('ì—°ë½ì²˜ ì—†ìŒ');
D.selCust={};D.selCust[cid]=true;window._custList=[c];openSMS();}
function addCat(type){const name=prompt('ìƒˆ ì¹´í…Œê³ ë¦¬ëª… ì…ë ¥');if(!name||!name.trim())return;
if(type==='cust'){if(!D.custCats)D.custCats=[];if(!D.custCats.includes(name.trim()))D.custCats.push(name.trim());}
else{if(!D.storeCats)D.storeCats=[];if(!D.storeCats.includes(name.trim()))D.storeCats.push(name.trim());}
save();R();}
function delCat(type,cat){if(!confirm('"'+cat+'" ì‚­ì œ?'))return;
if(type==='cust'){D.custCats=(D.custCats||[]).filter(c=>c!==cat);D.customers.forEach(c=>{if(c.dbCat===cat)c.dbCat='';});}
else{D.storeCats=(D.storeCats||[]).filter(c=>c!==cat);D.stores.forEach(s=>{if(s.dbCat===cat)s.dbCat='';});}
save();R();}
function toggleSelCust(id){if(!D.selCust)D.selCust={};D.selCust[id]=!D.selCust[id];R();}
function toggleAllCust(on){if(!D.selCust)D.selCust={};(window._custList||[]).forEach(c=>{D.selCust[c.id]=!!on;});R();}
function getSelCusts(){return(window._custList||D.customers).filter(c=>D.selCust&&D.selCust[c.id]&&c.phone);}
function exportSelCust(){const sel=getSelCusts();if(!sel.length)return alert('ì—°ë½ì²˜ ìˆëŠ” ì„ íƒ ê³ ê°ì´ ì—†ìŠµë‹ˆë‹¤');exportCustomers(sel);}
function exportSelCSV(){const sel=getSelCusts();if(!sel.length)return alert('ì—°ë½ì²˜ ìˆëŠ” ì„ íƒ ê³ ê°ì´ ì—†ìŠµë‹ˆë‹¤');
const rows=[['ìˆ˜ì‹ ë²ˆí˜¸','ì´ë¦„'].join(','),...sel.map(c=>[c.phone.replace(/-/g,''),c.name||''].join(','))];
const csv='\uFEFF'+rows.join('\n');const a=document.createElement('a');
a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8'}));
a.download=`ë¬¸ìë°œì†¡_${sel.length}ëª…_${today()}.csv`;a.click();}
function openSMS(){const sel=getSelCusts();if(!sel.length)return alert('ì—°ë½ì²˜ ìˆëŠ” ì„ íƒ ê³ ê°ì´ ì—†ìŠµë‹ˆë‹¤');
const tpls=[
{name:'ì‹ ê·œë§¤ë¬¼',msg:'ì•ˆë…•í•˜ì„¸ìš”, [ì´ë¦„]ë‹˜! ğŸ˜Š\n\nê´€ì‹¬ ê°€ì§€ì‹¤ë§Œí•œ ìƒˆë¡œìš´ ë§¤ë¬¼ì´ ë‚˜ì™”ìŠµë‹ˆë‹¤.\n\nğŸ“ ìœ„ì¹˜: \nğŸ’° ì„ëŒ€ë£Œ: \nğŸ“ í‰ìˆ˜: \n\nìì„¸í•œ ë‚´ìš©ì€ ì—°ë½ ì£¼ì‹œë©´ ì•ˆë‚´ë“œë¦¬ê² ìŠµë‹ˆë‹¤.\n\nê°ì‚¬í•©ë‹ˆë‹¤ ğŸ™'},
{name:'íŒ”ë¡œì—…',msg:'ì•ˆë…•í•˜ì„¸ìš”, [ì´ë¦„]ë‹˜!\n\nì§€ë‚œë²ˆ ìƒë‹´ ì´í›„ ê²°ì •í•˜ì‹  ë¶€ë¶„ì´ ìˆìœ¼ì‹¤ê¹Œìš”?\nì¶”ê°€ ê¶ê¸ˆí•œ ì  ìˆìœ¼ì‹œë©´ í¸í•˜ê²Œ ì—°ë½ ì£¼ì„¸ìš”.\n\nì¢‹ì€ í•˜ë£¨ ë˜ì„¸ìš”! ğŸ˜Š'},
{name:'í”„ë¡œëª¨ì…˜',msg:'ì•ˆë…•í•˜ì„¸ìš”, [ì´ë¦„]ë‹˜!\n\nì§€ê¸ˆ íŠ¹ë³„ í”„ë¡œëª¨ì…˜ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤.\n\nğŸ‰ í˜œíƒ: \nğŸ“… ê¸°ê°„: \n\nê´€ì‹¬ ìˆìœ¼ì‹œë©´ ì—°ë½ ì£¼ì„¸ìš”!'},
{name:'ì§ì ‘ì…ë ¥',msg:''}];
$('modal').innerHTML=`<div class="modal-overlay" onclick="$('modal').innerHTML=''"><div class="modal-box" style="max-width:95vw;max-height:90vh;overflow-y:auto" onclick="event.stopPropagation()">
<div style="font-size:16px;font-weight:900;margin-bottom:10px">ğŸ“© ë¬¸ì ë³´ë‚´ê¸° <span style="font-size:12px;color:var(--sub)">${sel.length}ëª…</span></div>
<div style="font-size:10px;color:#666;margin-bottom:10px">ìˆ˜ì‹ : ${sel.slice(0,3).map(c=>c.name||c.phone).join(', ')}${sel.length>3?' ì™¸ '+(sel.length-3)+'ëª…':''}</div>
<div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px">${tpls.map((t,i)=>`<div class="sms-tpl" onclick="setSMSTpl(${i})">${t.name}</div>`).join('')}</div>
<textarea class="inp ta" id="smsTxt" style="min-height:130px;font-size:13px;line-height:1.6">${esc(tpls[0].msg)}</textarea>
<div style="font-size:9px;color:#999;margin:4px 0">[ì´ë¦„] â†’ ê³ ê°ëª… ìë™ ì¹˜í™˜</div>
<div style="display:flex;gap:6px;margin-top:10px;flex-wrap:wrap">
${D.aligoKey&&D.aligoId&&D.aligoSender?`<button class="btn" style="flex:1;background:#E65100;color:#fff;font-weight:800" onclick="sendAligo()">ğŸ“© ì•Œë¦¬ê³  (${D.aligoTest==='N'?'ì‹¤ë°œì†¡':'í…ŒìŠ¤íŠ¸'})</button>`:`<button class="btn bo" style="flex:1;opacity:.5" disabled>ğŸ“© ì„¤ì •í•„ìš”</button>`}
<button class="btn bo" style="flex:1" onclick="sendSMSNative()">ğŸ“± ë¬¸ìì•±</button>
<button class="btn bo" style="flex:1" onclick="copySMSAll()">ğŸ“‹ ë³µì‚¬</button>
</div>
<div style="margin-top:8px;padding:8px;background:#F5F5F5;border-radius:8px;font-size:9px;color:#666;line-height:1.5">
ğŸ’¡ <b>ì•Œë¦¬ê³ </b>: ë²„íŠ¼ í•œ ë°© ì¦‰ì‹œ ë°œì†¡ (ê±´ë‹¹ 8.4ì›)<br>
${!D.aligoKey?'âš ï¸ <b>ì„¤ì • â†’ ì•Œë¦¬ê³  ë¬¸ì API</b>ì—ì„œ Key ì…ë ¥':'âœ… API ì—°ê²°ë¨'}
</div>
</div></div>`;window._smsTpls=tpls;}
function setSMSTpl(i){const t=window._smsTpls[i];document.getElementById('smsTxt').value=t.msg;document.querySelectorAll('.sms-tpl').forEach((el,j)=>{el.classList.toggle('on',j===i);});}
function sendSMSNative(){const msg=document.getElementById('smsTxt')?.value||'';const sel=getSelCusts();
if(sel.length>10&&!confirm(sel.length+'ëª…ì—ê²Œ í•œ ëª…ì”© ë¬¸ìì•±ì´ ì—´ë¦½ë‹ˆë‹¤. ê³„ì†?'))return;
sel.forEach((c,i)=>{const txt=msg.replace(/\[ì´ë¦„\]/g,c.name||'ê³ ê°ë‹˜');const ph=c.phone.replace(/-/g,'');
setTimeout(()=>{window.open('sms:'+ph+'?body='+encodeURIComponent(txt),'_blank');},i*800);});
$('modal').innerHTML='';alert('âœ… ë¬¸ìì•± '+sel.length+'ê±´ ì—´ë¦¼');}
function copySMSAll(){const msg=document.getElementById('smsTxt')?.value||'';const sel=getSelCusts();
let txt='ğŸ“© ë¬¸ì ë°œì†¡ ('+sel.length+'ëª…)\në©”ì‹œì§€:\n'+msg+'\n\nìˆ˜ì‹ ì:\n';
sel.forEach((c,i)=>{txt+=(i+1)+'. '+c.name+' '+c.phone+'\n';});
navigator.clipboard.writeText(txt).then(()=>alert('âœ… ë³µì‚¬ ì™„ë£Œ!')).catch(()=>prompt('ë³µì‚¬:',txt));}
async function sendAligo(){const msg=document.getElementById('smsTxt')?.value||'';const sel=getSelCusts();
if(!msg)return alert('ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
if(!D.aligoKey||!D.aligoId||!D.aligoSender)return alert('âš ï¸ ì„¤ì •íƒ­ì—ì„œ ì•Œë¦¬ê³  API Key/ID/ë°œì‹ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
const mode=D.aligoTest!=='N';
if(!mode&&!confirm('âš ï¸ ì‹¤ì œ ë°œì†¡!\n'+sel.length+'ëª…ì—ê²Œ ë¬¸ì ë°œì†¡ë©ë‹ˆë‹¤.\n\në°œì†¡?'))return;
const btn=document.querySelector('[onclick="sendAligo()"]');if(btn){btn.disabled=true;btn.textContent='â³ ë°œì†¡ì¤‘...';}
try{
const body=new URLSearchParams();body.append('key',D.aligoKey);body.append('user_id',D.aligoId);body.append('sender',D.aligoSender.replace(/-/g,''));
body.append('testmode_yn',mode?'Y':'N');
if(sel.length===1){
body.append('receiver',sel[0].phone.replace(/-/g,''));
body.append('msg',msg.replace(/\[ì´ë¦„\]/g,sel[0].name||'ê³ ê°ë‹˜'));
if(msg.length>45)body.append('msg_type','LMS');
const r=await fetch('https://apis.aligo.in/send/',{method:'POST',body});const d=await r.json();
if(d.result_code>0){$('modal').innerHTML='';alert('âœ… ì„±ê³µ! '+d.success_cnt+'ê±´'+(mode?' (í…ŒìŠ¤íŠ¸)':''));}
else alert('âŒ ì‹¤íŒ¨: '+d.message);
}else{
body.append('cnt',sel.length);const isLong=msg.length>45;body.append('msg_type',isLong?'LMS':'SMS');
if(isLong)body.append('title','ì•ˆë‚´ë¬¸ì');
sel.forEach((c,i)=>{body.append('rec_'+(i+1),c.phone.replace(/-/g,''));body.append('msg_'+(i+1),msg.replace(/\[ì´ë¦„\]/g,c.name||'ê³ ê°ë‹˜'));});
const r=await fetch('https://apis.aligo.in/send_mass/',{method:'POST',body});const d=await r.json();
if(d.result_code>0){$('modal').innerHTML='';alert('âœ… ëŒ€ëŸ‰ ë°œì†¡ ì„±ê³µ! '+d.success_cnt+'ê±´'+(mode?' (í…ŒìŠ¤íŠ¸)':''));}
else alert('âŒ ì‹¤íŒ¨: '+d.message);
}
}catch(e){alert('âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: '+e.message);}
finally{if(btn){btn.disabled=false;btn.textContent='ğŸ“© ì•Œë¦¬ê³  ('+(mode?'í…ŒìŠ¤íŠ¸':'ì‹¤ë°œì†¡')+')';}}}

function exportAll(){const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([JSON.stringify({customers:D.customers,stores:D.stores,brands:D.brands},null,2)],{type:'application/json'}));a.download=`DBë°±ì—…_${today()}.json`;a.click();}
function importAll(e){const f=e.target.files?.[0];if(!f)return;const r=new FileReader();r.onload=ev=>{try{const d=JSON.parse(ev.target.result);D.customers=d.customers||[];D.stores=d.stores||[];D.brands=d.brands||[];R();alert('âœ… ì™„ë£Œ!');}catch{alert('ì˜¤ë¥˜');}};r.readAsText(f);e.target.value='';}
function resetAll(){if(!confirm('âš ï¸ ì „ì²´ ì‚­ì œ?'))return;if(!confirm('ì •ë§?'))return;D.customers=[];D.stores=[];D.brands=[];D.smartHistory=[];D.editId=null;R();}

function fabAction(){if(D.editId){$('main').scrollTop=0;return;}if(D.tab==='cust')addCust();else if(D.tab==='store')addStore();else if(D.tab==='brand')addBrand();else if(D.tab==='smart')runSmart();}

R();
</script>
</body>
</html>
